<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Roblox MAX! OX Quiz - Real-time Problem Setting & Management</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Bangers&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <style>
        /* ---------------------- 1. Roblox Global Style (ê¸€ê¼´ ê°œì„ ) ---------------------- */
        body { 
            font-family: 'Bangers', cursive; /* ë³¸ë¬¸ ê¸€ê¼´ */
            margin: 0; 
            padding: 20px; 
            /* ë¡œë¸”ë¡ìŠ¤ ì”ë”” ë¸”ë¡ ëŠë‚Œ ë°°ê²½ */
            background-color: #64dd17; 
            background-image: 
                linear-gradient(45deg, rgba(0,0,0,0.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.1) 75%, rgba(0,0,0,0.1)),
                linear-gradient(45deg, rgba(0,0,0,0.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.1) 75%, rgba(0,0,0,0.1));
            background-size: 50px 50px; 
            background-position: 0 0, 25px 25px; 
            color: #212121; 
        }
        #app { 
            max-width: 1000px; /* ë„ˆë¹„ í™•ì¥ */
            margin: 20px auto; 
            padding: 40px; 
            background: #ffffff; 
            border: 8px solid #303030; 
            border-radius: 15px; 
            box-shadow: 15px 15px 0px #303030; 
            position: relative;
            z-index: 10;
        }
        h2, h3, h4 { 
            font-family: 'Press Start 2P', cursive; /* í—¤ë“œë¼ì¸ ê¸€ê¼´ */
            color: #000000; 
            text-align: center;
            text-shadow: 3px 3px 0px #ffea00; 
            margin-bottom: 25px;
        }
        h2 { font-size: 2.5em; }
        h3 { font-size: 2em; }
        h4 { font-size: 1.5em; }

        /* ---------------------- 2. Block Button Style (ë™ì¼) ---------------------- */
        button, .block-button { 
            font-family: 'Press Start 2P', cursive;
            padding: 18px 30px; 
            margin: 10px; 
            border: 5px solid #000000; 
            border-radius: 8px; 
            font-size: 1.2em; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 6px 6px 0px #000000; 
            transition: all 0.1s;
            text-shadow: 2px 2px 0 #000;
            color: white;
            background-color: #3498db; 
            letter-spacing: 1px;
        }
        button:active, .block-button:active {
            box-shadow: 2px 2px 0px #000000;
            transform: translate(4px, 4px); 
        }
        .green-button { background-color: #2ecc71; } 
        .red-button { background-color: #e74c3c; } 
        .yellow-button { background-color: #f1c40f; color: #000; text-shadow: none; } 

        /* ---------------------- 3. Layout and Elements (ì‹œê°í™” ìˆ˜ì •) ---------------------- */
        .hidden { display: none !important; }
        .centered { text-align: center; }
        input, select, label { font-family: 'Bangers', cursive; }
        label { font-family: 'Press Start 2P', cursive; }

        /* ì…ë ¥ í•„ë“œ í™•ì¥ (NEW!) */
        textarea#question-input {
            width: 80%;
            max-width: 450px;
            height: 100px; /* ë†’ì´ í™•ì¥ */
            padding: 12px; 
            margin: 10px auto; 
            border: 3px solid #000000; 
            border-radius: 8px; 
            box-shadow: 4px 4px 0px #000000; 
            font-size: 1.1em; 
            display: block;
            background-color: #fefefe;
            color: #212121;
            resize: vertical;
            box-sizing: border-box; /* íŒ¨ë”©ì´ ë„ˆë¹„ì— í¬í•¨ë˜ë„ë¡ */
        }
        
        /* ë¬¸ì œ ëª©ë¡ ìŠ¤íƒ€ì¼ */
        #problem-list-container {
            max-height: 300px;
            overflow-y: auto;
            border: 3px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            text-align: left;
        }
        .problem-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            border-bottom: 1px dashed #ddd;
            font-family: 'Bangers', cursive;
        }
        .problem-item:last-child {
            border-bottom: none;
        }
        .problem-text {
            flex-grow: 1;
            font-size: 1.1em;
            color: #333;
        }
        .delete-btn {
            background-color: #f44336;
            color: white;
            border: 2px solid #000;
            padding: 5px 10px;
            font-size: 0.8em;
            cursor: pointer;
            box-shadow: 3px 3px 0px #000;
            margin: 0;
        }
        .delete-btn:active {
            box-shadow: 1px 1px 0px #000;
            transform: translate(2px, 2px); 
        }

        /* í€´ì¦ˆ í•„ë“œ ì»¨í…Œì´ë„ˆ ë° ì•„ë°”íƒ€ ìŠ¤íƒ€ì¼ì€ ì´ì „ ë²„ì „ê³¼ ë™ì¼ */
        .quiz-field-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
        }
        #unanswered-area, #unanswered-area-spectator {
            width: 95%; 
            min-height: 80px;
            background-color: #f39c12; 
            border: 4px solid #000;
            border-radius: 10px;
            margin-bottom: 20px;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-content: center;
            justify-content: center;
            box-shadow: 6px 6px 0px #000;
        }
        .result-box { 
            display: flex; 
            justify-content: space-between; 
            width: 95%; 
            margin-top: 0; 
        }
        .o-area, .x-area { 
            flex-basis: 49%; 
            padding: 15px; 
            border: 6px solid #000; 
            border-radius: 12px; 
            min-height: 250px; 
            box-shadow: 8px 8px 0px #000;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 10px; 
        }
        .o-area { background-color: #4CAF50; } 
        .x-area { background-color: #F44336; } 
        .student-avatar { 
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); 
            background: #ffffff; 
            font-family: 'Bangers', cursive;
            display: inline-block; 
            margin: 5px; 
            padding: 10px 15px; 
            border-radius: 0%; 
            font-size: 1.2em; 
            font-weight: bold;
            border: 3px solid #000;
            box-shadow: 3px 3px 0px #000;
            white-space: nowrap;
            cursor: help; 
        }
        .count-badge { font-family: 'Press Start 2P', cursive; font-size: 2em; }
    </style>
</head>
<body>

<div id="app">
    <div id="initial-screen" class="centered">
        <h2>ğŸš€ Roblox í€´ì¦ˆ ìŠ¤íƒ€íŠ¸! ğŸš€</h2>
        <button class="block-button yellow-button" onclick="showTeacherLogin()">ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ìœ¼ë¡œ ì ‘ì†</button>
        <button class="block-button yellow-button" onclick="showStudentLogin()">ğŸ‘§ğŸ‘¦ í•™ìƒìœ¼ë¡œ ì ‘ì†</button>
        <p style="font-family: sans-serif; font-size: 0.8em; color: gray;">
            (Firebaseë¥¼ í†µí•´ ì‹¤ì‹œê°„ ë™ê¸°í™”ë©ë‹ˆë‹¤.)
        </p>
    </div>
    
    <div id="teacher-login-screen" class="hidden centered">
        <h3>ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h3>
        <input type="password" id="teacher-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
        <button class="block-button yellow-button" onclick="teacherLogin()">ë¡œê·¸ì¸</button>
    </div>

    <div id="teacher-view" class="hidden">
        <h3>ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ ê´€ë¦¬ ë¸”ë¡ (ë¬¸ì œ #<span id="question-index">0</span>)</h3>
        <button class="block-button red-button" onclick="resetGameData()" style="margin-bottom: 20px;">
            ğŸ”„ ë°ì´í„° ì´ˆê¸°í™” (ì „ì²´ ì‚­ì œ)
        </button>
        
        <div id="teacher-preparation" class="centered">
            
            <label for="question-input">ë¬¸ì œ ì…ë ¥ ë° ì¶”ê°€ (ì…ë ¥ ì¹¸ í™•ì¥!):</label>
            <textarea id="question-input" placeholder="ğŸ’¡ O/X í€´ì¦ˆ ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            
            <label for="correct-answer">ì •ë‹µ ì„¤ì •:</label>
            <select id="correct-answer">
                <option value="O">O</option>
                <option value="X">X</option>
            </select>
            <label for="timer-select">ì œí•œ ì‹œê°„ (ì´ˆ):</label>
            <input type="number" id="timer-select" value="10" min="5" max="30" placeholder="ì œí•œ ì‹œê°„ (ì´ˆ)" style="width: 200px; display: inline-block;">
            
            <button class="block-button green-button" onclick="addQuestionToPool()" style="margin-top: 5px;">
                â• ë¬¸ì œ ëª©ë¡ì— ì¶”ê°€
            </button>
            <hr>

            <h4>ğŸ“‹ í˜„ì¬ ì…‹íŒ…ëœ ë¬¸ì œ ëª©ë¡ (<span id="problem-count">0</span>ê°œ)</h4>
            <div id="problem-list-container">
                </div>
            <hr>

            <label for="combo-life-threshold">ì¶”ê°€ ëª©ìˆ¨ íšë“ ì½¤ë³´ íšŸìˆ˜:</label>
            <input type="number" id="combo-life-threshold" value="5" min="2" max="10" placeholder="ì½¤ë³´ íšŸìˆ˜ (ê¸°ë³¸ 5)">

            <button class="block-button yellow-button" onclick="startGameWithPool()" style="margin-top: 20px;">
                â–¶ï¸ ì…‹íŒ…ëœ ë¬¸ì œë¡œ ê²Œì„ ì‹œì‘ ë° í•™ìƒë“¤ì—ê²Œ ë°°í¬!
            </button>
            
        </div>

        <div id="teacher-live-quiz" class="hidden">
            <h4>ğŸš¨ LIVE í€´ì¦ˆ: <span id="current-question"></span></h4>
            <div id="timer-display">TIME: <span id="timer-value">10</span></div>
            
            <div class="quiz-field-container">
                <div id="unanswered-area" class="unanswered-area">
                    <span style="font-family: 'Press Start 2P', cursive; font-size: 1.2em; color: #303030;">[ìš´ë™ì¥ ë°–] ì•„ì§ ë‹µë³€í•˜ì§€ ì•Šì€ ì•„ë°”íƒ€ê°€ ì—¬ê¸°ì— ìˆìŠµë‹ˆë‹¤.</span>
                </div>
                <div class="result-box">
                    <div class="o-area">
                        <div class="count-badge">O: <span id="o-count">0</span></div>
                        <div id="o-answers" class="answer-list"></div>
                    </div>
                    <div class="x-area">
                        <div class="count-badge">X: <span id="x-count">0</span></div>
                        <div id="x-answers" class="answer-list"></div>
                    </div>
                </div>
            </div>
            <button class="block-button red-button" onclick="endGame()">ğŸ’£ ê²Œì„ ê°•ì œ ì¢…ë£Œ (ìµœì¢… ìŠ¹ë¦¬ì ë°œí‘œ)</button>
        </div>
    </div>

    <div id="student-login" class="hidden centered">
        <h3>ğŸ‘¤ ì•„ë°”íƒ€ ì„¤ì • ë¸”ë¡</h3>
        <input type="text" id="student-nickname" placeholder="â­ ë‹‰ë„¤ì„ ì…ë ¥">
        <label for="emoji-select">ë™ë¬¼ ì´ëª¨ì§€ ì„ íƒ:</label>
        <select id="emoji-select">
            <option value="ğŸ¦">ğŸ¦ ì‚¬ì</option>
            <option value="ğŸ°">ğŸ° í† ë¼</option>
            <option value="ğŸ¶">ğŸ¶ ê°•ì•„ì§€</option>
            <option value="ğŸ»">ğŸ» ê³°</option>
            <option value="ğŸ¦Š">ğŸ¦Š ì—¬ìš°</option>
            <option value="ğŸ¼">ğŸ¼ íŒë‹¤</option>
            <option value="ğŸ¯">ğŸ¯ í˜¸ë‘ì´</option>
            <option value="ğŸ¨">ğŸ¨ ì½”ì•Œë¼</option>
            <option value="ğŸµ">ğŸµ ì›ìˆ­ì´</option>
            <option value="ğŸ¸">ğŸ¸ ê°œêµ¬ë¦¬</option>
            <option value="ğŸ§">ğŸ§ í­ê·„</option>
            <option value="ğŸ¦‰">ğŸ¦‰ ë¶€ì—‰ì´</option>
            <option value="ğŸ¦†">ğŸ¦† ì˜¤ë¦¬</option>
            <option value="ğŸ™">ğŸ™ ë¬¸ì–´</option>
            <option value="ğŸ¦€">ğŸ¦€ ê²Œ</option>
            <option value="ğŸ¢">ğŸ¢ ê±°ë¶ì´</option>
        </select>
        <button class="block-button yellow-button" onclick="loginStudent()">â–¶ï¸ í€´ì¦ˆë°© ì…ì¥</button>
    </div>

    <div id="student-view" class="hidden">
        <h3 id="student-info" class="centered"></h3>
        <p id="student-lives">â¤ï¸ ëª©ìˆ¨: 3</p>
        <div id="life-rule-info"></div>
        <div id="combo-indicator" class="combo-display hidden">
            ğŸ”¥ <span id="combo-count">0</span> COMBO!
        </div>

        <div id="student-waiting" class="quiz-state centered">
            <h4 class="red-button" style="background-color: #3498db; border-color: #2c3e50; display: inline-block;">
                ğŸ“¢ ì„ ìƒë‹˜ì´ ë¸”ë¡ì„ ì¡°ë¦½ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!
            </h4>
        </div>

        <div id="student-answering" class="quiz-state hidden centered">
            <h4 id="question-text" style="font-size: 1.8em; border-bottom: 5px solid #f39c12; padding-bottom: 10px;"></h4>
            <div id="student-timer-display">TIME: <span id="student-timer-value">10</span></div>
            <div class="answer-buttons">
                <button class="o-btn green-button" onclick="submitAnswer('O')">O</button>
                <button class="x-btn red-button" onclick="submitAnswer('X')">X</button>
            </div>
            
            <h4 style="margin-top: 30px; margin-bottom: 10px;">ğŸ‘€ ì‹¤ì‹œê°„ ë‹µë³€ í˜„í™©</h4>
            <div id="live-answer-spectator" class="quiz-field-container">
                <div id="unanswered-area-spectator" class="unanswered-area" style="background-color: #bbdefb;">
                     <span style="font-family: 'Press Start 2P', cursive; font-size: 1.2em; color: #303030;">[ëŒ€ê¸°] ì•„ì§ ë‹µë³€í•˜ì§€ ì•Šì€ ì•„ë°”íƒ€</span>
                </div>
                <div class="result-box">
                    <div class="o-area">
                        <div class="count-badge">O: <span class="o-count-spectator">0</span></div>
                        <div id="o-answers-spectator" class="answer-list"></div>
                    </div>
                    <div class="x-area">
                        <div class="count-badge">X: <span class="x-count-spectator">0</span></div>
                        <div id="x-answers-spectator" class="answer-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="student-result" class="quiz-state hidden centered">
            <div id="result-screen">
                <div class="result-emoji" id="result-emoji">âœ¨</div>
                <h4 id="result-message"></h4>
            </div>
        </div>
    </div>
</div>

<script>
    // ----------------------------------------------------------------------
    // ğŸ“¢ 1. Firebase ì„¤ì • (í•„ìˆ˜ ìˆ˜ì • ì˜ì—­) ğŸ“¢
    // ----------------------------------------------------------------------
    const firebaseConfig = {
  apiKey: "AIzaSyAoEYmlGb4tvWtYEQyBusIlyRDajD7-wtI",
  authDomain: "ox-quiz-ce39f.firebaseapp.com",
  databaseURL: "https://ox-quiz-ce39f-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "ox-quiz-ce39f",
  storageBucket: "ox-quiz-ce39f.firebasestorage.app",
  messagingSenderId: "509722567204",
  appId: "1:509722567204:web:728f6e3bd0851909d36eb1"
};

    // Firebase ì´ˆê¸°í™”
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const gameRef = database.ref('quizGame');
    const studentRef = database.ref('quizGame/students');
    const stateRef = database.ref('quizGame/state');
    const problemPoolRef = database.ref('quizGame/problemPool'); // ë¬¸ì œ ëª©ë¡ ê´€ë¦¬ DB ì°¸ì¡°
    
    // ----------------------------------------------------------------------
    // 2. ì „ì—­ ë³€ìˆ˜ ë° ìƒìˆ˜
    // ----------------------------------------------------------------------
    const TEACHER_PASSWORD = 'teacher1234';
    let currentUser = null; 
    let currentGameState = {}; 
    let studentList = []; 
    let problemPool = []; // ë¬¸ì œ ëª©ë¡ ë°°ì—´ (ë¡œì»¬)
    let timerInterval = null;
    
    // (Helper: Sound)
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(frequency, duration) {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration);
    }
    
    // ----------------------------------------------------------------------
    // 3. View Management
    // ----------------------------------------------------------------------
    function hideAll() {
        document.getElementById('initial-screen').classList.add('hidden');
        document.getElementById('teacher-login-screen').classList.add('hidden');
        document.getElementById('teacher-view').classList.add('hidden');
        document.getElementById('student-login').classList.add('hidden');
        document.getElementById('student-view').classList.add('hidden');
    }

    function showTeacherLogin() {
        hideAll();
        document.getElementById('teacher-login-screen').classList.remove('hidden');
    }
    
    function teacherLogin() {
        const password = document.getElementById('teacher-password').value;
        if (password === TEACHER_PASSWORD) {
            showTeacherView();
        } else {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
            document.getElementById('teacher-password').value = '';
        }
    }

    function showTeacherView() {
        hideAll();
        document.getElementById('teacher-view').classList.remove('hidden');
    }
    // ... (ë‚˜ë¨¸ì§€ View Management í•¨ìˆ˜ëŠ” ë™ì¼)

    function showStudentLogin() {
        hideAll();
        document.getElementById('student-login').classList.remove('hidden');
    }

    function showStudentView() {
        hideAll();
        document.getElementById('student-view').classList.remove('hidden');
        if(currentGameState.comboThreshold) {
             updateLifeRuleInfo(currentGameState.comboThreshold);
        }
    }
    
    function updateLifeRuleInfo(threshold) {
        const infoElement = document.getElementById('life-rule-info');
        if (threshold > 0) {
            infoElement.innerHTML = `âš ï¸ ê·œì¹™: **${threshold}ì—°ì† ì •ë‹µ** ì‹œ â¤ï¸ ëª©ìˆ¨ +1 ë³´ë„ˆìŠ¤!`;
            infoElement.classList.remove('hidden');
        } else {
            infoElement.classList.add('hidden');
        }
    }
    
    // ----------------------------------------------------------------------
    // 4. Firebase Data Listeners (ì‹¤ì‹œê°„ ë™ê¸°í™”)
    // ----------------------------------------------------------------------
    
    stateRef.on('value', (snapshot) => {
        currentGameState = snapshot.val() || { questionIndex: 0, isActive: false, comboThreshold: 5, showResult: false };
        
        updateLifeRuleInfo(currentGameState.comboThreshold);

        if (!document.getElementById('teacher-view').classList.contains('hidden')) {
            updateTeacherView();
        }

        if (currentUser && !document.getElementById('student-view').classList.contains('hidden')) {
             updateStudentStateFromDB();
        }
    });
    
    studentRef.on('value', (snapshot) => {
        const students = snapshot.val();
        studentList = students ? Object.values(students) : [];
        
        updateQuizAreaViews();
        
        if (currentUser) {
            const updatedUser = studentList.find(s => s.id === currentUser.id);
            if (updatedUser) {
                currentUser = updatedUser;
                document.getElementById('student-lives').innerText = `â¤ï¸ ëª©ìˆ¨: ${currentUser.lives}`;
                updateComboDisplay();
            }
        }
    });

    // **[NEW LISTENER] ë¬¸ì œ í’€ ë³€í™” ê°ì§€**
    problemPoolRef.on('value', (snapshot) => {
        const problems = snapshot.val();
        problemPool = problems ? Object.entries(problems).map(([key, value]) => ({ id: key, ...value })) : [];
        updateProblemListUI();
    });


    // ----------------------------------------------------------------------
    // 5. Problem Management (ì„ ìƒë‹˜ ë¬¸ì œ ì…‹íŒ… ë¡œì§)
    // ----------------------------------------------------------------------

    // **[NEW] ë¬¸ì œ ëª©ë¡ì— ë¬¸ì œ ì¶”ê°€**
    function addQuestionToPool() {
        const text = document.getElementById('question-input').value.trim();
        const timer = parseInt(document.getElementById('timer-select').value);
        const answer = document.getElementById('correct-answer').value;

        if (!text || timer < 5) {
            alert('ë¬¸ì œ ë‚´ìš©ê³¼ ìœ íš¨í•œ ì œí•œ ì‹œê°„(5ì´ˆ ì´ìƒ)ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }

        const newProblem = {
            text: text,
            timer: timer,
            answer: answer
        };

        // Firebaseì— ìƒˆë¡œìš´ ë¬¸ì œ ì¶”ê°€ (ìë™ ìƒì„±ëœ í‚¤ ì‚¬ìš©)
        problemPoolRef.push(newProblem)
            .then(() => {
                document.getElementById('question-input').value = ''; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                alert('âœ… ë¬¸ì œê°€ ì„±ê³µì ìœ¼ë¡œ ë¬¸ì œ ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            })
            .catch(error => {
                alert('âŒ ë¬¸ì œ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
            });
    }

    // **[NEW] ë¬¸ì œ ëª©ë¡ UI ì—…ë°ì´íŠ¸**
    function updateProblemListUI() {
        const container = document.getElementById('problem-list-container');
        const countElement = document.getElementById('problem-count');
        
        container.innerHTML = '';
        countElement.innerText = problemPool.length;

        if (problemPool.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: gray; font-family: \'Bangers\', cursive;">ì•„ì§ ì…‹íŒ…ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        problemPool.forEach((problem, index) => {
            const item = document.createElement('div');
            item.className = 'problem-item';
            
            const textContent = `${index + 1}. [${problem.answer}] (${problem.timer}ì´ˆ) ${problem.text.substring(0, 50)}${problem.text.length > 50 ? '...' : ''}`;
            
            const textDiv = document.createElement('div');
            textDiv.className = 'problem-text';
            textDiv.innerText = textContent;

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerText = 'ì‚­ì œ';
            deleteBtn.onclick = () => deleteQuestionFromPool(problem.id);

            item.appendChild(textDiv);
            item.appendChild(deleteBtn);
            container.appendChild(item);
        });
    }

    // **[NEW] ë¬¸ì œ ëª©ë¡ì—ì„œ ì‚­ì œ**
    function deleteQuestionFromPool(problemId) {
        if (confirm('ì •ë§ë¡œ ì´ ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            database.ref(`quizGame/problemPool/${problemId}`).remove()
                .then(() => {
                    alert('âœ… ë¬¸ì œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                })
                .catch(error => {
                    alert('âŒ ë¬¸ì œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
                });
        }
    }

    // **[NEW] ì…‹íŒ…ëœ ë¬¸ì œë¡œ ê²Œì„ ì‹œì‘ ë° ë‹¤ìŒ ë¬¸ì œ ì¶œì œ**
    async function startGameWithPool() {
        if (problemPool.length === 0) {
            alert('ğŸš¨ ìµœì†Œ 1ê°œ ì´ìƒì˜ ë¬¸ì œë¥¼ ì…‹íŒ…í•´ì•¼ ê²Œì„ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            return;
        }

        // 1. ì´ë¯¸ ì§„í–‰ ì¤‘ì¸ í€´ì¦ˆê°€ ìˆë‹¤ë©´ ê²°ê³¼ ì²˜ë¦¬
        if (currentGameState.isActive && timerInterval) {
            clearInterval(timerInterval);
            await processResults(true); // ê°•ì œ ì¢…ë£Œë¡œ ì²˜ë¦¬
        }
        
        // 2. ì½¤ë³´ ì„¤ì •ê°’ ê°€ì ¸ì˜¤ê¸°
        const comboThreshold = parseInt(document.getElementById('combo-life-threshold').value) || 5;

        // 3. ê²Œì„ ìƒíƒœ ì´ˆê¸°í™” ë° ì²« ë¬¸ì œ ì„¤ì • (indexëŠ” 0ë¶€í„° ì‹œì‘)
        const firstProblem = problemPool[0];
        const newQuestionIndex = 1;
        
        const newGameState = {
            questionIndex: newQuestionIndex,
            currentProblemKey: problemPool[0].id, // í˜„ì¬ ë¬¸ì œì˜ Key ì €ì¥
            currentQuestion: { text: firstProblem.text, timer: firstProblem.timer, answer: firstProblem.answer },
            isActive: true,
            showResult: false,
            answerTime: Date.now(),
            comboThreshold: comboThreshold,
            isGameStarted: true // ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŒì„ í‘œì‹œ
        };

        // 4. í•™ìƒë“¤ì˜ ë‹µë³€ ìƒíƒœ ì´ˆê¸°í™” (answered í•„ë“œë§Œ)
        const studentUpdates = {};
        studentList.forEach(student => {
            if (student.lives > 0) {
                 studentUpdates[student.id + '/answered'] = null;
            }
        });
        await studentRef.update(studentUpdates);

        // 5. Firebaseì— ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸
        await stateRef.set(newGameState);
        
        alert(`âœ… ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! ì´ ${problemPool.length}ê°œì˜ ë¬¸ì œ ì¤‘ 1ë²ˆ ë¬¸ì œê°€ ë°°í¬ë©ë‹ˆë‹¤.`);
    }


    // **[MODIFIED] ë‹¤ìŒ ë¬¸ì œë¡œ ì§„í–‰**
    async function proceedToNextQuestion() {
        const nextIndex = currentGameState.questionIndex + 1;

        if (nextIndex > problemPool.length) {
            // ëª¨ë“  ë¬¸ì œ ì†Œì§„ -> ìµœì¢… ê²°ê³¼ ì²˜ë¦¬
            endGame(true); // ëª¨ë“  ë¬¸ì œ ì™„ë£Œ í”Œë˜ê·¸
            return;
        }
        
        const nextProblem = problemPool[nextIndex - 1]; // ë°°ì—´ì€ 0ë¶€í„° ì‹œì‘

        // í•™ìƒë“¤ì˜ ë‹µë³€ ìƒíƒœ ì´ˆê¸°í™”
        const studentUpdates = {};
        studentList.forEach(student => {
            if (student.lives > 0) {
                 studentUpdates[student.id + '/answered'] = null;
            }
        });
        await studentRef.update(studentUpdates);

        // ìƒˆë¡œìš´ ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸
        await stateRef.update({
            questionIndex: nextIndex,
            currentProblemKey: nextProblem.id,
            currentQuestion: { text: nextProblem.text, timer: nextProblem.timer, answer: nextProblem.answer },
            isActive: true,
            showResult: false,
            answerTime: Date.now(),
        });
    }

    // ----------------------------------------------------------------------
    // 6. Teacher Logic (View Update)
    // ----------------------------------------------------------------------
    
    // [MODIFIED] ì„ ìƒë‹˜ ë·° ì—…ë°ì´íŠ¸
    function updateTeacherView() {
        const state = currentGameState;
        document.getElementById('question-index').innerText = state.questionIndex;
        
        // ê²Œì„ì´ ì‹œì‘ë˜ì—ˆê³  ë¬¸ì œ í’€ì´ ì¤‘ì¸ ê²½ìš°
        if (state.isGameStarted && state.isActive) {
            document.getElementById('teacher-preparation').classList.add('hidden');
            document.getElementById('teacher-live-quiz').classList.remove('hidden');
            document.getElementById('current-question').innerText = `[#${state.questionIndex}/${problemPool.length}] ${state.currentQuestion.text}`;

            const remainingTime = Math.max(0, state.currentQuestion.timer - Math.floor((Date.now() - state.answerTime) / 1000));
            startTimer(remainingTime, 'teacher');
            
        // ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìœ¼ë‚˜ ê²°ê³¼ í‘œì‹œ ë˜ëŠ” ë‹¤ìŒ ë¬¸ì œ ëŒ€ê¸° ì¤‘ì¸ ê²½ìš°
        } else if (state.isGameStarted && !state.isActive && state.questionIndex <= problemPool.length) {
            document.getElementById('teacher-preparation').classList.add('hidden');
            document.getElementById('teacher-live-quiz').classList.remove('hidden');
            
            // ê²°ê³¼ í‘œì‹œê°€ ëë‚¬ë‹¤ë©´, ë‹¤ìŒ ë¬¸ì œ ë²„íŠ¼ì„ ë³´ì—¬ì¤Œ
            if (!state.showResult) {
                document.getElementById('current-question').innerHTML = 
                    `<span style="color: #f1c40f; text-shadow: 2px 2px 0 #000;">ë‹¤ìŒ ë¬¸ì œ ì¤€ë¹„ ì™„ë£Œ!</span><br>` + 
                    `<button class="block-button green-button" onclick="proceedToNextQuestion()">â¡ï¸ ë‹¤ìŒ ë¬¸ì œ ì¶œì œ (#${state.questionIndex + 1})</button>`;
            }
        
        // ê²Œì„ ì‹œì‘ ì „ì´ê±°ë‚˜ ìµœì¢… ì¢…ë£Œëœ ê²½ìš°
        } else {
            document.getElementById('teacher-preparation').classList.remove('hidden');
            document.getElementById('teacher-live-quiz').classList.add('hidden');
        }
    }


    function resetGameData() {
        const confirmReset = confirm('ğŸš¨ ê²½ê³ : í˜„ì¬ ì €ì¥ëœ ëª¨ë“  í•™ìƒ ì •ë³´, ê²Œì„ ê¸°ë¡ ë° ë¬¸ì œ ëª©ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if (confirmReset) {
            gameRef.remove()
                .then(() => {
                    alert('âœ… ê²Œì„ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
                    location.reload(); 
                })
                .catch(error => {
                    alert('âŒ ë°ì´í„° ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
                });
        }
    }

    // ----------------------------------------------------------------------
    // 7. Core Game Logic
    // ----------------------------------------------------------------------

    async function processResults(isForced = false) {
        if (currentGameState.showResult || !currentGameState.isActive) return;
        
        clearInterval(timerInterval);
        
        const correctAnswer = currentGameState.currentQuestion.answer;
        const comboThreshold = currentGameState.comboThreshold;
        
        const studentUpdates = {};
        let isCurrentUserCorrect = false;
        let isLifeGained = false;

        studentList.forEach(student => {
            if (student.lives > 0) { 
                if (student.answered === correctAnswer && !isForced) {
                    student.combo = (student.combo || 0) + 1;
                    
                    if (comboThreshold > 0 && (student.combo % comboThreshold === 0)) {
                         student.lives++; 
                         if (student.id === currentUser?.id) isLifeGained = true;
                    }
                    
                    if (student.id === currentUser?.id) isCurrentUserCorrect = true;
                } else {
                    student.lives--;
                    student.combo = 0;
                }
                
                studentUpdates[student.id] = {
                    lives: student.lives,
                    combo: student.combo,
                    answered: student.answered 
                };
            }
        });

        await studentRef.update(studentUpdates);

        await stateRef.update({
            isActive: false,
            showResult: true,
            isCurrentUserCorrect: isCurrentUserCorrect, 
            isLifeGained: isLifeGained 
        });
        
        // ê²°ê³¼ í‘œì‹œ í›„ ë‹¤ìŒ ë¬¸ì œë¡œ ìë™ ì§„í–‰ (ì„ ìƒë‹˜ ë·°ì—ì„œë§Œ ì‹¤í–‰)
        if (!document.getElementById('teacher-view').classList.contains('hidden')) {
            setTimeout(() => {
                stateRef.update({ showResult: false }); 
                // ê²°ê³¼ í™”ë©´ì´ ëë‚œ í›„, ë‹¤ìŒ ë¬¸ì œë¡œ ë°”ë¡œ ë„˜ì–´ê°€ì§€ ì•Šê³  ë²„íŠ¼ í´ë¦­ì„ ëŒ€ê¸°
            }, 3000);
        }
    }
    
    // (ë‚˜ë¨¸ì§€ ë¡œì§ì€ ë¬¸ì œ ê´€ë¦¬ì™€ ë¬´ê´€í•˜ê²Œ ë™ì¼)

    function showResultScreen(isCorrect, isLifeGained, question) { 
        // ... (ê²°ê³¼ í™”ë©´ í‘œì‹œ ë¡œì§ ë™ì¼)
        const resultScreen = document.getElementById('result-screen');
        const resultEmoji = document.getElementById('result-emoji');
        const resultMessage = document.getElementById('result-message');
        
        document.querySelectorAll('.quiz-state').forEach(el => el.classList.add('hidden'));
        document.getElementById('student-result').classList.remove('hidden');

        if (isCorrect) {
            resultScreen.className = 'correct-result';
            resultEmoji.textContent = 'ğŸ‰';
            let msg = `<span style="color: #fff; font-size: 2em;">ì •ë‹µ!</span>`;
            
            if (isLifeGained) {
                 msg += `<br><span style="color: #ffea00; font-size: 1.5em;">â­ëª©ìˆ¨ +1 ë³´ë„ˆìŠ¤! (${currentGameState.comboThreshold}ì½¤ë³´)</span>`;
            }
            resultMessage.innerHTML = msg;
            playSound(523, 0.2);
            playSound(659, 0.2);
        } else {
            resultScreen.className = 'wrong-result';
            resultEmoji.textContent = 'ğŸ’¥';
            resultMessage.innerHTML = `<span style="color: #fff; font-size: 2em;">í‹€ë ¸ì–´ìš”! ì •ë‹µì€ [${question.answer}]</span>`;
            playSound(200, 0.3);
        }
    }

    function endGame(isAllCompleted = false) {
        // ëª¨ë“  ë¬¸ì œ ì†Œì§„ìœ¼ë¡œ ì¸í•œ ì¢…ë£Œê°€ ì•„ë‹ˆë¼ë©´, í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë¬¸ì œ ê²°ê³¼ ì²˜ë¦¬
        if (!isAllCompleted && currentGameState.isActive) {
             processResults(true); 
        }
        
        let survivingStudents = studentList.filter(s => s.lives > 0);
        
        let rankingMessage = '';

        if (survivingStudents.length > 0) {
            survivingStudents.sort((a, b) => b.combo - a.combo);
            
            const topStudent = survivingStudents[0];
            let winnerMessage = `ğŸ† MVP (ìµœê³  ì½¤ë³´): ${topStudent.emoji} ${topStudent.nickname} (${topStudent.combo} ì½¤ë³´)`;
            
            rankingMessage = survivingStudents.slice(0, 5).map((s, i) => 
                `${i+1}ìœ„: ${s.emoji} ${s.nickname} (ìµœëŒ€ ì½¤ë³´: ${s.combo})`
            ).join('\n');

            alert(`ğŸ‰ ê²Œì„ ì¢…ë£Œ! (ì´ ${problemPool.length}ë¬¸ì œ ì™„ë£Œ)\n\n${winnerMessage}\n\nğŸ“Š ìµœì¢… ìˆœìœ„:\n${rankingMessage}`);
        } else {
            alert(`ğŸ˜¢ ì•„ì‰½ì§€ë§Œ ìƒì¡´ìê°€ ì—†ìŠµë‹ˆë‹¤. ê²Œì„ ì¢…ë£Œ!`);
        }

        // ìµœì¢… ì¢…ë£Œ ìƒíƒœë¡œ ë³€ê²½
        stateRef.update({ isActive: false, showResult: false, isGameStarted: false, questionIndex: 0 });
    }
    
    // ... (Student Logic ë° Visualization í•¨ìˆ˜ëŠ” ì´ì „ ë²„ì „ê³¼ ë™ì¼)
    async function loginStudent() { /* ... */ }
    function updateStudentStateFromDB() { /* ... */ }
    function submitAnswer(answer) { /* ... */ }
    function updateComboDisplay() { /* ... */ }
    function updateQuizAreaViews() { /* ... */ }
    function updateQuizArea(container, students) { /* ... */ }
    function startTimer(seconds, role) { /* ... */ }
</script>

</body>
</html>



