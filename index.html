<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Roblox MAX! OX Quiz - Real-time Multiplayer</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Bangers&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <style>
        /* CSS ìŠ¤íƒ€ì¼ì€ ì´ì „ ë²„ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ë©ë‹ˆë‹¤. */
        /* ---------------------- 1. Roblox Global Style ---------------------- */
        body { 
            font-family: 'Bangers', cursive; 
            margin: 0; 
            padding: 20px; 
            background-color: #64dd17; 
            background-image: 
                linear-gradient(45deg, rgba(0,0,0,0.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.1) 75%, rgba(0,0,0,0.1)),
                linear-gradient(45deg, rgba(0,0,0,0.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.1) 75%, rgba(0,0,0,0.1));
            background-size: 50px 50px; 
            background-position: 0 0, 25px 25px; 
            color: #212121; 
        }
        #app { 
            max-width: 950px; 
            margin: 20px auto; 
            padding: 40px; 
            background: #ffffff; 
            border: 8px solid #303030; 
            border-radius: 15px; 
            box-shadow: 15px 15px 0px #303030; 
            position: relative;
            z-index: 10;
        }
        h2, h3, h4 { 
            font-family: 'Press Start 2P', cursive; 
            color: #000000; 
            text-align: center;
            text-shadow: 3px 3px 0px #ffea00; 
            margin-bottom: 25px;
        }
        h2 { font-size: 2.5em; }
        h3 { font-size: 2em; }
        h4 { font-size: 1.5em; }

        /* ---------------------- 2. Block Button Style ---------------------- */
        button, .block-button { 
            font-family: 'Press Start 2P', cursive;
            padding: 18px 30px; 
            margin: 10px; 
            border: 5px solid #000000; 
            border-radius: 8px; 
            font-size: 1.2em; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 6px 6px 0px #000000; 
            transition: all 0.1s;
            text-shadow: 2px 2px 0 #000;
            color: white;
            background-color: #3498db; 
            letter-spacing: 1px;
        }
        button:active, .block-button:active {
            box-shadow: 2px 2px 0px #000000;
            transform: translate(4px, 4px); 
        }
        .green-button { background-color: #2ecc71; } 
        .red-button { background-color: #e74c3c; } 
        .yellow-button { background-color: #f1c40f; color: #000; text-shadow: none; } 

        /* ---------------------- 3. Layout and Elements ---------------------- */
        .hidden { display: none !important; }
        .centered { text-align: center; }
        input, select { 
            font-family: 'Bangers', cursive;
            padding: 12px; 
            margin: 10px auto; 
            border: 3px solid #000000; 
            border-radius: 8px; 
            box-shadow: 4px 4px 0px #000000; 
            font-size: 1.1em; 
            width: 80%; 
            max-width: 450px;
            display: block;
            background-color: #fefefe;
            color: #212121;
        }
        label {
            font-family: 'Press Start 2P', cursive;
            display: block;
            margin-top: 20px;
            margin-bottom: 5px;
            color: #333;
            font-size: 0.9em;
            text-shadow: 1px 1px 0px #fff;
        }
        /* Live Quiz Area, Badges, Avatars, Combo, Result Screen styles remain */
        .result-box { display: flex; justify-content: space-around; margin-top: 30px; }
        .o-area, .x-area { 
            flex-basis: 48%; 
            padding: 20px; 
            border: 6px solid #000; 
            border-radius: 12px; 
            min-height: 200px; 
            box-shadow: 8px 8px 0px #000;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 10px; 
        }
        .o-area { background-color: #4CAF50; } 
        .x-area { background-color: #F44336; } 
        .count-badge { 
            font-family: 'Press Start 2P', cursive;
            font-size: 2.5em; 
            font-weight: bold; 
            padding: 15px 0; 
            color: #000; 
            background: #FFD700; 
            border-radius: 8px; 
            margin-bottom: 20px;
            border: 4px solid #000;
            box-shadow: 4px 4px 0px #000;
            width: 100%;
            text-shadow: 2px 2px 0px #fff;
        }
        .student-avatar { 
            display: inline-block; 
            margin: 5px; 
            padding: 10px 15px; 
            border-radius: 0%; 
            background: #ffffff; 
            font-size: 1.2em; 
            font-weight: bold;
            border: 3px solid #000;
            box-shadow: 3px 3px 0px #000;
            white-space: nowrap;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); 
            cursor: help; 
        }
        .spectator-mode { 
            opacity: 0.4;
            filter: grayscale(100%);
            text-decoration: line-through; 
            border-color: #757575;
            box-shadow: 2px 2px 0px #757575;
            background-color: #bdbdbd;
        }
    </style>
</head>
<body>

<div id="app">
    <div id="initial-screen" class="centered">
        <h2>ğŸš€ Roblox í€´ì¦ˆ ìŠ¤íƒ€íŠ¸! ğŸš€</h2>
        <button class="block-button yellow-button" onclick="showTeacherLogin()">ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ìœ¼ë¡œ ì ‘ì†</button>
        <button class="block-button yellow-button" onclick="showStudentLogin()">ğŸ‘§ğŸ‘¦ í•™ìƒìœ¼ë¡œ ì ‘ì†</button>
        <p style="font-family: sans-serif; font-size: 0.8em; color: gray;">
            (Firebaseë¥¼ í†µí•´ ì‹¤ì‹œê°„ ë™ê¸°í™”ë©ë‹ˆë‹¤.)
        </p>
    </div>
    
    <div id="teacher-login-screen" class="hidden centered">
        <h3>ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h3>
        <input type="password" id="teacher-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
        <button class="block-button yellow-button" onclick="teacherLogin()">ë¡œê·¸ì¸</button>
    </div>

    <div id="teacher-view" class="hidden">
        <h3>ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ ê´€ë¦¬ ë¸”ë¡ (ë¬¸ì œ #<span id="question-index">0</span>)</h3>
        <button class="block-button red-button" onclick="resetGameData()" style="margin-bottom: 20px;">
            ğŸ”„ ë°ì´í„° ì´ˆê¸°í™” (ì „ì²´ ì‚­ì œ)
        </button>
        
        <div id="teacher-preparation" class="centered">
            <input type="hidden" id="game-mode" value="individual"> 
            
            <label for="combo-life-threshold">ì¶”ê°€ ëª©ìˆ¨ íšë“ ì½¤ë³´ íšŸìˆ˜:</label>
            <input type="number" id="combo-life-threshold" value="5" min="2" max="10" placeholder="ì½¤ë³´ íšŸìˆ˜ (ê¸°ë³¸ 5)">

            <label for="question-input">ë¬¸ì œ ì…ë ¥:</label>
            <input type="text" id="question-input" placeholder="ğŸ’¡ O/X í€´ì¦ˆ ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <label for="timer-select">ì œí•œ ì‹œê°„ (ì´ˆ):</label>
            <input type="number" id="timer-select" value="10" min="5" max="30" placeholder="ì œí•œ ì‹œê°„ (ì´ˆ)">
            <label for="correct-answer">ì •ë‹µ ì„¤ì •:</label>
            <select id="correct-answer">
                <option value="O">O</option>
                <option value="X">X</option>
            </select>
            <button class="block-button green-button" onclick="sendQuestion()">âš¡ ë¬¸ì œ ì¶œì œ ë° í€´ì¦ˆ ì‹œì‘ (ë‹¤ìŒ ë¬¸ì œ)</button>
        </div>

        <div id="teacher-live-quiz" class="hidden">
            <h4>ğŸš¨ LIVE í€´ì¦ˆ: <span id="current-question"></span></h4>
            <div id="timer-display">TIME: <span id="timer-value">10</span></div>
            <div class="result-box">
                <div class="o-area">
                    <div class="count-badge">O: <span id="o-count">0</span></div>
                    <div id="o-answers" class="answer-list"></div>
                </div>
                <div class="x-area">
                    <div class="count-badge">X: <span id="x-count">0</span></div>
                    <div id="x-answers" class="answer-list"></div>
                </div>
            </div>
            <button class="block-button red-button" onclick="endGame()">ğŸ’£ ê²Œì„ ê°•ì œ ì¢…ë£Œ (ìµœì¢… ìŠ¹ë¦¬ì ë°œí‘œ)</button>
        </div>
    </div>

    <div id="student-login" class="hidden centered">
        <h3>ğŸ‘¤ ì•„ë°”íƒ€ ì„¤ì • ë¸”ë¡</h3>
        <input type="text" id="student-nickname" placeholder="â­ ë‹‰ë„¤ì„ ì…ë ¥">
        <label for="emoji-select">ë™ë¬¼ ì´ëª¨ì§€ ì„ íƒ:</label>
        <select id="emoji-select">
            <option value="ğŸ¦">ğŸ¦ ì‚¬ì</option>
            <option value="ğŸ°">ğŸ° í† ë¼</option>
            <option value="ğŸ¶">ğŸ¶ ê°•ì•„ì§€</option>
            <option value="ğŸ»">ğŸ» ê³°</option>
            <option value="ğŸ¦Š">ğŸ¦Š ì—¬ìš°</option>
            <option value="ğŸ¼">ğŸ¼ íŒë‹¤</option>
            <option value="ğŸ¯">ğŸ¯ í˜¸ë‘ì´</option>
            <option value="ğŸ¨">ğŸ¨ ì½”ì•Œë¼</option>
            <option value="ğŸµ">ğŸµ ì›ìˆ­ì´</option>
            <option value="ğŸ¸">ğŸ¸ ê°œêµ¬ë¦¬</option>
            <option value="ğŸ§">ğŸ§ ğŸ§</option>
            <option value="ğŸ¦‰">ğŸ¦‰ ë¶€ì—‰ì´</option>
            <option value="ğŸ¦†">ğŸ¦† ì˜¤ë¦¬</option>
            <option value="ğŸ™">ğŸ™ ë¬¸ì–´</option>
            <option value="ğŸ¦€">ğŸ¦€ ê²Œ</option>
            <option value="ğŸ¢">ğŸ¢ ê±°ë¶ì´</option>
        </select>
        <button class="block-button yellow-button" onclick="loginStudent()">â–¶ï¸ í€´ì¦ˆë°© ì…ì¥</button>
    </div>

    <div id="student-view" class="hidden">
        <h3 id="student-info" class="centered"></h3>
        <p id="student-lives">â¤ï¸ ëª©ìˆ¨: 3</p>
        <div id="life-rule-info"></div>
        <div id="combo-indicator" class="combo-display hidden">
            ğŸ”¥ <span id="combo-count">0</span> COMBO!
        </div>

        <div id="student-waiting" class="quiz-state centered">
            <h4 class="red-button" style="background-color: #3498db; border-color: #2c3e50; display: inline-block;">
                ğŸ“¢ ì„ ìƒë‹˜ì´ ë¸”ë¡ì„ ì¡°ë¦½ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!
            </h4>
        </div>

        <div id="student-answering" class="quiz-state hidden centered">
            <h4 id="question-text" style="font-size: 1.8em; border-bottom: 5px solid #f39c12; padding-bottom: 10px;"></h4>
            <div id="student-timer-display">TIME: <span id="student-timer-value">10</span></div>
            <div class="answer-buttons">
                <button class="o-btn green-button" onclick="submitAnswer('O')">O</button>
                <button class="x-btn red-button" onclick="submitAnswer('X')">X</button>
            </div>
        </div>

        <div id="student-result" class="quiz-state hidden centered">
            <div id="result-screen">
                <div class="result-emoji" id="result-emoji">âœ¨</div>
                <h4 id="result-message"></h4>
            </div>
            <div id="spectator-view" class="result-box">
                <div class="o-area"><div class="count-badge">O: <span class="o-count-spectator">0</span></div><div id="o-answers-spectator" class="answer-list"></div></div>
                <div class="x-area"><div class="count-badge">X: <span class="x-count-spectator">0</span></div><div id="x-answers-spectator" class="answer-list"></div></div>
            </div>
        </div>
    </div>
</div>

<script>
    // ----------------------------------------------------------------------
    // ğŸ“¢ 1. Firebase ì„¤ì • (í•„ìˆ˜ ìˆ˜ì • ì˜ì—­) ğŸ“¢
    // ----------------------------------------------------------------------
    const firebaseConfig = {
  apiKey: "AIzaSyAoEYmlGb4tvWtYEQyBusIlyRDajD7-wtI",
  authDomain: "ox-quiz-ce39f.firebaseapp.com",
  databaseURL: "https://ox-quiz-ce39f-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "ox-quiz-ce39f",
  storageBucket: "ox-quiz-ce39f.firebasestorage.app",
  messagingSenderId: "509722567204",
  appId: "1:509722567204:web:728f6e3bd0851909d36eb1"
};

    // Firebase ì´ˆê¸°í™”
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const gameRef = database.ref('quizGame');
    const studentRef = database.ref('quizGame/students');
    const stateRef = database.ref('quizGame/state');
    
    // ----------------------------------------------------------------------
    // 2. ì „ì—­ ë³€ìˆ˜ ë° ìƒìˆ˜
    // ----------------------------------------------------------------------
    const TEACHER_PASSWORD = 'teacher1234'; // ì„ ìƒë‹˜ ë¹„ë°€ë²ˆí˜¸
    let currentUser = null; // í˜„ì¬ ì ‘ì†í•œ í•™ìƒ ì •ë³´ (ë¡œì»¬)
    let currentGameState = {}; // í˜„ì¬ ê²Œì„ ìƒíƒœ (DB ë™ê¸°í™”)
    let studentList = []; // í˜„ì¬ ëª¨ë“  í•™ìƒ ëª©ë¡ (DB ë™ê¸°í™”)
    let timerInterval = null;
    let timerStartTime = 0;
    
    // ----------------------------------------------------------------------
    // 3. View Management
    // ----------------------------------------------------------------------
    function hideAll() {
        document.getElementById('initial-screen').classList.add('hidden');
        document.getElementById('teacher-login-screen').classList.add('hidden');
        document.getElementById('teacher-view').classList.add('hidden');
        document.getElementById('student-login').classList.add('hidden');
        document.getElementById('student-view').classList.add('hidden');
    }

    // [MODIFIED] ì´ˆê¸°í™”ë©´ì—ì„œ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ë¶„ê¸°
    function showTeacherLogin() {
        hideAll();
        document.getElementById('teacher-login-screen').classList.remove('hidden');
    }
    
    // [NEW] ì„ ìƒë‹˜ ë¡œê·¸ì¸ ë¡œì§
    function teacherLogin() {
        const password = document.getElementById('teacher-password').value;
        if (password === TEACHER_PASSWORD) {
            showTeacherView();
        } else {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
            document.getElementById('teacher-password').value = '';
        }
    }

    function showTeacherView() {
        hideAll();
        document.getElementById('teacher-view').classList.remove('hidden');
        // ì„ ìƒë‹˜ ë·°ëŠ” ë°ì´í„° êµ¬ë…ë§Œ í•˜ê³ , í™”ë©´ ì—…ë°ì´íŠ¸ëŠ” ë¦¬ìŠ¤ë„ˆì—ì„œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
    }

    function showStudentLogin() {
        hideAll();
        document.getElementById('student-login').classList.remove('hidden');
    }

    function showStudentView() {
        hideAll();
        document.getElementById('student-view').classList.remove('hidden');
        // í•™ìƒ ë·° ì „í™˜ ì‹œ ê·œì¹™ ì—…ë°ì´íŠ¸
        if(currentGameState.comboThreshold) {
             updateLifeRuleInfo(currentGameState.comboThreshold);
        }
    }
    
    function updateLifeRuleInfo(threshold) {
        const infoElement = document.getElementById('life-rule-info');
        if (threshold > 0) {
            infoElement.innerHTML = `âš ï¸ ê·œì¹™: **${threshold}ì—°ì† ì •ë‹µ** ì‹œ â¤ï¸ ëª©ìˆ¨ +1 ë³´ë„ˆìŠ¤!`;
            infoElement.classList.remove('hidden');
        } else {
            infoElement.classList.add('hidden');
        }
    }
    
    // ----------------------------------------------------------------------
    // 4. Firebase Data Listeners (ì‹¤ì‹œê°„ ë™ê¸°í™” í•µì‹¬)
    // ----------------------------------------------------------------------
    
    // ê²Œì„ ìƒíƒœ(ë¬¸ì œ, íƒ€ì´ë¨¸ ë“±) ë³€í™” ê°ì§€
    stateRef.on('value', (snapshot) => {
        currentGameState = snapshot.val() || { questionIndex: 0, isActive: false, comboThreshold: 5 };
        
        // ì½¤ë³´ ê·œì¹™ ì—…ë°ì´íŠ¸
        updateLifeRuleInfo(currentGameState.comboThreshold);

        // ì„ ìƒë‹˜ ë·° ì—…ë°ì´íŠ¸ (ëŒ€ê¸°/ë¼ì´ë¸Œ ì „í™˜)
        if (!document.getElementById('teacher-view').classList.contains('hidden')) {
            updateTeacherView();
        }

        // í•™ìƒ ë·° ì—…ë°ì´íŠ¸ (ë¬¸ì œ í’€ì´/ëŒ€ê¸° ì „í™˜)
        if (currentUser && !document.getElementById('student-view').classList.contains('hidden')) {
             updateStudentStateFromDB();
        }
    });
    
    // í•™ìƒ ëª©ë¡(ë‹µë³€, ëª©ìˆ¨ ë“±) ë³€í™” ê°ì§€
    studentRef.on('value', (snapshot) => {
        const students = snapshot.val();
        studentList = students ? Object.values(students) : [];
        
        // ì„ ìƒë‹˜/í•™ìƒ ë·°ì˜ ë‹µë³€ í˜„í™© ì—…ë°ì´íŠ¸
        updateQuizAreaViews();
        
        // í˜„ì¬ ì ‘ì†í•œ í•™ìƒì˜ ë¡œì»¬ ì •ë³´ ì—…ë°ì´íŠ¸
        if (currentUser) {
            const updatedUser = studentList.find(s => s.id === currentUser.id);
            if (updatedUser) {
                currentUser = updatedUser;
                document.getElementById('student-lives').innerText = `â¤ï¸ ëª©ìˆ¨: ${currentUser.lives}`;
                updateComboDisplay();
            }
        }
    });

    // ----------------------------------------------------------------------
    // 5. Student Logic
    // ----------------------------------------------------------------------

    // [MODIFIED] Firebaseì— í•™ìƒ ì •ë³´ ì €ì¥/ì—…ë°ì´íŠ¸
    async function loginStudent() {
        const nickname = document.getElementById('student-nickname').value;
        const emoji = document.getElementById('emoji-select').value;
        if (!nickname) {
            alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì•¼ ê²Œì„ì„ ì‹œì‘í•  ìˆ˜ ìˆì–´ìš”!');
            return;
        }

        const studentDataSnapshot = await studentRef.once('value');
        const students = studentDataSnapshot.val();
        
        // ê¸°ì¡´ ë‹‰ë„¤ì„ ì‚¬ìš©ìë¥¼ ì°¾ìŠµë‹ˆë‹¤.
        let existingUser = studentList.find(s => s.nickname === nickname);
        
        let studentId;
        
        if (existingUser) {
            studentId = existingUser.id;
            // ë¡œì»¬ ì •ë³´ ì—…ë°ì´íŠ¸
            currentUser = existingUser;
            currentUser.emoji = emoji; 
        } else {
            studentId = 's_' + Date.now();
            currentUser = { 
                id: studentId, 
                nickname, 
                emoji, 
                lives: 3, 
                answered: null,
                combo: 0
            };
        }
        
        // Firebaseì— ì •ë³´ ì“°ê¸°/ì—…ë°ì´íŠ¸
        await database.ref(`quizGame/students/${studentId}`).update(currentUser);

        document.getElementById('student-info').innerHTML = `${currentUser.emoji} **${currentUser.nickname}**ë‹˜, í™˜ì˜í•´ìš”!`;
        showStudentView();
    }
    
    // [MODIFIED] DB ìƒíƒœì— ë”°ë¼ í•™ìƒ ë·° ì „í™˜
    function updateStudentStateFromDB() {
        const state = currentGameState;
        document.querySelectorAll('.quiz-state').forEach(el => el.classList.add('hidden'));

        if (!currentUser || currentUser.lives <= 0) {
            document.getElementById('student-result').classList.remove('hidden');
            document.getElementById('result-message').innerHTML = "ğŸ’¥ **YOU LOSE!** ğŸ’¥ ì´ì œ ì¹œêµ¬ë“¤ì˜ í”Œë ˆì´ë¥¼ ê´€ì „í•©ë‹ˆë‹¤.";
            return;
        }

        if (state.isActive) {
            // ë¬¸ì œ ì¶œì œ ì¤‘
            document.getElementById('question-text').innerText = state.currentQuestion.text;
            document.getElementById('student-answering').classList.remove('hidden');
            document.querySelectorAll('.answer-buttons button').forEach(btn => btn.disabled = false);
            
            // íƒ€ì´ë¨¸ ì¬ì‹œì‘ (ë™ê¸°í™”)
            const remainingTime = Math.max(0, state.currentQuestion.timer - Math.floor((Date.now() - state.answerTime) / 1000));
            startTimer(remainingTime, 'student');
            
        } else if (state.showResult) {
            // ê²°ê³¼ í‘œì‹œ ì¤‘
            showResultScreen(state.isCurrentUserCorrect, state.isLifeGained, state.currentQuestion);
            
        } else {
            // ëŒ€ê¸° ì¤‘
            document.getElementById('student-waiting').classList.remove('hidden');
        }
    }
    
    // [MODIFIED] Firebaseì— ë‹µë³€ ì—…ë°ì´íŠ¸
    function submitAnswer(answer) {
        if (currentUser.lives <= 0 || !currentGameState.isActive) return;
        
        currentUser.answered = answer; 
        
        // Firebaseì— ë‹µë³€ í•„ë“œë§Œ ì—…ë°ì´íŠ¸
        database.ref(`quizGame/students/${currentUser.id}/answered`).set(answer);
        
        playSound(400 + Math.random() * 200, 0.1);
        
        // ë²„íŠ¼ ì‹œê°ì  í”¼ë“œë°± (ë¡œì»¬ì—ì„œë§Œ ì²˜ë¦¬)
        document.querySelectorAll('.answer-buttons button').forEach(btn => {
            btn.style.borderColor = '#000'; 
            btn.style.boxShadow = (btn.classList.contains('o-btn') ? '10px 10px 0px #000' : '10px 10px 0px #000');
        });
        if (answer === 'O') {
            document.querySelector('.o-btn').style.borderColor = '#ffea00';
            document.querySelector('.o-btn').style.boxShadow = '10px 10px 0px #ffea00';
        } else if (answer === 'X') {
            document.querySelector('.x-btn').style.borderColor = '#ffea00';
            document.querySelector('.x-btn').style.boxShadow = '10px 10px 0px #ffea00';
        }
    }
    
    function updateComboDisplay() {
        const comboIndicator = document.getElementById('combo-indicator');
        const comboCount = document.getElementById('combo-count');
        
        if (currentUser && currentUser.combo > 1) { 
            comboCount.textContent = currentUser.combo;
            comboIndicator.classList.remove('hidden');
        } else {
            comboIndicator.classList.add('hidden');
        }
    }


    // ----------------------------------------------------------------------
    // 6. Teacher Logic (Firebase Write Operations)
    // ----------------------------------------------------------------------

    // [MODIFIED] ì„ ìƒë‹˜ ë·° ì—…ë°ì´íŠ¸
    function updateTeacherView() {
        const state = currentGameState;
        document.getElementById('question-index').innerText = state.questionIndex;
        
        if (state.isActive) {
            document.getElementById('teacher-preparation').classList.add('hidden');
            document.getElementById('teacher-live-quiz').classList.remove('hidden');
            document.getElementById('current-question').innerText = `[#${state.questionIndex}] ${state.currentQuestion.text}`;

            // íƒ€ì´ë¨¸ ì¬ì‹œì‘ (ë™ê¸°í™”)
            const remainingTime = Math.max(0, state.currentQuestion.timer - Math.floor((Date.now() - state.answerTime) / 1000));
            startTimer(remainingTime, 'teacher');
            
        } else {
            document.getElementById('teacher-preparation').classList.remove('hidden');
            document.getElementById('teacher-live-quiz').classList.add('hidden');
        }
    }

    // [MODIFIED] Firebaseì— ë¬¸ì œ ì¶œì œ ë°ì´í„° ì—…ë°ì´íŠ¸
    async function sendQuestion() {
        const comboThreshold = parseInt(document.getElementById('combo-life-threshold').value) || 5;
        const text = document.getElementById('question-input').value;
        const timer = parseInt(document.getElementById('timer-select').value);
        const answer = document.getElementById('correct-answer').value;

        if (!text) {
            alert('ë¬¸ì œë¥¼ ì…ë ¥í•´ì•¼ ì¶œì œí•  ìˆ˜ ìˆì–´ìš”!');
            return;
        }
        
        // ì´ì „ í€´ì¦ˆê°€ ì§„í–‰ ì¤‘ì´ì—ˆë‹¤ë©´ ê²°ê³¼ë¥¼ ë¨¼ì € ì²˜ë¦¬
        if (currentGameState.isActive && timerInterval) {
            clearInterval(timerInterval);
            await processResults(); 
        }

        const newQuestionIndex = currentGameState.questionIndex + 1;
        
        // í•™ìƒë“¤ì˜ ë‹µë³€ ìƒíƒœ ì´ˆê¸°í™” (answered í•„ë“œë§Œ)
        const updates = {};
        studentList.forEach(student => {
            if (student.lives > 0) {
                 updates[student.id + '/answered'] = null;
            }
        });
        await studentRef.update(updates);

        // ìƒˆë¡œìš´ ê²Œì„ ìƒíƒœ (isActive: true)ë¥¼ Firebaseì— ì—…ë°ì´íŠ¸
        await stateRef.set({
            questionIndex: newQuestionIndex,
            currentQuestion: { text, timer, answer },
            isActive: true,
            showResult: false,
            answerTime: Date.now(), // í˜„ì¬ ì‹œê°„ì„ ê¸°ë¡í•˜ì—¬ ë™ê¸°í™”
            comboThreshold: comboThreshold
        });
    }

    // [MODIFIED] Firebaseì—ì„œ ëª¨ë“  ê²Œì„ ë°ì´í„° ì‚­ì œ (ì´ˆê¸°í™”)
    function resetGameData() {
        const confirmReset = confirm('ğŸš¨ ê²½ê³ : í˜„ì¬ ì €ì¥ëœ ëª¨ë“  í•™ìƒ ì •ë³´ì™€ ê²Œì„ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if (confirmReset) {
            gameRef.remove()
                .then(() => {
                    alert('âœ… ê²Œì„ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
                    location.reload(); 
                })
                .catch(error => {
                    alert('âŒ ë°ì´í„° ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
                });
        }
    }

    // ----------------------------------------------------------------------
    // 7. Core Game Logic (Results Processing)
    // ----------------------------------------------------------------------

    // [MODIFIED] ìµœì¢… ê²°ê³¼ ì²˜ë¦¬ ë° Firebase ìƒíƒœ ì—…ë°ì´íŠ¸
    async function processResults(isForced = false) {
        // ì´ë¯¸ ê²°ê³¼ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆê±°ë‚˜, ê²Œì„ì´ ë¹„í™œì„±í™” ìƒíƒœë©´ ì¤‘ì§€
        if (currentGameState.showResult || !currentGameState.isActive) return;
        
        clearInterval(timerInterval);
        
        const correctAnswer = currentGameState.currentQuestion.answer;
        const comboThreshold = currentGameState.comboThreshold;
        
        const studentUpdates = {};
        let isCurrentUserCorrect = false;
        let isLifeGained = false;

        studentList.forEach(student => {
            if (student.lives > 0) { 
                if (student.answered === correctAnswer && !isForced) {
                    // ì •ë‹µ ì²˜ë¦¬: ì½¤ë³´ ì¦ê°€, ëª©ìˆ¨ ë³´ë„ˆìŠ¤
                    student.combo = (student.combo || 0) + 1;
                    
                    if (comboThreshold > 0 && (student.combo % comboThreshold === 0)) {
                         student.lives++; 
                         if (student.id === currentUser?.id) isLifeGained = true;
                    }
                    
                    if (student.id === currentUser?.id) isCurrentUserCorrect = true;
                } else {
                    // ì˜¤ë‹µ ë˜ëŠ” ë¬´ì‘ë‹µ ì²˜ë¦¬: ëª©ìˆ¨ ì°¨ê°, ì½¤ë³´ ì´ˆê¸°í™”
                    student.lives--;
                    student.combo = 0;
                }
                
                // ì—…ë°ì´íŠ¸í•  í•™ìƒ ì •ë³´ ê¸°ë¡
                studentUpdates[student.id] = {
                    lives: student.lives,
                    combo: student.combo,
                    answered: student.answered
                };
            }
        });

        // 1. Firebaseì— í•™ìƒ ëª©ë¡ ì—…ë°ì´íŠ¸
        await studentRef.update(studentUpdates);

        // 2. Firebaseì— ê²°ê³¼ í™”ë©´ ì „í™˜ ìƒíƒœ ì—…ë°ì´íŠ¸
        await stateRef.update({
            isActive: false,
            showResult: true,
            isCurrentUserCorrect: isCurrentUserCorrect, // í•™ìƒ ë·° í”¼ë“œë°±ìš©
            isLifeGained: isLifeGained // í•™ìƒ ë·° í”¼ë“œë°±ìš©
        });
        
        // 3ì´ˆ í›„ ë‹¤ìŒ ë¬¸ì œ ëŒ€ê¸° ìƒíƒœë¡œ ìë™ ì „í™˜ (ì„ ìƒë‹˜ ë·°ì—ì„œë§Œ ì‹¤í–‰)
        if (!document.getElementById('teacher-view').classList.contains('hidden')) {
            setTimeout(() => {
                stateRef.update({ showResult: false }); // ê²°ê³¼ í™”ë©´ ì¢…ë£Œ
            }, 3000);
        }
    }

    // [MODIFIED] ê²°ê³¼ í™”ë©´ í‘œì‹œ (DB ìƒíƒœë¥¼ ì½ì–´ì™€ì„œ í‘œì‹œ)
    function showResultScreen(isCorrect, isLifeGained, question) { 
        const resultScreen = document.getElementById('result-screen');
        const resultEmoji = document.getElementById('result-emoji');
        const resultMessage = document.getElementById('result-message');
        
        // UI ë³€ê²½ ì „ì— ëŒ€ê¸°/ì •ë‹µ ë·° ìˆ¨ê¸°ê¸°
        document.querySelectorAll('.quiz-state').forEach(el => el.classList.add('hidden'));
        document.getElementById('student-result').classList.remove('hidden');

        if (isCorrect) {
            resultScreen.className = 'correct-result';
            resultEmoji.textContent = 'ğŸ‰';
            let msg = `<span style="color: #fff; font-size: 2em;">ì •ë‹µ!</span>`;
            
            if (isLifeGained) {
                 msg += `<br><span style="color: #ffea00; font-size: 1.5em;">â­ëª©ìˆ¨ +1 ë³´ë„ˆìŠ¤! (${currentGameState.comboThreshold}ì½¤ë³´)</span>`;
            }
            resultMessage.innerHTML = msg;
            playSound(523, 0.2);
            playSound(659, 0.2);
        } else {
            resultScreen.className = 'wrong-result';
            resultEmoji.textContent = 'ğŸ’¥';
            resultMessage.innerHTML = `<span style="color: #fff; font-size: 2em;">í‹€ë ¸ì–´ìš”! ì •ë‹µì€ [${question.answer}]</span>`;
            playSound(200, 0.3);
        }
    }
    
    // [MODIFIED] í•™ìƒ ë‹µë³€ í˜„í™© ì—…ë°ì´íŠ¸ (ë¦¬ìŠ¤ë„ˆë¥¼ í†µí•´ ìë™ìœ¼ë¡œ í˜¸ì¶œë¨)
    function updateQuizAreaViews() {
        const oStudents = studentList.filter(s => s.lives > 0 && s.answered === 'O');
        const xStudents = studentList.filter(s => s.lives > 0 && s.answered === 'X');
        
        // ì„ ìƒë‹˜ ë·° ì—…ë°ì´íŠ¸
        updateQuizArea(document.getElementById('o-answers'), oStudents);
        updateQuizArea(document.getElementById('x-answers'), xStudents);
        document.getElementById('o-count').innerText = oStudents.length;
        document.getElementById('x-count').innerText = xStudents.length;
        
        // ê´€ì „ ëª¨ë“œ ì—…ë°ì´íŠ¸
        if (currentUser && currentUser.lives <= 0) {
            updateQuizArea(document.getElementById('o-answers-spectator'), oStudents);
            updateQuizArea(document.getElementById('x-answers-spectator'), xStudents);
            document.querySelector('.o-count-spectator').innerText = oStudents.length;
            document.querySelector('.x-count-spectator').innerText = xStudents.length;
        }
    }

    // (Helper: ì•„ë°”íƒ€ ì• ë‹ˆë©”ì´ì…˜ ë¡œì§ì€ ê·¸ëŒ€ë¡œ ìœ ì§€)
    function updateQuizArea(container, students) { /* ... */
        const existingAvatars = Array.from(container.querySelectorAll('.student-avatar'));
        const existingAvatarMap = new Map(existingAvatars.map(el => [el.dataset.id, el]));
        const studentIdsInContainer = new Set(students.map(s => s.id));

        existingAvatars.forEach(avatar => {
            if (!studentIdsInContainer.has(avatar.dataset.id)) {
                avatar.style.opacity = '0';
                avatar.style.transform = 'scale(0)';
                setTimeout(() => avatar.remove(), 500); 
            }
        });

        students.forEach(student => {
            let avatar = existingAvatarMap.get(student.id);
            if (!avatar) {
                avatar = document.createElement('div');
                avatar.className = `student-avatar`;
                avatar.dataset.id = student.id;
                avatar.innerHTML = `${student.emoji} ${student.nickname.split(' ')[0]}`;
                container.appendChild(avatar);
                setTimeout(() => {
                    avatar.style.opacity = '1';
                    avatar.style.transform = 'scale(1)';
                }, 10);
            } else {
                container.appendChild(avatar); 
                avatar.innerHTML = `${student.emoji} ${student.nickname.split(' ')[0]}`; 
                avatar.classList.toggle('spectator-mode', student.lives <= 0);
            }
        });
    }

    // ----------------------------------------------------------------------
    // 8. Timer & End Game Logic
    // ----------------------------------------------------------------------

    function startTimer(seconds, role) {
        if (timerInterval) clearInterval(timerInterval);

        let timeLeft = seconds;
        const timerElement = (role === 'teacher') ? document.getElementById('timer-value') : document.getElementById('student-timer-value');
        
        timerElement.innerText = timeLeft;

        timerInterval = setInterval(() => {
            timeLeft--;
            timerElement.innerText = timeLeft;

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                if (role === 'teacher') {
                    // íƒ€ì´ë¨¸ ì¢…ë£Œ ì‹œ ê²°ê³¼ ì²˜ë¦¬ ìš”ì²­
                    processResults(); 
                }
            }
        }, 1000);
    }
    
    // [MODIFIED] ê°•ì œ ì¢…ë£Œ ì‹œ ê²°ê³¼ ì²˜ë¦¬ ë° ìµœì¢… ìˆœìœ„ í‘œì‹œ
    function endGame() {
        // ê²°ê³¼ë¥¼ ì²˜ë¦¬í•˜ê³  isActiveë¥¼ falseë¡œ ì—…ë°ì´íŠ¸
        processResults(true); 
        
        let survivingStudents = studentList.filter(s => s.lives > 0);
        
        let rankingMessage = '';

        if (survivingStudents.length > 0) {
            survivingStudents.sort((a, b) => b.combo - a.combo);
            
            const topStudent = survivingStudents[0];
            let winnerMessage = `ğŸ† MVP (ìµœê³  ì½¤ë³´): ${topStudent.emoji} ${topStudent.nickname} (${topStudent.combo} ì½¤ë³´)`;
            
            rankingMessage = survivingStudents.slice(0, 5).map((s, i) => 
                `${i+1}ìœ„: ${s.emoji} ${s.nickname} (ìµœëŒ€ ì½¤ë³´: ${s.combo})`
            ).join('\n');

            alert(`ğŸ‰ ê²Œì„ ì¢…ë£Œ!\n\n${winnerMessage}\n\nğŸ“Š ìµœì¢… ìˆœìœ„:\n${rankingMessage}`);
        } else {
            alert(`ğŸ˜¢ ì•„ì‰½ì§€ë§Œ ìƒì¡´ìê°€ ì—†ìŠµë‹ˆë‹¤. ê²Œì„ ì¢…ë£Œ!`);
        }

        // ê²Œì„ ìƒíƒœë¥¼ ì´ˆê¸°í™”(ëŒ€ê¸° ëª¨ë“œ)
        stateRef.update({ isActive: false, showResult: false });
        
        // í•™ìƒ ë·° ì—…ë°ì´íŠ¸ëŠ” ë¦¬ìŠ¤ë„ˆê°€ ì²˜ë¦¬
    }
    
    // (Helper: Sound)
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(frequency, duration) {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration);
    }
</script>

</body>

</html>
