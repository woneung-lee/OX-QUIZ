<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Roblox MAX! OX Quiz - Real-time Visualization</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Bangers&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <style>
        /* ---------------------- 1. Roblox Global Style (ê¸€ê¼´ ê°œì„ ) ---------------------- */
        body { 
            font-family: 'Bangers', cursive; /* ë³¸ë¬¸ ê¸€ê¼´ */
            margin: 0; 
            padding: 20px; 
            /* ë¡œë¸”ë¡ìŠ¤ ì”ë”” ë¸”ë¡ ëŠë‚Œ ë°°ê²½ */
            background-color: #64dd17; 
            background-image: 
                linear-gradient(45deg, rgba(0,0,0,0.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.1) 75%, rgba(0,0,0,0.1)),
                linear-gradient(45deg, rgba(0,0,0,0.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.1) 75%, rgba(0,0,0,0.1));
            background-size: 50px 50px; 
            background-position: 0 0, 25px 25px; 
            color: #212121; 
        }
        #app { 
            max-width: 1000px; /* ë„ˆë¹„ í™•ì¥ */
            margin: 20px auto; 
            padding: 40px; 
            background: #ffffff; 
            border: 8px solid #303030; 
            border-radius: 15px; 
            box-shadow: 15px 15px 0px #303030; 
            position: relative;
            z-index: 10;
        }
        h2, h3, h4 { 
            font-family: 'Press Start 2P', cursive; /* í—¤ë“œë¼ì¸ ê¸€ê¼´ */
            color: #000000; 
            text-align: center;
            text-shadow: 3px 3px 0px #ffea00; 
            margin-bottom: 25px;
        }
        h2 { font-size: 2.5em; }
        h3 { font-size: 2em; }
        h4 { font-size: 1.5em; }

        /* ---------------------- 2. Block Button Style (ë™ì¼) ---------------------- */
        button, .block-button { 
            font-family: 'Press Start 2P', cursive;
            padding: 18px 30px; 
            margin: 10px; 
            border: 5px solid #000000; 
            border-radius: 8px; 
            font-size: 1.2em; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 6px 6px 0px #000000; 
            transition: all 0.1s;
            text-shadow: 2px 2px 0 #000;
            color: white;
            background-color: #3498db; 
            letter-spacing: 1px;
        }
        button:active, .block-button:active {
            box-shadow: 2px 2px 0px #000000;
            transform: translate(4px, 4px); 
        }
        .green-button { background-color: #2ecc71; } 
        .red-button { background-color: #e74c3c; } 
        .yellow-button { background-color: #f1c40f; color: #000; text-shadow: none; } 

        /* ---------------------- 3. Layout and Elements (ì‹œê°í™” ìˆ˜ì •) ---------------------- */
        .hidden { display: none !important; }
        .centered { text-align: center; }
        input, select, label { font-family: 'Bangers', cursive; }
        label { font-family: 'Press Start 2P', cursive; }

        /* ë¼ì´ë¸Œ í€´ì¦ˆ í•„ë“œ ì»¨í…Œì´ë„ˆ */
        .quiz-field-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
        }

        /* 1. ìš´ë™ì¥ ë°– (Unanswered Area) */
        #unanswered-area, #unanswered-area-spectator {
            width: 95%; 
            min-height: 80px;
            background-color: #f39c12; /* ë…¸ë€ìƒ‰ ê²½ê³„ì„  ëŠë‚Œ */
            border: 4px solid #000;
            border-radius: 10px;
            margin-bottom: 20px;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-content: center;
            justify-content: center;
            box-shadow: 6px 6px 0px #000;
        }

        /* 2. O/X ìš´ë™ì¥ */
        .result-box { 
            display: flex; 
            justify-content: space-between; 
            width: 95%; /* ì „ì²´ ë„ˆë¹„ */
            margin-top: 0; 
        }
        .o-area, .x-area { 
            flex-basis: 49%; /* ê³µê°„ ë¶„í•  */
            padding: 15px; 
            border: 6px solid #000; 
            border-radius: 12px; 
            min-height: 250px; 
            box-shadow: 8px 8px 0px #000;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 10px; 
        }
        .o-area { background-color: #4CAF50; } 
        .x-area { background-color: #F44336; } 
        
        /* ì•„ë°”íƒ€ (ì´ë™ íš¨ê³¼) */
        .student-avatar { 
            /* ... ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ ... */
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); /* ë¶€ë“œëŸ¬ìš´ ì´ë™ */
            background: #ffffff; 
            font-family: 'Bangers', cursive;
        }
        
        /* ë°°ì§€ ìŠ¤íƒ€ì¼ ì¡°ì • */
        .count-badge {
            font-family: 'Press Start 2P', cursive;
            font-size: 2em;
        }
    </style>
</head>
<body>

<div id="app">
    <div id="initial-screen" class="centered">
        <h2>ğŸš€ Roblox í€´ì¦ˆ ìŠ¤íƒ€íŠ¸! ğŸš€</h2>
        <button class="block-button yellow-button" onclick="showTeacherLogin()">ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ìœ¼ë¡œ ì ‘ì†</button>
        <button class="block-button yellow-button" onclick="showStudentLogin()">ğŸ‘§ğŸ‘¦ í•™ìƒìœ¼ë¡œ ì ‘ì†</button>
        <p style="font-family: sans-serif; font-size: 0.8em; color: gray;">
            (Firebaseë¥¼ í†µí•´ ì‹¤ì‹œê°„ ë™ê¸°í™”ë©ë‹ˆë‹¤.)
        </p>
    </div>
    
    <div id="teacher-login-screen" class="hidden centered">
        <h3>ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h3>
        <input type="password" id="teacher-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
        <button class="block-button yellow-button" onclick="teacherLogin()">ë¡œê·¸ì¸</button>
    </div>

    <div id="teacher-view" class="hidden">
        <h3>ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ ê´€ë¦¬ ë¸”ë¡ (ë¬¸ì œ #<span id="question-index">0</span>)</h3>
        <button class="block-button red-button" onclick="resetGameData()" style="margin-bottom: 20px;">
            ğŸ”„ ë°ì´í„° ì´ˆê¸°í™” (ì „ì²´ ì‚­ì œ)
        </button>
        
        <div id="teacher-preparation" class="centered">
            <input type="hidden" id="game-mode" value="individual"> 
            
            <label for="combo-life-threshold">ì¶”ê°€ ëª©ìˆ¨ íšë“ ì½¤ë³´ íšŸìˆ˜:</label>
            <input type="number" id="combo-life-threshold" value="5" min="2" max="10" placeholder="ì½¤ë³´ íšŸìˆ˜ (ê¸°ë³¸ 5)">

            <label for="question-input">ë¬¸ì œ ì…ë ¥:</label>
            <input type="text" id="question-input" placeholder="ğŸ’¡ O/X í€´ì¦ˆ ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <label for="timer-select">ì œí•œ ì‹œê°„ (ì´ˆ):</label>
            <input type="number" id="timer-select" value="10" min="5" max="30" placeholder="ì œí•œ ì‹œê°„ (ì´ˆ)">
            <label for="correct-answer">ì •ë‹µ ì„¤ì •:</label>
            <select id="correct-answer">
                <option value="O">O</option>
                <option value="X">X</option>
            </select>
            <button class="block-button green-button" onclick="sendQuestion()">âš¡ ë¬¸ì œ ì¶œì œ ë° í€´ì¦ˆ ì‹œì‘ (ë‹¤ìŒ ë¬¸ì œ)</button>
        </div>

        <div id="teacher-live-quiz" class="hidden">
            <h4>ğŸš¨ LIVE í€´ì¦ˆ: <span id="current-question"></span></h4>
            <div id="timer-display">TIME: <span id="timer-value">10</span></div>
            
            <div class="quiz-field-container">
                <div id="unanswered-area" class="unanswered-area">
                    <span style="font-family: 'Press Start 2P', cursive; font-size: 1.2em; color: #303030;">[ìš´ë™ì¥ ë°–] ì•„ì§ ë‹µë³€í•˜ì§€ ì•Šì€ ì•„ë°”íƒ€ê°€ ì—¬ê¸°ì— ìˆìŠµë‹ˆë‹¤.</span>
                </div>
                <div class="result-box">
                    <div class="o-area">
                        <div class="count-badge">O: <span id="o-count">0</span></div>
                        <div id="o-answers" class="answer-list"></div>
                    </div>
                    <div class="x-area">
                        <div class="count-badge">X: <span id="x-count">0</span></div>
                        <div id="x-answers" class="answer-list"></div>
                    </div>
                </div>
            </div>
            <button class="block-button red-button" onclick="endGame()">ğŸ’£ ê²Œì„ ê°•ì œ ì¢…ë£Œ (ìµœì¢… ìŠ¹ë¦¬ì ë°œí‘œ)</button>
        </div>
    </div>

    <div id="student-login" class="hidden centered">
        <h3>ğŸ‘¤ ì•„ë°”íƒ€ ì„¤ì • ë¸”ë¡</h3>
        <input type="text" id="student-nickname" placeholder="â­ ë‹‰ë„¤ì„ ì…ë ¥">
        <label for="emoji-select">ë™ë¬¼ ì´ëª¨ì§€ ì„ íƒ:</label>
        <select id="emoji-select">
            <option value="ğŸ¦">ğŸ¦ ì‚¬ì</option>
            <option value="ğŸ°">ğŸ° í† ë¼</option>
            <option value="ğŸ¶">ğŸ¶ ê°•ì•„ì§€</option>
            <option value="ğŸ»">ğŸ» ê³°</option>
            <option value="ğŸ¦Š">ğŸ¦Š ì—¬ìš°</option>
            <option value="ğŸ¼">ğŸ¼ íŒë‹¤</option>
            <option value="ğŸ¯">ğŸ¯ í˜¸ë‘ì´</option>
            <option value="ğŸ¨">ğŸ¨ ì½”ì•Œë¼</option>
            <option value="ğŸµ">ğŸµ ì›ìˆ­ì´</option>
            <option value="ğŸ¸">ğŸ¸ ê°œêµ¬ë¦¬</option>
            <option value="ğŸ§">ğŸ§ í­ê·„</option>
            <option value="ğŸ¦‰">ğŸ¦‰ ë¶€ì—‰ì´</option>
            <option value="ğŸ¦†">ğŸ¦† ì˜¤ë¦¬</option>
            <option value="ğŸ™">ğŸ™ ë¬¸ì–´</option>
            <option value="ğŸ¦€">ğŸ¦€ ê²Œ</option>
            <option value="ğŸ¢">ğŸ¢ ê±°ë¶ì´</option>
        </select>
        <button class="block-button yellow-button" onclick="loginStudent()">â–¶ï¸ í€´ì¦ˆë°© ì…ì¥</button>
    </div>

    <div id="student-view" class="hidden">
        <h3 id="student-info" class="centered"></h3>
        <p id="student-lives">â¤ï¸ ëª©ìˆ¨: 3</p>
        <div id="life-rule-info"></div>
        <div id="combo-indicator" class="combo-display hidden">
            ğŸ”¥ <span id="combo-count">0</span> COMBO!
        </div>

        <div id="student-waiting" class="quiz-state centered">
            <h4 class="red-button" style="background-color: #3498db; border-color: #2c3e50; display: inline-block;">
                ğŸ“¢ ì„ ìƒë‹˜ì´ ë¸”ë¡ì„ ì¡°ë¦½ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!
            </h4>
        </div>

        <div id="student-answering" class="quiz-state hidden centered">
            <h4 id="question-text" style="font-size: 1.8em; border-bottom: 5px solid #f39c12; padding-bottom: 10px;"></h4>
            <div id="student-timer-display">TIME: <span id="student-timer-value">10</span></div>
            <div class="answer-buttons">
                <button class="o-btn green-button" onclick="submitAnswer('O')">O</button>
                <button class="x-btn red-button" onclick="submitAnswer('X')">X</button>
            </div>
            
            <h4 style="margin-top: 30px; margin-bottom: 10px;">ğŸ‘€ ì‹¤ì‹œê°„ ë‹µë³€ í˜„í™©</h4>
            <div id="live-answer-spectator" class="quiz-field-container">
                <div id="unanswered-area-spectator" class="unanswered-area" style="background-color: #bbdefb;">
                     <span style="font-family: 'Press Start 2P', cursive; font-size: 1.2em; color: #303030;">[ëŒ€ê¸°] ì•„ì§ ë‹µë³€í•˜ì§€ ì•Šì€ ì•„ë°”íƒ€</span>
                </div>
                <div class="result-box">
                    <div class="o-area">
                        <div class="count-badge">O: <span class="o-count-spectator">0</span></div>
                        <div id="o-answers-spectator" class="answer-list"></div>
                    </div>
                    <div class="x-area">
                        <div class="count-badge">X: <span class="x-count-spectator">0</span></div>
                        <div id="x-answers-spectator" class="answer-list"></div>
                    </div>
                </div>
            </div>
            </div>

        <div id="student-result" class="quiz-state hidden centered">
            <div id="result-screen">
                <div class="result-emoji" id="result-emoji">âœ¨</div>
                <h4 id="result-message"></h4>
            </div>
        </div>
    </div>
</div>

<script>
    // ----------------------------------------------------------------------
    // ğŸ“¢ 1. Firebase ì„¤ì • (í•„ìˆ˜ ìˆ˜ì • ì˜ì—­) ğŸ“¢
    // ----------------------------------------------------------------------
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY", // ì‚¬ìš©ìë‹˜ì˜ API Keyë¡œ êµì²´í•˜ì„¸ìš”.
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        databaseURL: "https://YOUR-PROJECT-ID-default-rtdb.firebaseio.com", // í”„ë¡œì íŠ¸ Realtime DB URLë¡œ êµì²´í•˜ì„¸ìš”.
        projectId: "YOUR-PROJECT-ID",
        storageBucket: "YOUR-PROJECT_ID.appspot.com",
        messagingSenderId: "...",
        appId: "..."
    };

    // Firebase ì´ˆê¸°í™”
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const gameRef = database.ref('quizGame');
    const studentRef = database.ref('quizGame/students');
    const stateRef = database.ref('quizGame/state');
    
    // ----------------------------------------------------------------------
    // 2. ì „ì—­ ë³€ìˆ˜ ë° ìƒìˆ˜
    // ----------------------------------------------------------------------
    const TEACHER_PASSWORD = 'teacher1234'; // ì„ ìƒë‹˜ ë¹„ë°€ë²ˆí˜¸
    let currentUser = null; 
    let currentGameState = {}; 
    let studentList = []; 
    let timerInterval = null;
    
    // (Helper: Sound)
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(frequency, duration) {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration);
    }
    
    // ----------------------------------------------------------------------
    // 3. View Management (ë™ì¼)
    // ----------------------------------------------------------------------
    function hideAll() {
        document.getElementById('initial-screen').classList.add('hidden');
        document.getElementById('teacher-login-screen').classList.add('hidden');
        document.getElementById('teacher-view').classList.add('hidden');
        document.getElementById('student-login').classList.add('hidden');
        document.getElementById('student-view').classList.add('hidden');
    }

    function showTeacherLogin() {
        hideAll();
        document.getElementById('teacher-login-screen').classList.remove('hidden');
    }
    
    function teacherLogin() {
        const password = document.getElementById('teacher-password').value;
        if (password === TEACHER_PASSWORD) {
            showTeacherView();
        } else {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
            document.getElementById('teacher-password').value = '';
        }
    }

    function showTeacherView() {
        hideAll();
        document.getElementById('teacher-view').classList.remove('hidden');
    }

    function showStudentLogin() {
        hideAll();
        document.getElementById('student-login').classList.remove('hidden');
    }

    function showStudentView() {
        hideAll();
        document.getElementById('student-view').classList.remove('hidden');
        if(currentGameState.comboThreshold) {
             updateLifeRuleInfo(currentGameState.comboThreshold);
        }
    }
    
    function updateLifeRuleInfo(threshold) {
        const infoElement = document.getElementById('life-rule-info');
        if (threshold > 0) {
            infoElement.innerHTML = `âš ï¸ ê·œì¹™: **${threshold}ì—°ì† ì •ë‹µ** ì‹œ â¤ï¸ ëª©ìˆ¨ +1 ë³´ë„ˆìŠ¤!`;
            infoElement.classList.remove('hidden');
        } else {
            infoElement.classList.add('hidden');
        }
    }
    
    // ----------------------------------------------------------------------
    // 4. Firebase Data Listeners (ì‹¤ì‹œê°„ ë™ê¸°í™”)
    // ----------------------------------------------------------------------
    
    stateRef.on('value', (snapshot) => {
        currentGameState = snapshot.val() || { questionIndex: 0, isActive: false, comboThreshold: 5, showResult: false };
        
        updateLifeRuleInfo(currentGameState.comboThreshold);

        if (!document.getElementById('teacher-view').classList.contains('hidden')) {
            updateTeacherView(); // ì„ ìƒë‹˜ ë·° ì—…ë°ì´íŠ¸
        }

        if (currentUser && !document.getElementById('student-view').classList.contains('hidden')) {
             updateStudentStateFromDB(); // í•™ìƒ ë·° ì—…ë°ì´íŠ¸
        }
    });
    
    studentRef.on('value', (snapshot) => {
        const students = snapshot.val();
        studentList = students ? Object.values(students) : [];
        
        // **[MODIFIED]** í•™ìƒ ìœ„ì¹˜ ì‹œê°í™” (ì„ ìƒë‹˜/í•™ìƒ ê³µí†µ)
        updateQuizAreaViews();
        
        // í˜„ì¬ ì ‘ì†í•œ í•™ìƒì˜ ë¡œì»¬ ì •ë³´ ì—…ë°ì´íŠ¸
        if (currentUser) {
            const updatedUser = studentList.find(s => s.id === currentUser.id);
            if (updatedUser) {
                currentUser = updatedUser;
                document.getElementById('student-lives').innerText = `â¤ï¸ ëª©ìˆ¨: ${currentUser.lives}`;
                updateComboDisplay();
            }
        }
    });

    // ----------------------------------------------------------------------
    // 5. Student Logic
    // ----------------------------------------------------------------------

    async function loginStudent() {
        // ... (ë¡œê·¸ì¸ ë¡œì§ ë™ì¼)
        const nickname = document.getElementById('student-nickname').value;
        const emoji = document.getElementById('emoji-select').value;
        if (!nickname) {
            alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì•¼ ê²Œì„ì„ ì‹œì‘í•  ìˆ˜ ìˆì–´ìš”!');
            return;
        }

        let existingUser = studentList.find(s => s.nickname === nickname);
        let studentId;
        
        if (existingUser) {
            studentId = existingUser.id;
            currentUser = existingUser;
            currentUser.emoji = emoji; 
        } else {
            studentId = 's_' + Date.now();
            currentUser = { 
                id: studentId, 
                nickname, 
                emoji, 
                lives: 3, 
                answered: null,
                combo: 0
            };
        }
        
        await database.ref(`quizGame/students/${studentId}`).update(currentUser);

        document.getElementById('student-info').innerHTML = `${currentUser.emoji} **${currentUser.nickname}**ë‹˜, í™˜ì˜í•´ìš”!`;
        showStudentView();
    }
    
    // [MODIFIED] DB ìƒíƒœì— ë”°ë¼ í•™ìƒ ë·° ì „í™˜
    function updateStudentStateFromDB() {
        const state = currentGameState;
        document.querySelectorAll('.quiz-state').forEach(el => el.classList.add('hidden'));

        if (!currentUser || currentUser.lives <= 0) {
            document.getElementById('student-result').classList.remove('hidden');
            document.getElementById('result-message').innerHTML = "ğŸ’¥ **YOU LOSE!** ğŸ’¥ ì´ì œ ì¹œêµ¬ë“¤ì˜ í”Œë ˆì´ë¥¼ ê´€ì „í•©ë‹ˆë‹¤.";
            return;
        }

        if (state.isActive) {
            // ë¬¸ì œ ì¶œì œ ì¤‘: ë‹µë³€ í™”ë©´ ë° ì‹¤ì‹œê°„ í˜„í™© í‘œì‹œ
            document.getElementById('question-text').innerText = state.currentQuestion.text;
            document.getElementById('student-answering').classList.remove('hidden');
            document.querySelectorAll('.answer-buttons button').forEach(btn => btn.disabled = false);
            
            const remainingTime = Math.max(0, state.currentQuestion.timer - Math.floor((Date.now() - state.answerTime) / 1000));
            startTimer(remainingTime, 'student');
            
        } else if (state.showResult) {
            // ê²°ê³¼ í‘œì‹œ ì¤‘
            showResultScreen(state.isCurrentUserCorrect, state.isLifeGained, state.currentQuestion);
            
        } else {
            // ëŒ€ê¸° ì¤‘
            document.getElementById('student-waiting').classList.remove('hidden');
        }
        
        // í˜„ì¬ ë‹µë³€ ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ (ì„ íƒëœ ë‹µ ê°•ì¡°)
        document.querySelectorAll('.answer-buttons button').forEach(btn => {
            btn.style.borderColor = '#000'; 
            btn.style.boxShadow = (btn.classList.contains('o-btn') ? '10px 10px 0px #000' : '10px 10px 0px #000');
        });
        if (currentUser.answered === 'O') {
            document.querySelector('.o-btn').style.borderColor = '#ffea00';
            document.querySelector('.o-btn').style.boxShadow = '10px 10px 0px #ffea00';
        } else if (currentUser.answered === 'X') {
            document.querySelector('.x-btn').style.borderColor = '#ffea00';
            document.querySelector('.x-btn').style.boxShadow = '10px 10px 0px #ffea00';
        }
    }
    
    function submitAnswer(answer) {
        if (currentUser.lives <= 0 || !currentGameState.isActive) return;
        
        // ë¡œì»¬ ì—…ë°ì´íŠ¸ ë° Firebaseì— ë‹µë³€ í•„ë“œë§Œ ì—…ë°ì´íŠ¸
        currentUser.answered = answer; 
        database.ref(`quizGame/students/${currentUser.id}/answered`).set(answer);
        
        playSound(400 + Math.random() * 200, 0.1);
        
        // ë²„íŠ¼ ì‹œê°ì  í”¼ë“œë°± (ë¡œì»¬ì—ì„œë§Œ ì²˜ë¦¬)
        updateStudentStateFromDB(); // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ì¬í˜¸ì¶œ
    }

    function updateComboDisplay() {
        const comboIndicator = document.getElementById('combo-indicator');
        const comboCount = document.getElementById('combo-count');
        
        if (currentUser && currentUser.combo > 1) { 
            comboCount.textContent = currentUser.combo;
            comboIndicator.classList.remove('hidden');
        } else {
            comboIndicator.classList.add('hidden');
        }
    }


    // ----------------------------------------------------------------------
    // 6. Teacher Logic
    // ----------------------------------------------------------------------

    // [MODIFIED] ì„ ìƒë‹˜ ë·° ì—…ë°ì´íŠ¸ (ë¼ì´ë¸Œ ì‹œê°í™” ì „í™˜)
    function updateTeacherView() {
        const state = currentGameState;
        document.getElementById('question-index').innerText = state.questionIndex;
        
        if (state.isActive) {
            // ë¼ì´ë¸Œ í€´ì¦ˆ í™”ë©´ í‘œì‹œ
            document.getElementById('teacher-preparation').classList.add('hidden');
            document.getElementById('teacher-live-quiz').classList.remove('hidden');
            document.getElementById('current-question').innerText = `[#${state.questionIndex}] ${state.currentQuestion.text}`;

            // íƒ€ì´ë¨¸ ì¬ì‹œì‘ (ë™ê¸°í™”)
            const remainingTime = Math.max(0, state.currentQuestion.timer - Math.floor((Date.now() - state.answerTime) / 1000));
            startTimer(remainingTime, 'teacher');
            
        } else {
            // ëŒ€ê¸° í™”ë©´ í‘œì‹œ
            document.getElementById('teacher-preparation').classList.remove('hidden');
            document.getElementById('teacher-live-quiz').classList.add('hidden');
        }
    }

    async function sendQuestion() {
        const comboThreshold = parseInt(document.getElementById('combo-life-threshold').value) || 5;
        const text = document.getElementById('question-input').value;
        const timer = parseInt(document.getElementById('timer-select').value);
        const answer = document.getElementById('correct-answer').value;

        if (!text) {
            alert('ë¬¸ì œë¥¼ ì…ë ¥í•´ì•¼ ì¶œì œí•  ìˆ˜ ìˆì–´ìš”!');
            return;
        }
        
        if (currentGameState.isActive && timerInterval) {
            clearInterval(timerInterval);
            await processResults(); 
        }

        const newQuestionIndex = currentGameState.questionIndex + 1;
        
        // í•™ìƒë“¤ì˜ ë‹µë³€ ìƒíƒœ ì´ˆê¸°í™” (answered í•„ë“œë§Œ)
        const updates = {};
        studentList.forEach(student => {
            if (student.lives > 0) {
                 updates[student.id + '/answered'] = null; // ë‹µë³€ì„ nullë¡œ ì´ˆê¸°í™” -> ìš´ë™ì¥ ë°–ìœ¼ë¡œ ì´ë™
            }
        });
        await studentRef.update(updates);

        // ìƒˆë¡œìš´ ê²Œì„ ìƒíƒœ (isActive: true)ë¥¼ Firebaseì— ì—…ë°ì´íŠ¸
        await stateRef.set({
            questionIndex: newQuestionIndex,
            currentQuestion: { text, timer, answer },
            isActive: true,
            showResult: false,
            answerTime: Date.now(), 
            comboThreshold: comboThreshold
        });
    }

    function resetGameData() {
        const confirmReset = confirm('ğŸš¨ ê²½ê³ : í˜„ì¬ ì €ì¥ëœ ëª¨ë“  í•™ìƒ ì •ë³´ì™€ ê²Œì„ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if (confirmReset) {
            gameRef.remove()
                .then(() => {
                    alert('âœ… ê²Œì„ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
                    location.reload(); 
                })
                .catch(error => {
                    alert('âŒ ë°ì´í„° ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
                });
        }
    }

    // ----------------------------------------------------------------------
    // 7. Core Game Logic & Visualization
    // ----------------------------------------------------------------------

    // [MODIFIED] í•™ìƒ ë‹µë³€ í˜„í™© ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„ ì‹œê°í™” í•µì‹¬)
    function updateQuizAreaViews() {
        // ìƒì¡´ í•™ìƒ ë¶„ë¥˜: O, X, Unanswered (ìš´ë™ì¥ ë°–)
        const oStudents = studentList.filter(s => s.lives > 0 && s.answered === 'O');
        const xStudents = studentList.filter(s => s.lives > 0 && s.answered === 'X');
        const unansweredStudents = studentList.filter(s => s.lives > 0 && s.answered === null); 
        
        // ì„ ìƒë‹˜ ë·° ì—…ë°ì´íŠ¸ (teacher-live-quizê°€ hiddenì´ ì•„ë‹ ë•Œ)
        if (!document.getElementById('teacher-view').classList.contains('hidden') || currentGameState.isActive) {
            updateQuizArea(document.getElementById('unanswered-area'), unansweredStudents);
            updateQuizArea(document.getElementById('o-answers'), oStudents);
            updateQuizArea(document.getElementById('x-answers'), xStudents);
            document.getElementById('o-count').innerText = oStudents.length;
            document.getElementById('x-count').innerText = xStudents.length;
        }
        
        // í•™ìƒ ë¼ì´ë¸Œ ë‹µë³€ í˜„í™© ì—…ë°ì´íŠ¸ (student-answeringì´ hiddenì´ ì•„ë‹ ë•Œ)
        if (!document.getElementById('student-view').classList.contains('hidden') && currentGameState.isActive) {
             updateQuizArea(document.getElementById('unanswered-area-spectator'), unansweredStudents);
             updateQuizArea(document.getElementById('o-answers-spectator'), oStudents);
             updateQuizArea(document.getElementById('x-answers-spectator'), xStudents);
             document.querySelector('.o-count-spectator').innerText = oStudents.length;
             document.querySelector('.x-count-spectator').innerText = xStudents.length;
        }
        
        // ê´€ì „ ëª¨ë“œ ì—…ë°ì´íŠ¸ (student-resultê°€ hiddenì´ ì•„ë‹ ë•Œ)
        if (!document.getElementById('student-view').classList.contains('hidden') && currentUser && currentUser.lives <= 0) {
             // ê´€ì „ ëª¨ë“œëŠ” ìµœì¢… O/X ê²°ê³¼ë§Œ ë³´ì—¬ì£¼ë¯€ë¡œ unansweredëŠ” ì œì™¸
             updateQuizArea(document.getElementById('o-answers-spectator'), oStudents);
             updateQuizArea(document.getElementById('x-answers-spectator'), xStudents);
             document.querySelector('.o-count-spectator').innerText = oStudents.length;
             document.querySelector('.x-count-spectator').innerText = xStudents.length;
        }
    }

    // [MODIFIED] ì•„ë°”íƒ€ ìƒì„±/ì´ë™ ë¡œì§
    function updateQuizArea(container, students) {
        const existingAvatars = Array.from(container.querySelectorAll('.student-avatar'));
        const existingAvatarMap = new Map(existingAvatars.map(el => [el.dataset.id, el]));
        const studentIdsInContainer = new Set(students.map(s => s.id));
        
        // 1. ì‚¬ë¼ì ¸ì•¼ í•  ì•„ë°”íƒ€ ì œê±°
        existingAvatars.forEach(avatar => {
            if (!studentIdsInContainer.has(avatar.dataset.id)) {
                // ë¶€ë“œëŸ¬ìš´ ì œê±° íš¨ê³¼
                avatar.style.opacity = '0';
                avatar.style.transform = 'scale(0)';
                setTimeout(() => avatar.remove(), 500); 
            }
        });

        // 2. ìƒˆë¡œìš´ ì•„ë°”íƒ€ ìƒì„± ë˜ëŠ” ê¸°ì¡´ ì•„ë°”íƒ€ ì´ë™
        students.forEach(student => {
            let avatar = existingAvatarMap.get(student.id);
            if (!avatar) {
                // ìƒˆë¡œ ìƒì„± (ìš´ë™ì¥ ë°–/O/Xë¡œ ìƒˆë¡œ ì§„ì…)
                avatar = document.createElement('div');
                avatar.className = `student-avatar`;
                avatar.dataset.id = student.id;
                avatar.innerHTML = `${student.emoji} ${student.nickname.split(' ')[0]}`;
                // opacity 0ì—ì„œ ì‹œì‘í•˜ì—¬ ë¶€ë“œëŸ½ê²Œ ë‚˜íƒ€ë‚˜ë„ë¡ ì„¤ì •
                avatar.style.opacity = '0'; 
                avatar.style.transform = 'scale(0.8)';
                container.appendChild(avatar);
                
                // ìƒì„± í›„ ì• ë‹ˆë©”ì´ì…˜ ì ìš©
                setTimeout(() => {
                    avatar.style.opacity = '1';
                    avatar.style.transform = 'scale(1)';
                }, 10);
            } else {
                // ê¸°ì¡´ ì•„ë°”íƒ€ë¥¼ í˜„ì¬ ì»¨í…Œì´ë„ˆë¡œ ì´ë™ (ë‹¤ë¥¸ ìœ„ì¹˜ë¡œ ì´ë™)
                if (avatar.parentNode !== container) {
                    container.appendChild(avatar);
                }
                avatar.innerHTML = `${student.emoji} ${student.nickname.split(' ')[0]}`; 
                avatar.classList.toggle('spectator-mode', student.lives <= 0);
                avatar.style.opacity = '1'; 
                avatar.style.transform = 'scale(1)';
            }
        });
    }

    async function processResults(isForced = false) {
        // ... (ê²°ê³¼ ì²˜ë¦¬ ë¡œì§ ë™ì¼)
        if (currentGameState.showResult || !currentGameState.isActive) return;
        
        clearInterval(timerInterval);
        
        const correctAnswer = currentGameState.currentQuestion.answer;
        const comboThreshold = currentGameState.comboThreshold;
        
        const studentUpdates = {};
        let isCurrentUserCorrect = false;
        let isLifeGained = false;

        studentList.forEach(student => {
            if (student.lives > 0) { 
                if (student.answered === correctAnswer && !isForced) {
                    student.combo = (student.combo || 0) + 1;
                    
                    if (comboThreshold > 0 && (student.combo % comboThreshold === 0)) {
                         student.lives++; 
                         if (student.id === currentUser?.id) isLifeGained = true;
                    }
                    
                    if (student.id === currentUser?.id) isCurrentUserCorrect = true;
                } else {
                    student.lives--;
                    student.combo = 0;
                }
                
                studentUpdates[student.id] = {
                    lives: student.lives,
                    combo: student.combo,
                    answered: student.answered // ë‹µë³€ ìƒíƒœ ìœ ì§€ (ê²°ê³¼ í™”ë©´ìš©)
                };
            }
        });

        await studentRef.update(studentUpdates);

        await stateRef.update({
            isActive: false,
            showResult: true,
            isCurrentUserCorrect: isCurrentUserCorrect, 
            isLifeGained: isLifeGained 
        });
        
        if (!document.getElementById('teacher-view').classList.contains('hidden')) {
            setTimeout(() => {
                stateRef.update({ showResult: false }); 
            }, 3000);
        }
    }

    function showResultScreen(isCorrect, isLifeGained, question) { 
        // ... (ê²°ê³¼ í™”ë©´ í‘œì‹œ ë¡œì§ ë™ì¼)
        const resultScreen = document.getElementById('result-screen');
        const resultEmoji = document.getElementById('result-emoji');
        const resultMessage = document.getElementById('result-message');
        
        document.querySelectorAll('.quiz-state').forEach(el => el.classList.add('hidden'));
        document.getElementById('student-result').classList.remove('hidden');

        if (isCorrect) {
            resultScreen.className = 'correct-result';
            resultEmoji.textContent = 'ğŸ‰';
            let msg = `<span style="color: #fff; font-size: 2em;">ì •ë‹µ!</span>`;
            
            if (isLifeGained) {
                 msg += `<br><span style="color: #ffea00; font-size: 1.5em;">â­ëª©ìˆ¨ +1 ë³´ë„ˆìŠ¤! (${currentGameState.comboThreshold}ì½¤ë³´)</span>`;
            }
            resultMessage.innerHTML = msg;
            playSound(523, 0.2);
            playSound(659, 0.2);
        } else {
            resultScreen.className = 'wrong-result';
            resultEmoji.textContent = 'ğŸ’¥';
            resultMessage.innerHTML = `<span style="color: #fff; font-size: 2em;">í‹€ë ¸ì–´ìš”! ì •ë‹µì€ [${question.answer}]</span>`;
            playSound(200, 0.3);
        }
    }
    
    // ----------------------------------------------------------------------
    // 8. Timer & End Game Logic (ë™ì¼)
    // ----------------------------------------------------------------------

    function startTimer(seconds, role) {
        if (timerInterval) clearInterval(timerInterval);

        let timeLeft = seconds;
        const timerElement = (role === 'teacher') ? document.getElementById('timer-value') : document.getElementById('student-timer-value');
        
        timerElement.innerText = timeLeft;

        timerInterval = setInterval(() => {
            timeLeft--;
            timerElement.innerText = timeLeft;

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                if (role === 'teacher') {
                    processResults(); 
                }
            }
        }, 1000);
    }
    
    function endGame() {
        processResults(true); 
        
        let survivingStudents = studentList.filter(s => s.lives > 0);
        
        let rankingMessage = '';

        if (survivingStudents.length > 0) {
            survivingStudents.sort((a, b) => b.combo - a.combo);
            
            const topStudent = survivingStudents[0];
            let winnerMessage = `ğŸ† MVP (ìµœê³  ì½¤ë³´): ${topStudent.emoji} ${topStudent.nickname} (${topStudent.combo} ì½¤ë³´)`;
            
            rankingMessage = survivingStudents.slice(0, 5).map((s, i) => 
                `${i+1}ìœ„: ${s.emoji} ${s.nickname} (ìµœëŒ€ ì½¤ë³´: ${s.combo})`
            ).join('\n');

            alert(`ğŸ‰ ê²Œì„ ì¢…ë£Œ!\n\n${winnerMessage}\n\nğŸ“Š ìµœì¢… ìˆœìœ„:\n${rankingMessage}`);
        } else {
            alert(`ğŸ˜¢ ì•„ì‰½ì§€ë§Œ ìƒì¡´ìê°€ ì—†ìŠµë‹ˆë‹¤. ê²Œì„ ì¢…ë£Œ!`);
        }

        stateRef.update({ isActive: false, showResult: false });
    }
</script>

</body>
</html>


