<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Roblox OX í€´ì¦ˆ ìš´ë™ì¥</title>

    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        /* ---------------------- 1. Global Style ---------------------- */
        body {
            margin: 0;
            padding: 16px;
            background: linear-gradient(135deg, #e3f2fd, #fff3e0);
            font-family:
                'ë§‘ì€ ê³ ë”•', 'Malgun Gothic',
                'Apple SD Gothic Neo', 'Noto Sans KR',
                system-ui, -apple-system, BlinkMacSystemFont,
                'Segoe UI', sans-serif;
            color: #2c3e50;
        }

        #app {
            max-width: 1000px;
            margin: 16px auto;
            padding: 24px 20px 32px;
            background: #ffffff;
            border-radius: 24px;
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.15);
            border: 3px solid #90caf9;
            position: relative;
            z-index: 10;
        }

        h2, h3, h4 {
            font-family:
                'ë§‘ì€ ê³ ë”•', 'Malgun Gothic',
                'Apple SD Gothic Neo', 'Noto Sans KR',
                system-ui, 'Segoe UI', sans-serif;
            color: #0d47a1;
            text-align: center;
            margin-top: 8px;
            margin-bottom: 18px;
        }

        h2 {
            font-size: 2.2rem;
            text-shadow: 2px 2px 0px #ffe082;
        }

        h3 {
            font-size: 1.8rem;
            text-shadow: 1px 1px 0px #ffe082;
        }

        h4 {
            font-size: 1.4rem;
        }

        .hidden { display: none !important; }
        .centered { text-align: center; }

        label {
            font-family:
                'ë§‘ì€ ê³ ë”•', 'Malgun Gothic',
                'Apple SD Gothic Neo', 'Noto Sans KR',
                system-ui, 'Segoe UI', sans-serif;
            display: block;
            margin-top: 12px;
            margin-bottom: 4px;
            font-size: 1rem;
            color: #37474f;
        }

        input, select, textarea {
            font-family:
                'ë§‘ì€ ê³ ë”•', 'Malgun Gothic',
                'Apple SD Gothic Neo', 'Noto Sans KR',
                system-ui, 'Segoe UI', sans-serif;
            font-size: 1rem;
            padding: 8px 12px;
            border-radius: 12px;
            border: 2px solid #90caf9;
            outline: none;
            width: 100%;
            max-width: 420px;
            background: #fdfefe;
            transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #42a5f5;
            box-shadow: 0 0 0 3px rgba(66, 165, 245, 0.25);
            background: #ffffff;
        }

        textarea#question-input {
            min-height: 90px;
            resize: vertical;
            margin: 4px 0 8px;
        }

        /* ---------------------- 2. Button Style ---------------------- */
        button, .block-button {
            font-family:
                'ë§‘ì€ ê³ ë”•', 'Malgun Gothic',
                'Apple SD Gothic Neo', 'Noto Sans KR',
                system-ui, 'Segoe UI', sans-serif;
            padding: 12px 22px;
            margin: 6px;
            border: none;
            border-radius: 999px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 0.03em;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.1);
            transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, background 0.1s;
            color: #ffffff;
        }

        button:active, .block-button:active {
            transform: translateY(2px);
            box-shadow: 0 3px 0 rgba(0, 0, 0, 0.15);
        }

        .yellow-button {
            background: linear-gradient(135deg, #ffca28, #ffb300);
            color: #263238;
        }

        .green-button {
            background: linear-gradient(135deg, #66bb6a, #43a047);
        }

        .red-button {
            background: linear-gradient(135deg, #ef5350, #e53935);
        }

        .blue-button {
            background: linear-gradient(135deg, #42a5f5, #1e88e5);
        }

        /* ---------------------- 3. Problem List ---------------------- */
        #problem-list-container {
            max-height: 240px;
            overflow-y: auto;
            border-radius: 16px;
            border: 2px dashed #bbdefb;
            padding: 10px 12px;
            margin-top: 8px;
            background: #f6fbff;
        }

        .problem-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 4px;
            margin-bottom: 4px;
            border-bottom: 1px dashed #e0e0e0;
            font-size: 0.95rem;
        }

        .problem-text {
            flex: 1;
            margin-right: 8px;
            color: #37474f;
        }

        .delete-btn {
            background: #ef5350;
            border-radius: 999px;
            border: none;
            color: #fff;
            padding: 4px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            box-shadow: 0 3px 0 rgba(0,0,0,0.1);
        }

        .delete-btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 0 rgba(0,0,0,0.15);
        }

        /* ---------------------- 4. Quiz Field / Avatar ---------------------- */
        .quiz-field-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 12px;
        }

        #unanswered-area, #unanswered-area-spectator {
            width: 100%;
            min-height: 70px;
            background-color: #fff8e1;
            border-radius: 16px;
            padding: 10px 8px;
            margin-bottom: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-content: center;
            justify-content: center;
            box-shadow: 0 6px 16px rgba(0,0,0,0.08);
            border: 2px solid #ffe082;
        }

        .unanswered-label {
            font-size: 0.95rem;
            color: #6d4c41;
        }

        .result-box {
            display: flex;
            justify-content: space-between;
            width: 100%;
            gap: 12px;
            margin-top: 4px;
        }

        .o-area, .x-area {
            flex: 1;
            padding: 10px 8px 12px;
            border-radius: 16px;
            min-height: 210px;
            box-shadow: 0 8px 18px rgba(0,0,0,0.08);
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 8px;
            position: relative;
        }

        .o-area {
            background: #e8f5e9;
            border: 2px solid #a5d6a7;
        }

        .x-area {
            background: #ffebee;
            border: 2px solid #ef9a9a;
        }

        .count-badge {
            font-size: 1.1rem;
            margin-bottom: 4px;
            color: #37474f;
            width: 100%;
        }

        .answer-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .student-avatar {
            background: #ffffff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.95rem;
            border: 2px solid #90caf9;
            box-shadow: 0 3px 0 rgba(0,0,0,0.1);
            white-space: nowrap;
            cursor: default;
        }

        .flying-avatar {
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        /* ---------------------- 5. Student Info / Combo ---------------------- */
        #student-lives {
            font-size: 1.1rem;
            margin-bottom: 4px;
        }

        #life-rule-info {
            font-size: 0.9rem;
            color: #ff6f00;
            margin-bottom: 4px;
        }

        .combo-display {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 999px;
            background: #ffeb3b;
            font-size: 0.9rem;
            color: #5d4037;
            margin-top: 4px;
        }

        .quiz-state {
            margin-top: 18px;
        }

        /* ê²°ê³¼ í™”ë©´ */
        #result-screen {
            margin-top: 18px;
            padding: 18px 12px;
            border-radius: 20px;
            text-align: center;
            color: #ffffff;
        }

        .correct-result {
            background: linear-gradient(135deg, #66bb6a, #43a047);
        }

        .wrong-result {
            background: linear-gradient(135deg, #ef5350, #e53935);
        }

        #result-emoji {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        #result-message {
            font-size: 1.2rem;
        }

        /* íƒ€ì´ë¨¸ */
        #timer-display,
        #student-timer-display {
            font-size: 1rem;
            margin-bottom: 8px;
            color: #1565c0;
        }

        .answer-buttons {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 12px;
        }

        /* ---------------------- 6. Responsive ---------------------- */
        @media (max-width: 768px) {
            #app {
                padding: 18px 14px 24px;
            }

            h2 {
                font-size: 1.8rem;
            }

            h3 {
                font-size: 1.5rem;
            }

            .result-box {
                flex-direction: column;
            }

            .o-area, .x-area {
                min-height: 160px;
            }
        }
    </style>
</head>
<body>

<div id="app">
    <!-- ì´ˆê¸° í™”ë©´ -->
    <div id="initial-screen" class="centered">
        <h2>ğŸš€ Roblox OX í€´ì¦ˆ ìš´ë™ì¥ ğŸš€</h2>
        <p style="font-size: 1rem; margin-bottom: 16px;">
            ì„ ìƒë‹˜ì´ ë¬¸ì œë¥¼ ë‚´ë©´, ìš°ë¦¬ ì•„ë°”íƒ€ê°€ O / X êµ¬ì—­ìœ¼ë¡œ ìŠìŠ ì´ë™í•´ìš”!
        </p>
        <button class="block-button yellow-button" onclick="showTeacherLogin()">ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ìœ¼ë¡œ ì ‘ì†</button>
        <button class="block-button blue-button" onclick="showStudentLogin()">ğŸ‘§ğŸ‘¦ í•™ìƒìœ¼ë¡œ ì ‘ì†</button>
        <p style="font-size: 0.8rem; color: gray; margin-top: 12px;">
            (Firebase Realtime Databaseë¡œ ì‹¤ì‹œê°„ ë™ê¸°í™”ë©ë‹ˆë‹¤.)
        </p>
    </div>

    <!-- ì„ ìƒë‹˜ ë¡œê·¸ì¸ -->
    <div id="teacher-login-screen" class="hidden centered">
        <h3>ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ ë¹„ë°€ë²ˆí˜¸</h3>
        <label for="teacher-password">ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" id="teacher-password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        <div style="margin-top: 10px;">
            <button class="block-button yellow-button" onclick="teacherLogin()">ë¡œê·¸ì¸</button>
            <button class="block-button red-button" onclick="backToHome()">ë’¤ë¡œê°€ê¸°</button>
        </div>
    </div>

    <!-- ì„ ìƒë‹˜ ë·° -->
    <div id="teacher-view" class="hidden">
        <h3>ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ ê´€ë¦¬ (ë¬¸ì œ #<span id="question-index">0</span>)</h3>

        <div style="text-align: right; margin-bottom: 10px;">
            <button class="block-button red-button" onclick="resetGameData()">
                ğŸ”„ ë°ì´í„° ì´ˆê¸°í™” (í•™ìƒÂ·ê¸°ë¡Â·ë¬¸ì œ ì „ì²´ ì‚­ì œ)
            </button>
        </div>

        <!-- ë¬¸ì œ ì¤€ë¹„ ì˜ì—­ -->
        <div id="teacher-preparation">
            <h4>ğŸ§© ë¬¸ì œ ì¤€ë¹„í•˜ê¸°</h4>

            <label for="question-input">ë¬¸ì œ ë¬¸ì¥</label>
            <textarea id="question-input" placeholder="ì˜ˆ) 3Ã—4ëŠ” 12ì´ë‹¤. (O/X)"></textarea>

            <div style="display:flex; flex-wrap: wrap; gap: 10px; margin-top: 6px;">
                <div>
                    <label for="correct-answer">ì •ë‹µ</label>
                    <select id="correct-answer" style="max-width: 120px;">
                        <option value="O">O</option>
                        <option value="X">X</option>
                    </select>
                </div>
                <div>
                    <label for="timer-select">ì œí•œ ì‹œê°„(ì´ˆ)</label>
                    <input type="number" id="timer-select" value="10" min="5" max="60" style="max-width: 120px;">
                </div>
            </div>

            <button class="block-button green-button" style="margin-top: 8px;" onclick="addQuestionToPool()">
                â• ë¬¸ì œ ëª©ë¡ì— ì¶”ê°€
            </button>

            <hr style="margin: 18px 0;">

            <h4>ğŸ“‹ í˜„ì¬ ì¤€ë¹„ëœ ë¬¸ì œ (<span id="problem-count">0</span>ê°œ)</h4>
            <div id="problem-list-container"></div>

            <hr style="margin: 18px 0;">

            <label for="combo-life-threshold">ì¶”ê°€ ëª©ìˆ¨ íšë“ ì½¤ë³´</label>
            <input type="number" id="combo-life-threshold" value="5" min="2" max="10"
                   placeholder="ì˜ˆ: 5 â†’ 5ë¬¸ì œ ì—°ì† ì •ë‹µ ì‹œ ëª©ìˆ¨ +1" style="max-width: 200px;">

            <div class="centered" style="margin-top: 18px;">
                <button class="block-button yellow-button" onclick="startGameWithPool()">
                    â–¶ï¸ ì¤€ë¹„ëœ ë¬¸ì œë¡œ ê²Œì„ ì‹œì‘ & í•™ìƒë“¤ì—ê²Œ ë°°í¬
                </button>
            </div>
        </div>

        <!-- ë¼ì´ë¸Œ í€´ì¦ˆ ì˜ì—­ -->
        <div id="teacher-live-quiz" class="hidden">
            <h4>ğŸš¨ LIVE í€´ì¦ˆ: <span id="current-question"></span></h4>
            <div id="timer-display">TIME: <span id="timer-value">10</span></div>

            <div class="quiz-field-container">
                <div id="unanswered-area">
                    <span class="unanswered-label">[ìš´ë™ì¥ ë°–] ì•„ì§ ë‹µì„ ê³ ë¥´ì§€ ì•Šì€ ì•„ë°”íƒ€</span>
                </div>
                <div class="result-box">
                    <div class="o-area">
                        <div class="count-badge">O: <span id="o-count">0</span></div>
                        <div id="o-answers" class="answer-list"></div>
                    </div>
                    <div class="x-area">
                        <div class="count-badge">X: <span id="x-count">0</span></div>
                        <div id="x-answers" class="answer-list"></div>
                    </div>
                </div>
            </div>

            <div class="centered" style="margin-top: 20px;">
                <button class="block-button red-button" onclick="endGame()">
                    ğŸ’£ ê²Œì„ ê°•ì œ ì¢…ë£Œ (ìµœì¢… ìŠ¹ë¦¬ì ë°œí‘œ)
                </button>
            </div>
        </div>
    </div>

    <!-- í•™ìƒ ë¡œê·¸ì¸ -->
    <div id="student-login" class="hidden centered">
        <h3>ğŸ‘¤ ë‚´ ì•„ë°”íƒ€ ë§Œë“¤ê¸°</h3>
        <label for="student-nickname">ë‹‰ë„¤ì„</label>
        <input type="text" id="student-nickname" placeholder="ì˜ˆ) ìˆ˜í•™ì™•, ê·€ì—¼ë½€ì§7ë²ˆ ë“±">

        <label for="emoji-select">ë™ë¬¼ ì´ëª¨ì§€</label>
        <select id="emoji-select" style="max-width: 220px;">
            <option value="ğŸ¦">ğŸ¦ ì‚¬ì</option>
            <option value="ğŸ°">ğŸ° í† ë¼</option>
            <option value="ğŸ¶">ğŸ¶ ê°•ì•„ì§€</option>
            <option value="ğŸ»">ğŸ» ê³°</option>
            <option value="ğŸ¦Š">ğŸ¦Š ì—¬ìš°</option>
            <option value="ğŸ¼">ğŸ¼ íŒë‹¤</option>
            <option value="ğŸ¯">ğŸ¯ í˜¸ë‘ì´</option>
            <option value="ğŸ¨">ğŸ¨ ì½”ì•Œë¼</option>
            <option value="ğŸµ">ğŸµ ì›ìˆ­ì´</option>
            <option value="ğŸ¸">ğŸ¸ ê°œêµ¬ë¦¬</option>
            <option value="ğŸ§">ğŸ§ í­ê·„</option>
            <option value="ğŸ¦‰">ğŸ¦‰ ë¶€ì—‰ì´</option>
            <option value="ğŸ¦†">ğŸ¦† ì˜¤ë¦¬</option>
            <option value="ğŸ™">ğŸ™ ë¬¸ì–´</option>
            <option value="ğŸ¦€">ğŸ¦€ ê²Œ</option>
            <option value="ğŸ¢">ğŸ¢ ê±°ë¶ì´</option>
        </select>

        <div style="margin-top: 14px;">
            <button class="block-button yellow-button" onclick="loginStudent()">â–¶ï¸ í€´ì¦ˆë°© ì…ì¥</button>
            <button class="block-button red-button" onclick="backToHome()">ë’¤ë¡œê°€ê¸°</button>
        </div>
    </div>

    <!-- í•™ìƒ í™”ë©´ -->
    <div id="student-view" class="hidden">
        <h3 id="student-info" class="centered"></h3>
        <div class="centered">
            <p id="student-lives">â¤ï¸ ëª©ìˆ¨: 3</p>
            <div id="life-rule-info"></div>
            <div id="combo-indicator" class="combo-display hidden">
                ğŸ”¥ <span id="combo-count">0</span> COMBO!
            </div>
        </div>

        <div id="student-waiting" class="quiz-state centered">
            <h4 style="display:inline-block; padding:10px 16px; border-radius:20px; background:#e3f2fd; border:2px solid #90caf9;">
                ğŸ“¢ ì„ ìƒë‹˜ì´ ë¬¸ì œë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!
            </h4>
        </div>

        <div id="student-answering" class="quiz-state hidden centered">
            <h4 id="question-text" style="font-size:1.5rem; border-bottom:3px solid #fbc02d; padding-bottom:6px;"></h4>
            <div id="student-timer-display">TIME: <span id="student-timer-value">10</span></div>
            <div class="answer-buttons">
                <button class="block-button green-button" onclick="submitAnswer('O')">O</button>
                <button class="block-button red-button" onclick="submitAnswer('X')">X</button>
            </div>

            <h4 style="margin-top: 24px; margin-bottom: 10px;">ğŸ‘€ ì‹¤ì‹œê°„ ë‹µë³€ í˜„í™©</h4>
            <div id="live-answer-spectator" class="quiz-field-container">
                <div id="unanswered-area-spectator">
                    <span class="unanswered-label">[ëŒ€ê¸°] ì•„ì§ ë‹µì„ ê³ ë¥´ì§€ ì•Šì€ ì•„ë°”íƒ€</span>
                </div>
                <div class="result-box">
                    <div class="o-area">
                        <div class="count-badge">O: <span class="o-count-spectator">0</span></div>
                        <div id="o-answers-spectator" class="answer-list"></div>
                    </div>
                    <div class="x-area">
                        <div class="count-badge">X: <span class="x-count-spectator">0</span></div>
                        <div id="x-answers-spectator" class="answer-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="student-result" class="quiz-state hidden centered">
            <div id="result-screen">
                <div id="result-emoji">âœ¨</div>
                <h4 id="result-message"></h4>
            </div>
        </div>
    </div>
</div>

<script>
    // ----------------------------------------------------------------------
    // 1. Firebase ì„¤ì • (í•„ìˆ˜ ìˆ˜ì • ì˜ì—­)
    // ----------------------------------------------------------------------
   const firebaseConfig = {
  apiKey: "AIzaSyAoEYmlGb4tvWtYEQyBusIlyRDajD7-wtI",
  authDomain: "ox-quiz-ce39f.firebaseapp.com",
  databaseURL: "https://ox-quiz-ce39f-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "ox-quiz-ce39f",
  storageBucket: "ox-quiz-ce39f.firebasestorage.app",
  messagingSenderId: "509722567204",
  appId: "1:509722567204:web:728f6e3bd0851909d36eb1"
};

    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const gameRef = database.ref('quizGame');
    const studentRef = database.ref('quizGame/students');
    const stateRef = database.ref('quizGame/state');
    const problemPoolRef = database.ref('quizGame/problemPool');

    // ----------------------------------------------------------------------
    // 2. ì „ì—­ ë³€ìˆ˜
    // ----------------------------------------------------------------------
    const TEACHER_PASSWORD = 'teacher1234';
    let currentUser = null;
    let currentGameState = {};
    let studentList = [];
    let problemPool = [];
    let timerInterval = null;

    let lastUserLives = null;
    let lastUserCombo = null;
    let lastResultQuestionIndex = 0;

    const lastZoneMap = {}; // { studentId: 'out' | 'O' | 'X' }

    // ì‚¬ìš´ë“œ
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(frequency, duration) {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration);
    }

    // ----------------------------------------------------------------------
    // 3. View Management
    // ----------------------------------------------------------------------
    function hideAll() {
        document.getElementById('initial-screen').classList.add('hidden');
        document.getElementById('teacher-login-screen').classList.add('hidden');
        document.getElementById('teacher-view').classList.add('hidden');
        document.getElementById('student-login').classList.add('hidden');
        document.getElementById('student-view').classList.add('hidden');
    }

    function backToHome() {
        hideAll();
        document.getElementById('initial-screen').classList.remove('hidden');
    }

    function showTeacherLogin() {
        hideAll();
        document.getElementById('teacher-login-screen').classList.remove('hidden');
    }

    function teacherLogin() {
        const password = document.getElementById('teacher-password').value.trim();
        if (password === TEACHER_PASSWORD) {
            document.getElementById('teacher-password').value = '';
            showTeacherView();
        } else {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        }
    }

    function showTeacherView() {
        hideAll();
        document.getElementById('teacher-view').classList.remove('hidden');
    }

    function showStudentLogin() {
        hideAll();
        document.getElementById('student-login').classList.remove('hidden');
    }

    function showStudentView() {
        hideAll();
        document.getElementById('student-view').classList.remove('hidden');
        if (currentGameState.comboThreshold) {
            updateLifeRuleInfo(currentGameState.comboThreshold);
        }
    }

    function updateLifeRuleInfo(threshold) {
        const infoElement = document.getElementById('life-rule-info');
        if (!infoElement) return;
        if (threshold > 0) {
            infoElement.innerHTML = `âš ï¸ ê·œì¹™: <b>${threshold}ë¬¸ì œ ì—°ì† ì •ë‹µ</b> ì‹œ â¤ï¸ ëª©ìˆ¨ì´ 1ê°œ ëŠ˜ì–´ë‚˜ìš”!`;
            infoElement.classList.remove('hidden');
        } else {
            infoElement.classList.add('hidden');
        }
    }

    // ----------------------------------------------------------------------
    // 4. Firebase Listeners
    // ----------------------------------------------------------------------
    stateRef.on('value', (snapshot) => {
        currentGameState = snapshot.val() || {
            questionIndex: 0,
            isActive: false,
            comboThreshold: 5,
            showResult: false,
            isGameStarted: false
        };

        updateLifeRuleInfo(currentGameState.comboThreshold);

        if (!document.getElementById('teacher-view').classList.contains('hidden')) {
            updateTeacherView();
        }

        if (currentUser && !document.getElementById('student-view').classList.contains('hidden')) {
            updateStudentStateFromDB();
        }
    });

    studentRef.on('value', (snapshot) => {
        const students = snapshot.val();
        studentList = students ? Object.values(students) : [];

        updateQuizAreaViews();

        if (currentUser) {
            const prevLives = currentUser.lives;
            const prevCombo = currentUser.combo;
            const updatedUser = studentList.find(s => s.id === currentUser.id);
            if (updatedUser) {
                lastUserLives = prevLives;
                lastUserCombo = prevCombo;
                currentUser = updatedUser;
                const livesEl = document.getElementById('student-lives');
                if (livesEl) {
                    livesEl.innerText = `â¤ï¸ ëª©ìˆ¨: ${currentUser.lives}`;
                }
                updateComboDisplay();
            }
        }
    });

    problemPoolRef.on('value', (snapshot) => {
        const problems = snapshot.val();
        problemPool = problems
            ? Object.entries(problems).map(([key, value]) => ({ id: key, ...value }))
            : [];
        updateProblemListUI();
    });

    // ----------------------------------------------------------------------
    // 5. Problem Management (ì„ ìƒë‹˜)
    // ----------------------------------------------------------------------
    function addQuestionToPool() {
        const text = document.getElementById('question-input').value.trim();
        const timer = parseInt(document.getElementById('timer-select').value);
        const answer = document.getElementById('correct-answer').value;

        if (!text || isNaN(timer) || timer < 5) {
            alert('ë¬¸ì œ ë¬¸ì¥ê³¼ 5ì´ˆ ì´ìƒì¸ ì œí•œ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const newProblem = { text, timer, answer };

        problemPoolRef.push(newProblem)
            .then(() => {
                document.getElementById('question-input').value = '';
                alert('âœ… ë¬¸ì œê°€ ë¬¸ì œ ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            })
            .catch(error => {
                alert('âŒ ë¬¸ì œ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜: ' + error.message);
            });
    }

    function updateProblemListUI() {
        const container = document.getElementById('problem-list-container');
        const countElement = document.getElementById('problem-count');

        container.innerHTML = '';
        countElement.innerText = problemPool.length;

        if (problemPool.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:gray;">ì•„ì§ ì¤€ë¹„ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        problemPool.forEach((problem, index) => {
            const item = document.createElement('div');
            item.className = 'problem-item';

            const textDiv = document.createElement('div');
            textDiv.className = 'problem-text';
            const displayText = `${index + 1}. [${problem.answer}] (${problem.timer}ì´ˆ) ${problem.text}`;
            textDiv.innerText = displayText.length > 80 ? displayText.substring(0, 80) + 'â€¦' : displayText;

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerText = 'ì‚­ì œ';
            deleteBtn.onclick = () => deleteQuestionFromPool(problem.id);

            item.appendChild(textDiv);
            item.appendChild(deleteBtn);
            container.appendChild(item);
        });
    }

    function deleteQuestionFromPool(problemId) {
        if (!confirm('ì´ ë¬¸ì œë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
        database.ref(`quizGame/problemPool/${problemId}`).remove()
            .then(() => alert('âœ… ë¬¸ì œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'))
            .catch(error => alert('âŒ ë¬¸ì œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ' + error.message));
    }

    async function startGameWithPool() {
        if (problemPool.length === 0) {
            alert('ğŸš¨ ìµœì†Œ 1ê°œ ì´ìƒì˜ ë¬¸ì œë¥¼ ì¤€ë¹„í•´ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }

        if (currentGameState.isActive && timerInterval) {
            clearInterval(timerInterval);
            await processResults(true);
        }

        const comboThreshold = parseInt(document.getElementById('combo-life-threshold').value) || 5;

        const firstProblem = problemPool[0];
        const newGameState = {
            questionIndex: 1,
            currentProblemKey: firstProblem.id,
            currentQuestion: {
                text: firstProblem.text,
                timer: firstProblem.timer,
                answer: firstProblem.answer
            },
            isActive: true,
            showResult: false,
            answerTime: Date.now(),
            comboThreshold: comboThreshold,
            isGameStarted: true
        };

        const studentUpdates = {};
        studentList.forEach(student => {
            if (student.lives > 0) {
                studentUpdates[student.id + '/answered'] = null;
            }
        });
        await studentRef.update(studentUpdates);

        await stateRef.set(newGameState);
        alert(`âœ… ê²Œì„ ì‹œì‘! ì´ ${problemPool.length}ë¬¸ì œ ì¤‘ 1ë²ˆ ë¬¸ì œë¥¼ ë°°í¬í–ˆìŠµë‹ˆë‹¤.`);
    }

    async function proceedToNextQuestion() {
        const nextIndex = currentGameState.questionIndex + 1;
        if (nextIndex > problemPool.length) {
            endGame(true);
            return;
        }

        const nextProblem = problemPool[nextIndex - 1];

        const studentUpdates = {};
        studentList.forEach(student => {
            if (student.lives > 0) {
                studentUpdates[student.id + '/answered'] = null;
            }
        });
        await studentRef.update(studentUpdates);

        await stateRef.update({
            questionIndex: nextIndex,
            currentProblemKey: nextProblem.id,
            currentQuestion: {
                text: nextProblem.text,
                timer: nextProblem.timer,
                answer: nextProblem.answer
            },
            isActive: true,
            showResult: false,
            answerTime: Date.now()
        });

        lastResultQuestionIndex = 0;
    }

    // ----------------------------------------------------------------------
    // 6. Teacher View Logic
    // ----------------------------------------------------------------------
    function updateTeacherView() {
        const state = currentGameState;
        const questionIndexEl = document.getElementById('question-index');
        if (questionIndexEl) {
            questionIndexEl.innerText = state.questionIndex || 0;
        }

        const prep = document.getElementById('teacher-preparation');
        const live = document.getElementById('teacher-live-quiz');

        if (state.isGameStarted && state.isActive) {
            prep.classList.add('hidden');
            live.classList.remove('hidden');

            document.getElementById('current-question').innerText =
                `[#${state.questionIndex}/${problemPool.length}] ${state.currentQuestion.text}`;

            const elapsedSec = Math.floor((Date.now() - state.answerTime) / 1000);
            const remaining = Math.max(0, state.currentQuestion.timer - elapsedSec);
            startTimer(remaining, 'teacher');

        } else if (state.isGameStarted && !state.isActive && state.questionIndex <= problemPool.length) {
            prep.classList.add('hidden');
            live.classList.remove('hidden');

            if (!state.showResult) {
                document.getElementById('current-question').innerHTML =
                    `<span style="color:#fbc02d;">ë‹¤ìŒ ë¬¸ì œ ì¤€ë¹„ ì™„ë£Œ!</span><br>` +
                    `<button class="block-button green-button" onclick="proceedToNextQuestion()">â¡ï¸ ë‹¤ìŒ ë¬¸ì œ ì¶œì œ (#${state.questionIndex + 1})</button>`;
            }

        } else {
            prep.classList.remove('hidden');
            live.classList.add('hidden');
        }
    }

    function resetGameData() {
        const confirmReset = confirm('ğŸš¨ ì£¼ì˜: ëª¨ë“  í•™ìƒ ì •ë³´, ê²Œì„ ê¸°ë¡, ë¬¸ì œ ëª©ë¡ì´ ì‚­ì œë©ë‹ˆë‹¤. ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if (!confirmReset) return;
        gameRef.remove()
            .then(() => {
                alert('âœ… ê²Œì„ ë°ì´í„°ê°€ ëª¨ë‘ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
                location.reload();
            })
            .catch(error => {
                alert('âŒ ë°ì´í„° ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜: ' + error.message);
            });
    }

    // ----------------------------------------------------------------------
    // 7. Core Game Logic (ê²°ê³¼ ì²˜ë¦¬ / ì¢…ë£Œ)
    // ----------------------------------------------------------------------
    async function processResults(isForced) {
        if (currentGameState.showResult || !currentGameState.isActive) return;

        clearInterval(timerInterval);

        const correctAnswer = currentGameState.currentQuestion.answer;
        const comboThreshold = currentGameState.comboThreshold;

        const studentUpdates = {};
        studentList.forEach(student => {
            if (student.lives > 0) {
                if (!isForced && student.answered === correctAnswer) {
                    student.combo = (student.combo || 0) + 1;
                    if (comboThreshold > 0 && student.combo % comboThreshold === 0) {
                        student.lives++;
                    }
                } else if (!isForced) {
                    student.lives--;
                    if (student.lives < 0) student.lives = 0;
                    student.combo = 0;
                }
                studentUpdates[`${student.id}/lives`] = student.lives;
                studentUpdates[`${student.id}/combo`] = student.combo || 0;
                studentUpdates[`${student.id}/answered`] = student.answered || null;
            }
        });

        await studentRef.update(studentUpdates);

        await stateRef.update({
            isActive: false,
            showResult: true
        });

        if (!document.getElementById('teacher-view').classList.contains('hidden')) {
            setTimeout(() => {
                stateRef.update({ showResult: false });
            }, 3000);
        }
    }

    function showResultScreen(isCorrect, isLifeGained, question) {
        const resultScreen = document.getElementById('result-screen');
        const resultEmoji = document.getElementById('result-emoji');
        const resultMessage = document.getElementById('result-message');

        document.querySelectorAll('.quiz-state').forEach(el => el.classList.add('hidden'));
        document.getElementById('student-result').classList.remove('hidden');

        if (isCorrect) {
            resultScreen.className = 'correct-result';
            resultEmoji.textContent = 'ğŸ‰';
            let msg = '<span style="font-size:1.4rem;">ì •ë‹µì´ì—ìš”! ë„ˆë¬´ ì˜í–ˆì–´ìš” ğŸ‘</span>';
            if (isLifeGained) {
                msg += '<br><span style="font-size:1.1rem;">â­ ì½¤ë³´ë¡œ ëª©ìˆ¨ì´ 1ê°œ ëŠ˜ì–´ë‚¬ì–´ìš”!</span>';
            }
            resultMessage.innerHTML = msg;
            playSound(523, 0.15);
            playSound(659, 0.15);
        } else {
            resultScreen.className = 'wrong-result';
            resultEmoji.textContent = 'ğŸ’¥';
            resultMessage.innerHTML =
                `<span style="font-size:1.4rem;">ì•„ì‰¬ì›Œìš”! ì •ë‹µì€ [${question.answer}] ì˜€ì–´ìš”.</span>`;
            playSound(200, 0.25);
        }
    }

    function endGame(isAllCompleted) {
        if (!isAllCompleted && currentGameState.isActive) {
            processResults(true);
        }

        const alive = studentList.filter(s => s.lives > 0);
        if (alive.length > 0) {
            alive.sort((a, b) => (b.combo || 0) - (a.combo || 0));
            const top = alive[0];
            const rankingMessage = alive.slice(0, 5).map((s, i) =>
                `${i + 1}ìœ„: ${s.emoji} ${s.nickname} (ìµœëŒ€ ì½¤ë³´: ${s.combo || 0})`
            ).join('\n');

            alert(`ğŸ‰ ê²Œì„ ì¢…ë£Œ! (ì´ ${problemPool.length}ë¬¸ì œ ì™„ë£Œ)\n\nğŸ† MVP: ${top.emoji} ${top.nickname} (${top.combo || 0}ì½¤ë³´)\n\nğŸ“Š ìµœì¢… ìˆœìœ„\n${rankingMessage}`);
        } else {
            alert('ğŸ˜¢ ì•„ì‰½ì§€ë§Œ ìƒì¡´ìê°€ ì—†ìŠµë‹ˆë‹¤. ê²Œì„ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.');
        }

        stateRef.update({
            isActive: false,
            showResult: false,
            isGameStarted: false,
            questionIndex: 0
        });
    }

    // ----------------------------------------------------------------------
    // 8. Student Logic
    // ----------------------------------------------------------------------
    async function loginStudent() {
        const nicknameInput = document.getElementById('student-nickname');
        const emojiSelect = document.getElementById('emoji-select');

        const nickname = nicknameInput.value.trim();
        const emoji = emojiSelect.value;

        if (!nickname) {
            alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const newRef = studentRef.push();
        const newId = newRef.key;

        const studentData = {
            id: newId,
            nickname: nickname,
            emoji: emoji,
            lives: 3,
            combo: 0,
            answered: null
        };

        await newRef.set(studentData);
        currentUser = studentData;
        lastUserLives = 3;
        lastUserCombo = 0;

        const infoEl = document.getElementById('student-info');
        if (infoEl) {
            infoEl.innerText = `${emoji} ${nickname} ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`;
        }
        document.getElementById('student-lives').innerText = 'â¤ï¸ ëª©ìˆ¨: 3';

        showStudentView();
    }

    function updateStudentStateFromDB() {
        if (!currentUser) return;
        const state = currentGameState;

        const waiting = document.getElementById('student-waiting');
        const answering = document.getElementById('student-answering');
        const result = document.getElementById('student-result');

        if (!state.isGameStarted) {
            waiting.classList.remove('hidden');
            answering.classList.add('hidden');
            result.classList.add('hidden');
            return;
        }

        if (state.isActive) {
            waiting.classList.add('hidden');
            result.classList.add('hidden');
            answering.classList.remove('hidden');

            const qText = document.getElementById('question-text');
            if (qText && state.currentQuestion) {
                qText.innerText = state.currentQuestion.text;
            }

            const elapsedSec = Math.floor((Date.now() - state.answerTime) / 1000);
            const remaining = Math.max(0, state.currentQuestion.timer - elapsedSec);
            startTimer(remaining, 'student');

        } else if (state.showResult && state.questionIndex !== lastResultQuestionIndex) {
            answering.classList.add('hidden');
            waiting.classList.add('hidden');
            result.classList.remove('hidden');

            const isCorrect = (currentUser.answered === state.currentQuestion.answer && currentUser.lives > 0);
            const isLifeGained = (lastUserLives != null && currentUser.lives > lastUserLives);

            showResultScreen(isCorrect, isLifeGained, state.currentQuestion);
            lastResultQuestionIndex = state.questionIndex;

        } else {
            waiting.classList.remove('hidden');
            answering.classList.add('hidden');
            result.classList.add('hidden');
        }
    }

    function submitAnswer(answer) {
        if (!currentUser) return;
        if (!currentGameState.isActive || !currentGameState.isGameStarted) {
            alert('ì§€ê¸ˆì€ ë‹µì„ ì œì¶œí•  ìˆ˜ ìˆëŠ” ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.');
            return;
        }
        if (currentUser.lives <= 0) {
            alert('ì´ë¯¸ íƒˆë½í–ˆì–´ìš”. ì´ì œëŠ” ê´€ì „ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            return;
        }

        studentRef.child(currentUser.id).update({ answered: answer })
            .then(() => {
                playSound(440, 0.1);
            })
            .catch(err => console.error(err));
    }

    function updateComboDisplay() {
        const el = document.getElementById('combo-indicator');
        const countEl = document.getElementById('combo-count');
        if (!currentUser || !currentUser.combo || currentUser.combo <= 1) {
            el.classList.add('hidden');
            return;
        }
        countEl.innerText = currentUser.combo;
        el.classList.remove('hidden');
    }

    // ----------------------------------------------------------------------
    // 9. Avatar Animation & Quiz Area
    // ----------------------------------------------------------------------
    function createOrGetAvatarElement(student) {
        let avatar = document.querySelector(`.student-avatar[data-student-id="${student.id}"]`);
        if (!avatar) {
            avatar = document.createElement('div');
            avatar.className = 'student-avatar';
            avatar.dataset.studentId = student.id;
        }
        avatar.textContent = `${student.emoji} ${student.nickname}`;
        return avatar;
    }

    function moveAvatarWithAnimation(student, targetContainer, newZone) {
        const avatar = createOrGetAvatarElement(student);
        const currentParent = avatar.parentElement;

        if (!currentParent || lastZoneMap[student.id] === undefined || lastZoneMap[student.id] === newZone) {
            targetContainer.appendChild(avatar);
            lastZoneMap[student.id] = newZone;
            return;
        }

        const startRect = avatar.getBoundingClientRect();
        const startX = startRect.left + startRect.width / 2;
        const startY = startRect.top + startRect.height / 2;

        const targetRect = targetContainer.getBoundingClientRect();
        const endX = targetRect.left + targetRect.width / 2;
        const endY = targetRect.top + 40;

        const flying = avatar.cloneNode(true);
        flying.style.position = 'fixed';
        flying.style.left = (startX - startRect.width / 2) + 'px';
        flying.style.top = (startY - startRect.height / 2) + 'px';
        flying.style.margin = '0';
        flying.style.zIndex = 9999;
        flying.style.pointerEvents = 'none';
        flying.style.transition = 'transform 0.6s cubic-bezier(0.68,-0.55,0.27,1.55)';
        flying.classList.add('flying-avatar');
        document.body.appendChild(flying);

        avatar.style.visibility = 'hidden';

        const deltaX = endX - startX;
        const deltaY = endY - startY;

        requestAnimationFrame(() => {
            flying.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(1.1)`;
        });

        flying.addEventListener('transitionend', () => {
            targetContainer.appendChild(avatar);
            avatar.style.visibility = 'visible';
            document.body.removeChild(flying);
        });

        lastZoneMap[student.id] = newZone;
    }

    function updateQuizAreaViews() {
        const unanswered = document.getElementById('unanswered-area');
        const oArea = document.getElementById('o-answers');
        const xArea = document.getElementById('x-answers');

        const unansweredSpec = document.getElementById('unanswered-area-spectator');
        const oSpec = document.getElementById('o-answers-spectator');
        const xSpec = document.getElementById('x-answers-spectator');

        if (!unanswered || !oArea || !xArea || !unansweredSpec || !oSpec || !xSpec) return;

        unansweredSpec.innerHTML = '<span class="unanswered-label">[ëŒ€ê¸°] ì•„ì§ ë‹µì„ ê³ ë¥´ì§€ ì•Šì€ ì•„ë°”íƒ€</span>';
        oSpec.innerHTML = '';
        xSpec.innerHTML = '';

        let oCount = 0;
        let xCount = 0;

        studentList.forEach(student => {
            if (student.lives <= 0) return;

            let zone = 'out';
            if (student.answered === 'O') {
                zone = 'O';
                oCount++;
            } else if (student.answered === 'X') {
                zone = 'X';
                xCount++;
            }

            let targetTeacher = unanswered;
            if (zone === 'O') targetTeacher = oArea;
            else if (zone === 'X') targetTeacher = xArea;
            moveAvatarWithAnimation(student, targetTeacher, zone);

            const specAvatar = document.createElement('div');
            specAvatar.className = 'student-avatar';
            specAvatar.textContent = `${student.emoji} ${student.nickname}`;
            let targetSpec = unansweredSpec;
            if (zone === 'O') targetSpec = oSpec;
            else if (zone === 'X') targetSpec = xSpec;
            targetSpec.appendChild(specAvatar);
        });

        const oCountEl = document.getElementById('o-count');
        const xCountEl = document.getElementById('x-count');
        if (oCountEl) oCountEl.innerText = oCount;
        if (xCountEl) xCountEl.innerText = xCount;
        document.querySelectorAll('.o-count-spectator').forEach(el => el.innerText = oCount);
        document.querySelectorAll('.x-count-spectator').forEach(el => el.innerText = xCount);
    }

    // ----------------------------------------------------------------------
    // 10. Timer
    // ----------------------------------------------------------------------
    function startTimer(seconds, role) {
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        let remaining = seconds;

        function updateDisplay() {
            if (role === 'teacher') {
                const tv = document.getElementById('timer-value');
                if (tv) tv.innerText = remaining;
            } else if (role === 'student') {
                const tv = document.getElementById('student-timer-value');
                if (tv) tv.innerText = remaining;
            }
        }

        updateDisplay();

        timerInterval = setInterval(() => {
            remaining--;
            if (remaining < 0) {
                clearInterval(timerInterval);
                timerInterval = null;
                if (role === 'teacher' && currentGameState.isActive) {
                    processResults(false);
                }
                return;
            }
            updateDisplay();
        }, 1000);
    }
</script>

</body>
</html>








