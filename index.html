<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>OX í€´ì¦ˆ ìš´ë™ì¥</title>

    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        /* ---------------------- 1. Global Style ---------------------- */
        body {
            margin: 0;
            padding: 16px;
            background: linear-gradient(135deg, #e3f2fd, #fff3e0);
            font-family:
                'ë§‘ì€ ê³ ë”•', 'Malgun Gothic',
                'Apple SD Gothic Neo', 'Noto Sans KR',
                system-ui, -apple-system, BlinkMacSystemFont,
                'Segoe UI', sans-serif;
            color: #2c3e50;
        }

        #app {
            max-width: 1000px;
            margin: 16px auto;
            padding: 24px 20px 32px;
            background: #ffffff;
            border-radius: 24px;
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.15);
            border: 3px solid #90caf9;
            position: relative;
            z-index: 10;
        }

        h2, h3, h4 {
            font-family:
                'ë§‘ì€ ê³ ë”•', 'Malgun Gothic',
                'Apple SD Gothic Neo', 'Noto Sans KR',
                system-ui, 'Segoe UI', sans-serif;
            color: #0d47a1;
            text-align: center;
            margin-top: 8px;
            margin-bottom: 18px;
        }

        h2 {
            font-size: 2.2rem;
            text-shadow: 2px 2px 0px #ffe082;
        }

        h3 {
            font-size: 1.8rem;
            text-shadow: 1px 1px 0px #ffe082;
        }

        h4 {
            font-size: 1.4rem;
        }

        .hidden { display: none !important; }
        .centered { text-align: center; }

        label {
            display: block;
            margin-top: 12px;
            margin-bottom: 4px;
            font-size: 1rem;
            color: #37474f;
        }

        input, select, textarea {
            font-family:
                'ë§‘ì€ ê³ ë”•', 'Malgun Gothic',
                'Apple SD Gothic Neo', 'Noto Sans KR',
                system-ui, 'Segoe UI', sans-serif;
            font-size: 1rem;
            padding: 8px 12px;
            border-radius: 12px;
            border: 2px solid #90caf9;
            outline: none;
            width: 100%;
            max-width: 100%;
            background: #fdfefe;
            transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #42a5f5;
            box-shadow: 0 0 0 3px rgba(66, 165, 245, 0.25);
            background: #ffffff;
        }

        textarea#question-input {
            min-height: 70px;
            resize: vertical;
            margin: 4px 0 8px;
        }

        textarea#explanation-input {
            min-height: 60px;
            resize: vertical;
            margin: 4px 0 8px;
        }

        /* ---------------------- 2. Button Style ---------------------- */
        button, .block-button {
            font-family:
                'ë§‘ì€ ê³ ë”•', 'Malgun Gothic',
                'Apple SD Gothic Neo', 'Noto Sans KR',
                system-ui, 'Segoe UI', sans-serif;
            padding: 12px 22px;
            margin: 6px;
            border: none;
            border-radius: 999px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 0.03em;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.1);
            transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, background 0.1s;
            color: #ffffff;
        }

        button:active, .block-button:active {
            transform: translateY(2px);
            box-shadow: 0 3px 0 rgba(0, 0, 0, 0.15);
        }

        .yellow-button {
            background: linear-gradient(135deg, #ffca28, #ffb300);
            color: #263238;
        }

        .green-button {
            background: linear-gradient(135deg, #66bb6a, #43a047);
        }

        .red-button {
            background: linear-gradient(135deg, #ef5350, #e53935);
        }

        .blue-button {
            background: linear-gradient(135deg, #42a5f5, #1e88e5);
        }

        /* ---------------------- 3. Problem List ---------------------- */
        #problem-list-container {
            max-height: 240px;
            overflow-y: auto;
            border-radius: 16px;
            border: 2px dashed #bbdefb;
            padding: 10px 12px;
            margin-top: 8px;
            background: #f6fbff;
        }

        .problem-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 4px;
            margin-bottom: 4px;
            border-bottom: 1px dashed #e0e0e0;
            font-size: 0.95rem;
        }

        .problem-text {
            flex: 1;
            margin-right: 8px;
            color: #37474f;
        }

        .delete-btn {
            background: #ef5350;
            border-radius: 999px;
            border: none;
            color: #fff;
            padding: 4px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            box-shadow: 0 3px 0 rgba(0,0,0,0.1);
        }

        .delete-btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 0 rgba(0,0,0,0.15);
        }

        /* ---------------------- 4. Quiz Field / Avatar ---------------------- */
        .quiz-field-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 12px;
        }

        #unanswered-area, #unanswered-area-spectator {
            width: 100%;
            min-height: 70px;
            background-color: #fff8e1;
            border-radius: 16px;
            padding: 10px 8px;
            margin-bottom: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-content: center;
            justify-content: center;
            box-shadow: 0 6px 16px rgba(0,0,0,0.08);
            border: 2px solid #ffe082;
        }

        .result-box {
            display: flex;
            justify-content: space-between;
            width: 100%;
            gap: 12px;
            margin-top: 4px;
        }

        .o-area, .x-area {
            flex: 1;
            padding: 28px 8px 12px;
            border-radius: 16px;
            min-height: 210px;
            box-shadow: 0 8px 18px rgba(0,0,0,0.08);
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 8px;
            position: relative;
        }

        .o-area {
            background: #e8f5e9;
            border: 2px solid #a5d6a7;
        }

        .x-area {
            background: #ffebee;
            border: 2px solid #ef9a9a;
        }

        .o-area::before,
        .x-area::before {
            position: absolute;
            top: 4px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3.2rem;
            font-weight: 700;
            color: rgba(0,0,0,0.12);
            pointer-events: none;
        }

        .o-area::before {
            content: 'O';
        }

        .x-area::before {
            content: 'X';
        }

        .ox-field .o-area,
        .ox-field .x-area {
            cursor: pointer;
        }

        .count-badge {
            font-size: 1.0rem;
            margin-bottom: 4px;
            color: #37474f;
            width: 100%;
        }

        .answer-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .student-avatar {
            background: #ffffff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.95rem;
            border: 2px solid #90caf9;
            box-shadow: 0 3px 0 rgba(0,0,0,0.1);
            white-space: nowrap;
            cursor: default;
        }

        .flying-avatar {
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .ox-field {
            position: relative;
            width: 100%;
            margin-top: 4px;
            padding: 12px 8px 16px;
            border-radius: 20px;
            background: linear-gradient(180deg, #c8e6c9 0, #a5d6a7 40%, #81c784 100%);
            box-shadow: 0 10px 24px rgba(0,0,0,0.12);
            overflow: hidden;
        }

        .ox-center-line {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 4px;
            background: rgba(255,255,255,0.7);
        }

        /* ---------------------- 5. Student Info / Combo ---------------------- */
        #student-lives {
            font-size: 1.1rem;
            margin-bottom: 4px;
        }

        #life-rule-info {
            font-size: 0.9rem;
            color: #ff6f00;
            margin-bottom: 4px;
        }

        .combo-display {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 999px;
            background: #ffeb3b;
            font-size: 0.9rem;
            color: #5d4037;
            margin-top: 4px;
        }

        .quiz-state {
            margin-top: 18px;
        }

        /* ê²°ê³¼ í™”ë©´ */
        #result-screen {
            margin-top: 18px;
            padding: 18px 12px;
            border-radius: 20px;
            text-align: center;
            color: #ffffff;
        }

        .correct-result {
            background: linear-gradient(135deg, #66bb6a, #43a047);
        }

        .wrong-result {
            background: linear-gradient(135deg, #ef5350, #e53935);
        }

        #result-emoji {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        #result-message {
            font-size: 1.2rem;
        }

        /* íƒ€ì´ë¨¸ */
        #timer-display,
        #student-timer-display {
            font-size: 1rem;
            margin-bottom: 8px;
            color: #1565c0;
        }

        /* ---------------------- 6. Teacher extra panels ---------------------- */
        #teacher-preparation {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 16px 18px 20px;
            border-radius: 20px;
            background: #f5f9ff;
        }

        #student-list-container {
            max-height: 200px;
            overflow-y: auto;
            border-radius: 16px;
            border: 2px dashed #c5e1a5;
            padding: 10px 12px;
            margin-top: 8px;
            background: #f9fff3;
        }

        .student-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 4px;
            margin-bottom: 4px;
            border-bottom: 1px dashed #e0e0e0;
            font-size: 0.95rem;
        }

        .student-row span {
            color: #37474f;
        }

        /* ---------------------- 7. Final ranking screen + Tabs ---------------------- */
        #final-result-view {
            text-align: center;
        }

        #final-ranking-container {
            max-width: 640px;
            margin: 0 auto;
            padding: 24px 20px;
            border-radius: 24px;
            background: linear-gradient(135deg, #fff8e1, #e3f2fd);
            border: 3px solid #ffca28;
            box-shadow: 0 18px 40px rgba(15,23,42,0.15);
        }

        .mvp-box {
            margin-bottom: 20px;
            padding: 16px 14px;
            border-radius: 20px;
            background: linear-gradient(135deg, #ffe082, #ffb300);
            color: #4e342e;
            box-shadow: 0 10px 24px rgba(0,0,0,0.15);
        }

        .mvp-title {
            font-size: 1.1rem;
            margin-bottom: 6px;
        }

        .mvp-name {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .medal-list {
            margin-top: 10px;
        }

        .medal-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-radius: 16px;
            margin-bottom: 8px;
            background: #ffffff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.06);
            font-size: 0.98rem;
        }

        .medal-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .medal-rank {
            font-size: 1.4rem;
        }

        .medal-name {
            font-weight: 600;
        }

        .medal-stats {
            font-size: 0.9rem;
            color: #546e7a;
        }

        .result-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }

        .result-tab-btn {
            padding: 8px 14px;
            border-radius: 999px;
            border: none;
            font-size: 0.95rem;
            cursor: pointer;
            background: #e3f2fd;
            color: #1565c0;
            font-weight: 600;
            box-shadow: 0 3px 8px rgba(21, 101, 192, 0.2);
        }

        .result-tab-btn.active {
            background: #1565c0;
            color: #ffffff;
            box-shadow: 0 4px 10px rgba(21, 101, 192, 0.35);
        }

        /* ë¬¸ì œ ë³´ê¸° íƒ­ìš© ë¸”ë¡ */
        .problem-block {
            padding: 12px 10px;
            margin-bottom: 10px;
            border-radius: 16px;
            background: #ffffff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.06);
            text-align: left;
        }

        .problem-q {
            font-weight: 600;
            margin-bottom: 4px;
            color: #263238;
        }

        .problem-a {
            font-size: 0.95rem;
            color: #d84315;
            margin-bottom: 2px;
        }

        .problem-expl {
            font-size: 0.95rem;
            color: #37474f;
            margin-bottom: 4px;
        }

        .problem-correct {
            font-size: 0.9rem;
            color: #546e7a;
        }

        /* ---------------------- 8. Responsive ---------------------- */
        @media (max-width: 768px) {
            #app {
                padding: 18px 14px 24px;
            }

            h2 {
                font-size: 1.8rem;
            }

            h3 {
                font-size: 1.5rem;
            }

            .result-box {
                flex-direction: column;
            }

            .o-area, .x-area {
                min-height: 160px;
            }

            #final-ranking-container {
                padding: 18px 14px;
            }
        }
    </style>
</head>
<body>

<div id="app">
    <!-- ì´ˆê¸° í™”ë©´ -->
    <div id="initial-screen" class="centered">
        <h2>ğŸš€ OX í€´ì¦ˆ ìš´ë™ì¥ ğŸš€</h2>
        <p style="font-size: 1rem; margin-bottom: 16px;">
            ì„ ìƒë‹˜ì´ ë¬¸ì œë¥¼ ë‚´ë©´, ìš°ë¦¬ê°€ O / X êµ¬ì—­ìœ¼ë¡œ ìŠ ì´ë™í•´ìš”!
        </p>
        <button class="block-button yellow-button" onclick="showTeacherLogin()">ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ìœ¼ë¡œ ì ‘ì†</button>
        <button class="block-button blue-button" onclick="showStudentLogin()">ğŸ‘§ğŸ‘¦ í•™ìƒìœ¼ë¡œ ì ‘ì†</button>
        <p style="font-size: 0.8rem; color: gray; margin-top: 12px;">
            (Firebase Realtime Databaseë¡œ ì‹¤ì‹œê°„ ë™ê¸°í™”ë©ë‹ˆë‹¤.)
        </p>
    </div>

    <!-- ì„ ìƒë‹˜ ë¡œê·¸ì¸ -->
    <div id="teacher-login-screen" class="hidden centered">
        <h3>ğŸ” ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¤í•˜ì„¸ìš”.</h3>
        <input type="password" id="teacher-password" placeholder="">
        <div style="margin-top: 10px;">
            <button class="block-button red-button" onclick="backToHome()">ë’¤ë¡œê°€ê¸°</button>
            <button class="block-button yellow-button" onclick="teacherLogin()">ë¡œê·¸ì¸</button>
        </div>
    </div>

    <!-- ì„ ìƒë‹˜ ë·° -->
    <div id="teacher-view" class="hidden">
        <h3>ğŸ‘¨â€ğŸ« ê´€ë¦¬ í™”ë©´</h3>

        <!-- ë¬¸ì œ ì¤€ë¹„ ì˜ì—­ -->
        <div id="teacher-preparation">
            <h4>ğŸ§© ë¬¸ì œ ì¤€ë¹„í•˜ê¸°</h4>

            <label for="question-input">ë¬¸ì œ</label>
            <textarea id="question-input" placeholder="ì˜ˆ) 3Ã—4ëŠ” 12ì´ë‹¤. (O/X)"></textarea>

            <div style="display:flex; flex-wrap: wrap; gap: 10px; margin-top: 6px;">
                <div style="flex:1; min-width:0;">
                    <label for="correct-answer">ì •ë‹µ (O / X)</label>
                    <select id="correct-answer">
                        <option value="O">O</option>
                        <option value="X">X</option>
                    </select>
                </div>
                <div style="flex:1; min-width:0;">
                    <label for="timer-select">ì œí•œ ì‹œê°„(ì´ˆ)</label>
                    <input type="number" id="timer-select" value="10" min="5" max="60">
                </div>
            </div>

            <label for="explanation-input">ì„¤ëª… (ì„ íƒ)</label>
            <textarea id="explanation-input" placeholder="ë¬¸ì œë¥¼ ì„¤ëª…í•´ ì£¼ê³  ì‹¶ë‹¤ë©´ ì—¬ê¸°ì— ì ì–´ ì£¼ì„¸ìš”. (ì…ë ¥í•˜ì§€ ì•Šì•„ë„ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤)"></textarea>

            <div class="centered">
                <button class="block-button green-button" style="margin-top: 8px;" onclick="addQuestionToPool()">
                    â• ë¬¸ì œ ëª©ë¡ì— ì¶”ê°€
                </button>
            </div>

            <hr style="margin: 18px 0;">

            <h4>ğŸ“‹ í˜„ì¬ ë“±ë¡ëœ ë¬¸ì œ (<span id="problem-count">0</span>ê°œ)</h4>
            <div id="problem-list-container"></div>
            <div class="centered" style="margin-top: 8px;">
                <button class="block-button red-button" onclick="deleteAllQuestions()">
                    ğŸ—‘ ë¬¸ì œ ì „ì²´ ì‚­ì œ
                </button>
            </div>

            <hr style="margin: 18px 0;">

            <h4>ğŸ‘¥ í˜„ì¬ ì ‘ì†í•œ í•™ìƒ (<span id="student-count">0</span>ëª…)</h4>
            <div id="student-list-container"></div>
            <div class="centered" style="margin-top: 8px;">
                <button class="block-button red-button" onclick="removeAllStudents()">
                    ğŸ§¹ í•™ìƒ ì „ì²´ ì‚­ì œ
                </button>
            </div>

            <hr style="margin: 18px 0;">

            <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:4px;">
                <div style="flex:1; min-width:0;">
                    <label for="initial-hearts">ì´ˆê¸° í•˜íŠ¸</label>
                    <input type="number" id="initial-hearts" value="3" min="1" max="10"
                           placeholder="ì˜ˆ: 3 â†’ ì‹œì‘ í•˜íŠ¸ 3ê°œ">
                </div>
                <div style="flex:1; min-width:0;">
                    <label for="combo-life-threshold">ì¶”ê°€ í•˜íŠ¸ íšë“ ì½¤ë³´</label>
                    <input type="number" id="combo-life-threshold" value="5" min="2" max="10"
                           placeholder="ì˜ˆ: 5 â†’ 5ë¬¸ì œ ì—°ì† ì •ë‹µ ì‹œ í•˜íŠ¸ +1">
                </div>
            </div>

            <div class="centered" style="margin-top: 18px;">
                <button class="block-button yellow-button" onclick="startGameWithPool()">
                    â–¶ï¸ ì‹œì‘í•˜ê¸°
                </button>
            </div>
        </div>

        <!-- ë¼ì´ë¸Œ í€´ì¦ˆ ì˜ì—­ -->
        <div id="teacher-live-quiz" class="hidden">
            <h4>ğŸš¨ LIVE í€´ì¦ˆ: <span id="current-question"></span></h4>
            <div id="timer-display">TIME: <span id="timer-value">10</span></div>

            <div class="quiz-field-container">
                <div id="unanswered-area">
                    <!-- ì•„ë°”íƒ€ë§Œ í‘œì‹œ -->
                </div>
                <div class="ox-field">
                    <div class="ox-center-line"></div>
                    <div class="result-box">
                        <div class="o-area">
                            <div class="count-badge"><span id="o-count">0</span>ëª…</div>
                            <div id="o-answers" class="answer-list"></div>
                        </div>
                        <div class="x-area">
                            <div class="count-badge"><span id="x-count">0</span>ëª…</div>
                            <div id="x-answers" class="answer-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="centered" style="margin-top: 20px;">
                <button class="block-button red-button" onclick="endGame(false)">
                    ğŸ›‘ ê·¸ë§Œí•˜ê¸° (í˜„ì¬ê¹Œì§€ ì ìˆ˜ë¡œ ê²°ê³¼ ë°œí‘œ)
                </button>
            </div>
        </div>
    </div>

    <!-- í•™ìƒ ë¡œê·¸ì¸ -->
    <div id="student-login" class="hidden centered">
        <h3>ğŸ‘¤ ë‚´ ìºë¦­í„° ë§Œë“¤ê¸°</h3>
        <label for="student-nickname">ë‹‰ë„¤ì„</label>
        <input type="text" id="student-nickname" placeholder="ì˜ˆ) ìˆ˜í•™ì™•, ê·€ì—¼ë½€ì§7ë²ˆ ë“±">

        <label for="emoji-select">12ì§€ì‹  ì´ëª¨ì§€</label>
        <select id="emoji-select" style="max-width: 220px;">
            <option value="ğŸ­">ğŸ­ ì¥</option>
            <option value="ğŸ®">ğŸ® ì†Œ</option>
            <option value="ğŸ¯">ğŸ¯ í˜¸ë‘ì´</option>
            <option value="ğŸ°">ğŸ° í† ë¼</option>
            <option value="ğŸ²">ğŸ² ìš©</option>
            <option value="ğŸ">ğŸ ë±€</option>
            <option value="ğŸ´">ğŸ´ ë§</option>
            <option value="ğŸ‘">ğŸ‘ ì–‘</option>
            <option value="ğŸµ">ğŸµ ì›ìˆ­ì´</option>
            <option value="ğŸ”">ğŸ” ë‹­</option>
            <option value="ğŸ¶">ğŸ¶ ê°œ</option>
            <option value="ğŸ·">ğŸ· ë¼ì§€</option>
        </select>

        <div style="margin-top: 14px;">
            <button class="block-button yellow-button" onclick="loginStudent()">â–¶ï¸ í€´ì¦ˆë°© ì…ì¥</button>
            <button class="block-button red-button" onclick="backToHome()">ë’¤ë¡œê°€ê¸°</button>
        </div>
    </div>

    <!-- í•™ìƒ í™”ë©´ -->
    <div id="student-view" class="hidden">
        <h3 id="student-info" class="centered"></h3>
        <div class="centered">
            <p id="student-lives">â¤ï¸ í•˜íŠ¸: 3</p>
            <div id="life-rule-info"></div>
            <div id="combo-indicator" class="combo-display hidden">
                ğŸ”¥ <span id="combo-count">0</span> COMBO!
            </div>
        </div>

        <div id="student-waiting" class="quiz-state centered">
            <h4 style="display:inline-block; padding:10px 16px; border-radius:20px; background:#e3f2fd; border:2px solid #90caf9;">
                ğŸ“¢ ì„ ìƒë‹˜ì´ ë¬¸ì œë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!
            </h4>
        </div>

        <div id="student-answering" class="quiz-state hidden centered">
            <h4 id="question-text" style="font-size:1.5rem; border-bottom:3px solid #fbc02d; padding-bottom:6px;"></h4>
            <div id="student-timer-display">TIME: <span id="student-timer-value">10</span></div>

            <h4 style="margin-top: 8px; margin-bottom: 10px; font-size:1.0rem; color:#455a64;">
                ì•„ë˜ O / X ìš´ë™ì¥ì„ ëˆŒëŸ¬ì„œ ì •ë‹µì„ ê³ ë¥´ì„¸ìš”!
            </h4>

            <div id="live-answer-spectator" class="quiz-field-container">
                <div id="unanswered-area-spectator">
                    <!-- ì•„ë°”íƒ€ë§Œ í‘œì‹œ -->
                </div>
                <div class="ox-field">
                    <div class="ox-center-line"></div>
                    <div class="result-box">
                        <div class="o-area" id="o-area-spectator">
                            <div class="count-badge"><span class="o-count-spectator">0</span>ëª…</div>
                            <div id="o-answers-spectator" class="answer-list"></div>
                        </div>
                        <div class="x-area" id="x-area-spectator">
                            <div class="count-badge"><span class="x-count-spectator">0</span>ëª…</div>
                            <div id="x-answers-spectator" class="answer-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="student-result" class="quiz-state hidden centered">
            <div id="result-screen">
                <div id="result-emoji">âœ¨</div>
                <h4 id="result-message"></h4>
            </div>
        </div>
    </div>

    <!-- ìµœì¢… ê²°ê³¼ í™”ë©´ -->
    <div id="final-result-view" class="hidden centered">
        <h3>ğŸ† ìµœì¢… ê²°ê³¼ ë°œí‘œ</h3>
        <div id="final-ranking-container">
            <!-- JSì—ì„œ íƒ­ + ë‚´ìš© ìƒì„± -->
        </div>
        <div class="centered" style="margin-top: 18px;">
            <button class="block-button blue-button" onclick="backToTeacherFromResult()">
                ğŸ“‹ ê´€ë¦¬ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
        </div>
    </div>
</div>

<script>
    // ----------------------------------------------------------------------
    // 1. Firebase ì„¤ì •
    // ----------------------------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyAoEYmlGb4tvWtYEQyBusIlyRDajD7-wtI",
        authDomain: "ox-quiz-ce39f.firebaseapp.com",
        databaseURL: "https://ox-quiz-ce39f-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "ox-quiz-ce39f",
        storageBucket: "ox-quiz-ce39f.firebasestorage.app",
        messagingSenderId: "509722567204",
        appId: "1:509722567204:web:728f6e3bd0851909d36eb1"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const gameRef = database.ref('quizGame');
    const studentRef = database.ref('quizGame/students');
    const stateRef = database.ref('quizGame/state');
    const problemPoolRef = database.ref('quizGame/problemPool');
    const resultsRef = database.ref('quizGame/results');

    // ----------------------------------------------------------------------
    // 2. ì „ì—­ ë³€ìˆ˜
    // ----------------------------------------------------------------------
    const TEACHER_PASSWORD = 'teacher1234';
    let INITIAL_LIVES = 3;

    let currentUser = null;
    let currentGameState = {};
    let studentList = [];
    let problemPool = [];
    let resultsList = [];
    let timerInterval = null;

    let lastUserLives = null;
    let lastUserCombo = null;
    let lastResultQuestionIndex = 0;

    const lastZoneMap = {};
    const lastZoneMapSpectator = {};

    // ì‚¬ìš´ë“œ
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(frequency, duration) {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration);
    }

    // ----------------------------------------------------------------------
    // 3. View Management
    // ----------------------------------------------------------------------
    function hideAll() {
        document.getElementById('initial-screen').classList.add('hidden');
        document.getElementById('teacher-login-screen').classList.add('hidden');
        document.getElementById('teacher-view').classList.add('hidden');
        document.getElementById('student-login').classList.add('hidden');
        document.getElementById('student-view').classList.add('hidden');
        document.getElementById('final-result-view').classList.add('hidden');
    }

    function backToHome() {
        hideAll();
        document.getElementById('initial-screen').classList.remove('hidden');
    }

    function showTeacherLogin() {
        hideAll();
        document.getElementById('teacher-login-screen').classList.remove('hidden');
    }

    function teacherLogin() {
        const password = document.getElementById('teacher-password').value.trim();
        if (password === TEACHER_PASSWORD) {
            document.getElementById('teacher-password').value = '';
            showTeacherView();
        } else {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        }
    }

    function showTeacherView() {
        hideAll();
        document.getElementById('teacher-view').classList.remove('hidden');
    }

    function showStudentLogin() {
        hideAll();
        document.getElementById('student-login').classList.remove('hidden');
    }

    function showStudentView() {
        hideAll();
        document.getElementById('student-view').classList.remove('hidden');
        if (currentGameState.comboThreshold) {
            updateLifeRuleInfo(currentGameState.comboThreshold);
        }
    }

    function updateLifeRuleInfo(threshold) {
        const infoElement = document.getElementById('life-rule-info');
        if (!infoElement) return;
        if (threshold > 0) {
            infoElement.innerHTML = `âš ï¸ ê·œì¹™: <b>${threshold}ë¬¸ì œ ì—°ì† ì •ë‹µ</b> ì‹œ â¤ï¸ í•˜íŠ¸ê°€ 1ê°œ ëŠ˜ì–´ë‚˜ìš”!`;
            infoElement.classList.remove('hidden');
        } else {
            infoElement.classList.add('hidden');
        }
    }

    // ë¹„ë°€ë²ˆí˜¸ Enter í‚¤
    const teacherPwInput = document.getElementById('teacher-password');
    if (teacherPwInput) {
        teacherPwInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                teacherLogin();
            }
        });
    }

    // í•™ìƒ O/X ì˜ì—­ í´ë¦­
    const oAreaSpec = document.getElementById('o-area-spectator');
    const xAreaSpec = document.getElementById('x-area-spectator');
    if (oAreaSpec) {
        oAreaSpec.addEventListener('click', () => submitAnswer('O'));
    }
    if (xAreaSpec) {
        xAreaSpec.addEventListener('click', () => submitAnswer('X'));
    }

    // ì´ˆê¸° í•˜íŠ¸ ë³€ê²½ ì‹œ ìƒíƒœ ë°˜ì˜
    const initialHeartsInputEl = document.getElementById('initial-hearts');
    if (initialHeartsInputEl) {
        initialHeartsInputEl.addEventListener('change', function () {
            let val = parseInt(this.value);
            if (isNaN(val) || val < 1) val = 1;
            this.value = val;
            INITIAL_LIVES = val;
            stateRef.update({ initialHearts: val });
        });
    }

    // ----------------------------------------------------------------------
    // 4. Firebase Listeners
    // ----------------------------------------------------------------------
    stateRef.on('value', (snapshot) => {
        currentGameState = snapshot.val() || {
            questionIndex: 0,
            isActive: false,
            comboThreshold: 5,
            showResult: false,
            isGameStarted: false,
            initialHearts: INITIAL_LIVES
        };

        if (!currentGameState.initialHearts) {
            currentGameState.initialHearts = INITIAL_LIVES;
        }

        const initInput = document.getElementById('initial-hearts');
        if (initInput) {
            const val = currentGameState.initialHearts || INITIAL_LIVES;
            initInput.value = val;
            INITIAL_LIVES = val;
        }

        updateLifeRuleInfo(currentGameState.comboThreshold);

        if (!document.getElementById('teacher-view').classList.contains('hidden')) {
            updateTeacherView();
        }

        if (currentUser && !document.getElementById('student-view').classList.contains('hidden')) {
            updateStudentStateFromDB();
        }
    });

    studentRef.on('value', (snapshot) => {
        const students = snapshot.val();
        studentList = students ? Object.values(students) : [];

        updateQuizAreaViews();
        updateStudentListUI();

        if (currentUser) {
            const prevLives = currentUser.lives;
            const prevCombo = currentUser.combo;
            const updatedUser = studentList.find(s => s.id === currentUser.id);
            if (updatedUser) {
                lastUserLives = prevLives;
                lastUserCombo = prevCombo;
                currentUser = updatedUser;
                const livesEl = document.getElementById('student-lives');
                if (livesEl) {
                    livesEl.innerText = `â¤ï¸ í•˜íŠ¸: ${currentUser.lives}`;
                }
                updateComboDisplay();
            }
        }
    });

    problemPoolRef.on('value', (snapshot) => {
        const problems = snapshot.val();
        problemPool = problems
            ? Object.entries(problems).map(([key, value]) => ({ id: key, ...value }))
            : [];
        updateProblemListUI();
    });

    resultsRef.on('value', (snapshot) => {
        const val = snapshot.val();
        resultsList = val
            ? Object.values(val).sort((a, b) => (a.index || 0) - (b.index || 0))
            : [];
    });

    // ----------------------------------------------------------------------
    // 5. Problem Management
    // ----------------------------------------------------------------------
    function addQuestionToPool() {
        const text = document.getElementById('question-input').value.trim();
        const timer = parseInt(document.getElementById('timer-select').value);
        const answer = document.getElementById('correct-answer').value;
        const explanation = document.getElementById('explanation-input').value.trim();

        if (!text || isNaN(timer) || timer < 5) {
            alert('ë¬¸ì œ ë¬¸ì¥ê³¼ 5ì´ˆ ì´ìƒì¸ ì œí•œ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (!answer) {
            alert('ì •ë‹µ(O/X)ì„ ë°˜ë“œì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const newProblem = { text, timer, answer };
        if (explanation) {
            newProblem.explanation = explanation;
        }

        problemPoolRef.push(newProblem)
            .then(() => {
                document.getElementById('question-input').value = '';
                document.getElementById('explanation-input').value = '';
                alert('âœ… ë¬¸ì œê°€ ë¬¸ì œ ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            })
            .catch(error => {
                alert('âŒ ë¬¸ì œ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜: ' + error.message);
            });
    }

    function updateProblemListUI() {
        const container = document.getElementById('problem-list-container');
        const countElement = document.getElementById('problem-count');

        container.innerHTML = '';
        countElement.innerText = problemPool.length;

        if (problemPool.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:gray;">ì•„ì§ ì¤€ë¹„ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        problemPool.forEach((problem, index) => {
            const item = document.createElement('div');
            item.className = 'problem-item';

            const textDiv = document.createElement('div');
            textDiv.className = 'problem-text';

            let displayText = `${index + 1}. [${problem.answer}] (${problem.timer}ì´ˆ) ${problem.text}`;
            if (problem.explanation) {
                displayText += `  -  ì„¤ëª…: ${problem.explanation}`;
            }
            textDiv.innerText = displayText.length > 100 ? displayText.substring(0, 100) + 'â€¦' : displayText;

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerText = 'ì‚­ì œ';
            deleteBtn.onclick = () => deleteQuestionFromPool(problem.id);

            item.appendChild(textDiv);
            item.appendChild(deleteBtn);
            container.appendChild(item);
        });
    }

    function deleteQuestionFromPool(problemId) {
        if (!confirm('ì´ ë¬¸ì œë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
        database.ref(`quizGame/problemPool/${problemId}`).remove()
            .then(() => alert('âœ… ë¬¸ì œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'))
            .catch(error => alert('âŒ ë¬¸ì œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ' + error.message));
    }

    function deleteAllQuestions() {
        if (!confirm('âš ï¸ ë“±ë¡ëœ ëª¨ë“  ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        problemPoolRef.remove()
            .then(() => alert('âœ… ëª¨ë“  ë¬¸ì œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'))
            .catch(error => alert('âŒ ë¬¸ì œ ì „ì²´ ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ' + error.message));
    }

    // í•™ìƒ ëª…ë‹¨ UI
    function updateStudentListUI() {
        const container = document.getElementById('student-list-container');
        const countEl = document.getElementById('student-count');
        if (countEl) countEl.textContent = studentList.length;

        if (!container) return;

        container.innerHTML = '';
        if (studentList.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:gray;">í˜„ì¬ ì ‘ì†í•œ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        studentList.forEach(student => {
            const row = document.createElement('div');
            row.className = 'student-row';

            const infoSpan = document.createElement('span');
            infoSpan.textContent = `${student.emoji} ${student.nickname}  (â¤ï¸ ${student.lives} | ğŸ”¥ ${student.combo || 0})`;

            const delBtn = document.createElement('button');
            delBtn.className = 'delete-btn';
            delBtn.textContent = 'ì‚­ì œ';
            delBtn.onclick = () => removeStudent(student.id, student.nickname);

            row.appendChild(infoSpan);
            row.appendChild(delBtn);
            container.appendChild(row);
        });
    }

    function removeStudent(studentId, nickname) {
        if (!confirm(`'${nickname}' í•™ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        studentRef.child(studentId).remove()
            .catch(error => alert('âŒ í•™ìƒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ' + error.message));
    }

    function removeAllStudents() {
        if (!confirm('âš ï¸ ëª¨ë“  í•™ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        studentRef.remove()
            .catch(error => alert('âŒ í•™ìƒ ì „ì²´ ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ' + error.message));
    }

    async function startGameWithPool() {
        if (problemPool.length === 0) {
            alert('ğŸš¨ ìµœì†Œ 1ê°œ ì´ìƒì˜ ë¬¸ì œë¥¼ ì¤€ë¹„í•´ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }

        if (currentGameState.isActive && timerInterval) {
            clearInterval(timerInterval);
            await processResults(true);
        }

        const comboThreshold = parseInt(document.getElementById('combo-life-threshold').value) || 5;

        let initialHeartsVal = parseInt(document.getElementById('initial-hearts').value);
        if (isNaN(initialHeartsVal) || initialHeartsVal < 1) initialHeartsVal = 1;
        INITIAL_LIVES = initialHeartsVal;

        // ì´ì „ ê²Œì„ ê²°ê³¼ ê¸°ë¡ ì´ˆê¸°í™”
        await resultsRef.set(null);

        const firstProblem = problemPool[0];
        const newGameState = {
            questionIndex: 1,
            currentProblemKey: firstProblem.id,
            currentQuestion: {
                text: firstProblem.text,
                timer: firstProblem.timer,
                answer: firstProblem.answer,
                explanation: firstProblem.explanation || ''
            },
            isActive: true,
            showResult: false,
            answerTime: Date.now(),
            comboThreshold: comboThreshold,
            isGameStarted: true,
            initialHearts: initialHeartsVal
        };

        const studentUpdates = {};
        studentList.forEach(student => {
            if (student.lives > 0) {
                studentUpdates[student.id + '/answered'] = null;
            }
        });
        await studentRef.update(studentUpdates);

        await stateRef.set(newGameState);
        alert(`âœ… ê²Œì„ ì‹œì‘! ì´ ${problemPool.length}ë¬¸ì œ ì¤‘ 1ë²ˆ ë¬¸ì œë¥¼ ë°°í¬í–ˆìŠµë‹ˆë‹¤.`);
    }

    async function proceedToNextQuestion() {
        const nextIndex = currentGameState.questionIndex + 1;
        if (nextIndex > problemPool.length) {
            endGame(true);
            return;
        }

        const nextProblem = problemPool[nextIndex - 1];

        const studentUpdates = {};
        studentList.forEach(student => {
            if (student.lives > 0) {
                studentUpdates[student.id + '/answered'] = null;
            }
        });
        await studentRef.update(studentUpdates);

        await stateRef.update({
            questionIndex: nextIndex,
            currentProblemKey: nextProblem.id,
            currentQuestion: {
                text: nextProblem.text,
                timer: nextProblem.timer,
                answer: nextProblem.answer,
                explanation: nextProblem.explanation || ''
            },
            isActive: true,
            showResult: false,
            answerTime: Date.now()
        });

        lastResultQuestionIndex = 0;
    }

    // ----------------------------------------------------------------------
    // 6. Teacher View Logic
    // ----------------------------------------------------------------------
    function updateTeacherView() {
        const state = currentGameState;

        const prep = document.getElementById('teacher-preparation');
        const live = document.getElementById('teacher-live-quiz');

        if (state.isGameStarted && state.isActive) {
            prep.classList.add('hidden');
            live.classList.remove('hidden');

            document.getElementById('current-question').innerText =
                `[#${state.questionIndex}/${problemPool.length}] ${state.currentQuestion.text}`;

            const elapsedSec = Math.floor((Date.now() - state.answerTime) / 1000);
            const remaining = Math.max(0, state.currentQuestion.timer - elapsedSec);
            startTimer(remaining, 'teacher');

        } else if (state.isGameStarted && !state.isActive && state.questionIndex <= problemPool.length && state.questionIndex > 0) {
            prep.classList.add('hidden');
            live.classList.remove('hidden');

            if (!state.showResult) {
                if (state.questionIndex >= problemPool.length) {
                    endGame(true);
                } else {
                    document.getElementById('current-question').innerHTML =
                        `<span style="color:#fbc02d;">ë‹¤ìŒ ë¬¸ì œ ì¤€ë¹„ ì™„ë£Œ!</span><br>` +
                        `<button class="block-button green-button" onclick="proceedToNextQuestion()">â¡ï¸ ë‹¤ìŒ ë¬¸ì œ (#${state.questionIndex + 1})</button>`;
                }
            }

        } else {
            prep.classList.remove('hidden');
            live.classList.add('hidden');
        }
    }

    // ----------------------------------------------------------------------
    // 7. ê²°ê³¼ ê¸°ë¡ ì €ì¥ (ë¬¸ì œë³„)
    // ----------------------------------------------------------------------
    function saveQuestionResult(isForced) {
        if (!currentGameState.currentQuestion) return;

        const correctAnswer = currentGameState.currentQuestion.answer;
        const qIndex = currentGameState.questionIndex || 0;
        const qKey = currentGameState.currentProblemKey || `q${qIndex}`;

        const correctStudents = studentList
            .filter(s => s.answered === correctAnswer)
            .map(s => ({
                id: s.id,
                emoji: s.emoji,
                nickname: s.nickname
            }));

        const record = {
            key: qKey,
            index: qIndex,
            text: currentGameState.currentQuestion.text,
            answer: correctAnswer,
            explanation: currentGameState.currentQuestion.explanation || '',
            correctStudents
        };

        resultsRef.child(qKey).set(record).catch(err => console.error('ê²°ê³¼ ì €ì¥ ì˜¤ë¥˜:', err));
    }

    // ----------------------------------------------------------------------
    // 8. Core Game Logic (ê²°ê³¼ ì²˜ë¦¬ / ì¢…ë£Œ)
    // ----------------------------------------------------------------------
    async function processResults(isForced) {
        if (currentGameState.showResult || !currentGameState.isActive) return;

        clearInterval(timerInterval);

        const correctAnswer = currentGameState.currentQuestion.answer;
        const comboThreshold = currentGameState.comboThreshold;

        // ë¬¸ì œë³„ ê²°ê³¼ ê¸°ë¡
        saveQuestionResult(isForced);

        const studentUpdates = {};
        studentList.forEach(student => {
            if (student.lives > 0) {
                if (!isForced && student.answered === correctAnswer) {
                    student.combo = (student.combo || 0) + 1;
                    if (comboThreshold > 0 && student.combo % comboThreshold === 0) {
                        student.lives++;
                    }
                } else if (!isForced) {
                    student.lives--;
                    if (student.lives < 0) student.lives = 0;
                    student.combo = 0;
                }
                studentUpdates[`${student.id}/lives`] = student.lives;
                studentUpdates[`${student.id}/combo`] = student.combo || 0;
                studentUpdates[`${student.id}/answered`] = student.answered || null;
            }
        });

        await studentRef.update(studentUpdates);

        await stateRef.update({
            isActive: false,
            showResult: true
        });

        if (!isForced && currentGameState.questionIndex >= problemPool.length) {
            setTimeout(() => {
                endGame(true);
            }, 3000);
        }
    }

    function showResultScreen(isCorrect, isLifeGained, question) {
        const resultScreen = document.getElementById('result-screen');
        const resultEmoji = document.getElementById('result-emoji');
        const resultMessage = document.getElementById('result-message');

        const waiting = document.getElementById('student-waiting');
        const answering = document.getElementById('student-answering');
        const result = document.getElementById('student-result');

        waiting.classList.add('hidden');
        answering.classList.add('hidden');
        result.classList.remove('hidden');

        const explanationHtml = question.explanation
            ? `<br><div style="margin-top:10px;font-size:1rem;background:rgba(255,255,255,0.15);padding:8px 10px;border-radius:12px;">
                    ğŸ“˜ ì„¤ëª…: ${question.explanation}
               </div>`
            : '';

        if (isCorrect) {
            resultScreen.className = 'correct-result';
            resultEmoji.textContent = 'ğŸ‰';
            let msg = '<span style="font-size:1.4rem;">ì •ë‹µì´ì—ìš”! ë„ˆë¬´ ì˜í–ˆì–´ìš” ğŸ‘</span>';
            if (isLifeGained) {
                msg += '<br><span style="font-size:1.1rem;">â­ ì½¤ë³´ë¡œ í•˜íŠ¸ê°€ 1ê°œ ëŠ˜ì–´ë‚¬ì–´ìš”!</span>';
            }
            msg += explanationHtml;
            resultMessage.innerHTML = msg;
            playSound(523, 0.15);
            playSound(659, 0.15);
        } else {
            resultScreen.className = 'wrong-result';
            resultEmoji.textContent = 'ğŸ’¥';
            let msg =
                `<span style="font-size:1.4rem;">ì•„ì‰¬ì›Œìš”! ì •ë‹µì€ [${question.answer}] ì˜€ì–´ìš”.</span>`;
            msg += explanationHtml;
            resultMessage.innerHTML = msg;
            playSound(200, 0.25);
        }
    }

    function showFinalRankingScreen(alive) {
        hideAll();
        const view = document.getElementById('final-result-view');
        const container = document.getElementById('final-ranking-container');
        view.classList.remove('hidden');

        if (alive.length === 0) {
            container.innerHTML = `
                <p style="font-size:1.1rem; color:#546e7a; margin-bottom:12px;">
                    ğŸ˜¢ ì•„ì‰½ì§€ë§Œ ì´ë²ˆì—ëŠ” ìƒì¡´ìê°€ ì—†ìŠµë‹ˆë‹¤.
                </p>
                <p style="font-size:1rem; color:#607d8b;">
                    ë‹¤ìŒì—ëŠ” ëª¨ë‘ ê°™ì´ ëê¹Œì§€ ë„ì „í•´ ë³¼ê¹Œìš”?
                </p>
            `;
            return;
        }

        const medalEmojis = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
        const rankLabels = ['1ìœ„', '2ìœ„', '3ìœ„'];

        alive.sort((a, b) => (b.combo || 0) - (a.combo || 0));

        const uniqueCombos = [...new Set(alive.map(s => s.combo || 0))].sort((a, b) => b - a).slice(0, 3);

        const rankGroups = uniqueCombos.map((comboVal, idx) => {
            const students = alive.filter(s => (s.combo || 0) === comboVal);
            return {
                rank: idx + 1,
                medal: medalEmojis[idx],
                label: rankLabels[idx],
                combo: comboVal,
                students
            };
        });

        const mvpGroup = rankGroups[0];
        const mvpNames = mvpGroup.students
            .map(s => `${s.emoji} ${s.nickname}`)
            .join(', ');
        const bestCombo = mvpGroup.combo;

        let medalHtml = '';
        rankGroups.forEach(group => {
            group.students.forEach(s => {
                medalHtml += `
                    <div class="medal-row">
                        <div class="medal-left">
                            <div class="medal-rank">${group.medal}</div>
                            <div>
                                <div class="medal-name">${s.emoji} ${s.nickname}</div>
                                <div class="medal-stats">
                                    ${group.label} Â· â¤ï¸ ${s.lives} / ìµœëŒ€ ì½¤ë³´ ğŸ”¥ ${s.combo || 0}
                                </div>
                            </div>
                        </div>
                        <div>
                            ${group.rank === 1 ? 'MVP ğŸ–' : ''}
                        </div>
                    </div>
                `;
            });
        });

        const mvpHtml = `
            <div class="mvp-box">
                <div class="mvp-title">ì˜¤ëŠ˜ì˜ MVP</div>
                <div class="mvp-name">ğŸ† ${mvpNames}</div>
                <div style="margin-top:8px; font-size:0.95rem;">
                    ìµœëŒ€ ì½¤ë³´ ğŸ”¥ ${bestCombo} ê¸°ì¤€ìœ¼ë¡œ ê³µë™ MVPê°€ ë  ìˆ˜ ìˆì–´ìš”!
                </div>
            </div>
        `;

        let problemHtml = '';
        if (!resultsList || resultsList.length === 0) {
            problemHtml = `
                <p style="font-size:0.95rem; color:#607d8b; margin-top:4px;">
                    ì•„ì§ ê¸°ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.
                </p>
            `;
        } else {
            resultsList.forEach(r => {
                const correctNames =
                    r.correctStudents && r.correctStudents.length > 0
                        ? r.correctStudents.map(s => `${s.emoji} ${s.nickname}`).join(', ')
                        : 'ì •ë‹µì ì—†ìŒ';

                problemHtml += `
                    <div class="problem-block">
                        <div class="problem-q">Q${r.index}. ${r.text}</div>
                        <div class="problem-a">ì •ë‹µ: [${r.answer}]</div>
                        ${
                            r.explanation
                                ? `<div class="problem-expl">ğŸ“˜ ì„¤ëª…: ${r.explanation}</div>`
                                : ''
                        }
                        <div class="problem-correct">
                            ì •ë‹µì: ${correctNames}
                        </div>
                    </div>
                `;
            });
        }

        container.innerHTML = `
            <div class="result-tabs">
                <button class="result-tab-btn active" id="tab-btn-ranking" onclick="showResultTab('ranking')">ğŸ¥‡ 1~3ë“±</button>
                <button class="result-tab-btn" id="tab-btn-mvp" onclick="showResultTab('mvp')">ğŸ† MVP</button>
                <button class="result-tab-btn" id="tab-btn-problem" onclick="showResultTab('problem')">ğŸ“š ë¬¸ì œ ë³´ê¸°</button>
            </div>
            <div id="tab-ranking">
                <div class="medal-list">
                    ${medalHtml}
                </div>
            </div>
            <div id="tab-mvp" class="hidden">
                ${mvpHtml}
            </div>
            <div id="tab-problem" class="hidden">
                ${problemHtml}
            </div>
        `;
    }

    function showResultTab(tab) {
        const rankingTab = document.getElementById('tab-ranking');
        const mvpTab = document.getElementById('tab-mvp');
        const problemTab = document.getElementById('tab-problem');

        const rankingBtn = document.getElementById('tab-btn-ranking');
        const mvpBtn = document.getElementById('tab-btn-mvp');
        const problemBtn = document.getElementById('tab-btn-problem');
        if (!rankingTab || !mvpTab || !problemTab || !rankingBtn || !mvpBtn || !problemBtn) return;

        rankingTab.classList.add('hidden');
        mvpTab.classList.add('hidden');
        problemTab.classList.add('hidden');
        rankingBtn.classList.remove('active');
        mvpBtn.classList.remove('active');
        problemBtn.classList.remove('active');

        if (tab === 'ranking') {
            rankingTab.classList.remove('hidden');
            rankingBtn.classList.add('active');
        } else if (tab === 'mvp') {
            mvpTab.classList.remove('hidden');
            mvpBtn.classList.add('active');
        } else {
            problemTab.classList.remove('hidden');
            problemBtn.classList.add('active');
        }
    }

    function endGame(isAllCompleted) {
        if (!isAllCompleted && currentGameState.isActive) {
            processResults(true);
        }

        const alive = studentList
            .filter(s => s.lives > 0)
            .sort((a, b) => (b.combo || 0) - (a.combo || 0));

        stateRef.update({
            isActive: false,
            showResult: false,
            isGameStarted: false,
            questionIndex: 0
        });

        showFinalRankingScreen(alive);
    }

    async function resetStudentsToInitialLives() {
        const baseHearts = currentGameState.initialHearts || INITIAL_LIVES;
        const updates = {};
        studentList.forEach(s => {
            updates[`${s.id}/lives`] = baseHearts;
            updates[`${s.id}/combo`] = 0;
            updates[`${s.id}/answered`] = null;
        });
        if (Object.keys(updates).length > 0) {
            await studentRef.update(updates);
        }
    }

    async function backToTeacherFromResult() {
        await resetStudentsToInitialLives();
        showTeacherView();
    }

    // ----------------------------------------------------------------------
    // 9. Student Logic
    // ----------------------------------------------------------------------
    async function loginStudent() {
        const nicknameInput = document.getElementById('student-nickname');
        const emojiSelect = document.getElementById('emoji-select');

        const nickname = nicknameInput.value.trim();
        const emoji = emojiSelect.value;

        if (!nickname) {
            alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const newRef = studentRef.push();
        const newId = newRef.key;

        const baseHearts = currentGameState.initialHearts || INITIAL_LIVES;

        const studentData = {
            id: newId,
            nickname: nickname,
            emoji: emoji,
            lives: baseHearts,
            combo: 0,
            answered: null
        };

        await newRef.set(studentData);
        currentUser = studentData;
        lastUserLives = baseHearts;
        lastUserCombo = 0;

        const infoEl = document.getElementById('student-info');
        if (infoEl) {
            infoEl.innerText = `${emoji} ${nickname} ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`;
        }
        document.getElementById('student-lives').innerText = `â¤ï¸ í•˜íŠ¸: ${baseHearts}`;

        showStudentView();
    }

    function updateStudentStateFromDB() {
        if (!currentUser) return;
        const state = currentGameState;

        const waiting = document.getElementById('student-waiting');
        const answering = document.getElementById('student-answering');
        const result = document.getElementById('student-result');

        // 1) ê²Œì„ ì‹œì‘ ì „
        if (!state.isGameStarted || !state.questionIndex || state.questionIndex === 0) {
            waiting.classList.remove('hidden');
            answering.classList.add('hidden');
            result.classList.add('hidden');
            return;
        }

        // 2) ë¬¸ì œ ì§„í–‰ ì¤‘
        if (state.isActive) {
            waiting.classList.add('hidden');
            result.classList.add('hidden');
            answering.classList.remove('hidden');

            const qText = document.getElementById('question-text');
            if (qText && state.currentQuestion) {
                qText.innerText = state.currentQuestion.text;
            }

            const elapsedSec = Math.floor((Date.now() - state.answerTime) / 1000);
            const remaining = Math.max(0, state.currentQuestion.timer - elapsedSec);
            startTimer(remaining, 'student');
            return;
        }

        // 3) ê²°ê³¼(showResult) ìƒíƒœ: ì •ë‹µ+ì„¤ëª… í™”ë©´ ìœ ì§€
        if (state.showResult) {
            if (state.questionIndex !== lastResultQuestionIndex) {
                const isCorrect = (currentUser.answered === state.currentQuestion.answer && currentUser.lives > 0);
                const isLifeGained = (lastUserLives != null && currentUser.lives > lastUserLives);
                showResultScreen(isCorrect, isLifeGained, state.currentQuestion);
                lastResultQuestionIndex = state.questionIndex;
            } else {
                waiting.classList.add('hidden');
                answering.classList.add('hidden');
                result.classList.remove('hidden');
            }
            return;
        }

        // 4) ê·¸ ì™¸
        if (state.questionIndex > 0 && lastResultQuestionIndex === state.questionIndex) {
            waiting.classList.add('hidden');
            answering.classList.add('hidden');
            result.classList.remove('hidden');
        } else {
            waiting.classList.remove('hidden');
            answering.classList.add('hidden');
            result.classList.add('hidden');
        }
    }

    function submitAnswer(answer) {
        if (!currentUser) return;
        if (!currentGameState.isActive || !currentGameState.isGameStarted) {
            alert('ì§€ê¸ˆì€ ë‹µì„ ì œì¶œí•  ìˆ˜ ìˆëŠ” ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.');
            return;
        }
        if (currentUser.lives <= 0) {
            alert('ì´ë¯¸ íƒˆë½í–ˆì–´ìš”. ì´ì œëŠ” ê´€ì „ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            return;
        }

        studentRef.child(currentUser.id).update({ answered: answer })
            .then(() => {
                playSound(440, 0.1);
            })
            .catch(err => console.error(err));
    }

    function updateComboDisplay() {
        const el = document.getElementById('combo-indicator');
        const countEl = document.getElementById('combo-count');
        if (!currentUser || !currentUser.combo || currentUser.combo <= 1) {
            el.classList.add('hidden');
            return;
        }
        countEl.innerText = currentUser.combo;
        el.classList.remove('hidden');
    }

    // ----------------------------------------------------------------------
    // 10. Avatar Animation & Quiz Area
    // ----------------------------------------------------------------------
    function createOrGetAvatarElement(student) {
        let avatar = document.querySelector(`.student-avatar[data-student-id="${student.id}"][data-area="teacher"]`);
        if (!avatar) {
            avatar = document.createElement('div');
            avatar.className = 'student-avatar';
            avatar.dataset.studentId = student.id;
            avatar.dataset.area = 'teacher';
        }
        avatar.textContent = `${student.emoji} ${student.nickname}`;
        return avatar;
    }

    function createOrGetAvatarElementSpectator(student) {
        let avatar = document.querySelector(`.student-avatar[data-student-id="${student.id}"][data-area="spectator"]`);
        if (!avatar) {
            avatar = document.createElement('div');
            avatar.className = 'student-avatar';
            avatar.dataset.studentId = student.id;
            avatar.dataset.area = 'spectator';
        }
        avatar.textContent = `${student.emoji} ${student.nickname}`;
        return avatar;
    }

    function moveAvatarWithAnimation(student, targetContainer, newZone) {
        const avatar = createOrGetAvatarElement(student);
        const currentParent = avatar.parentElement;

        if (!currentParent || lastZoneMap[student.id] === undefined || lastZoneMap[student.id] === newZone) {
            targetContainer.appendChild(avatar);
            lastZoneMap[student.id] = newZone;
            return;
        }

        const startRect = avatar.getBoundingClientRect();
        const startX = startRect.left + startRect.width / 2;
        the_startY = startRect.top + startRect.height / 2;

        const targetRect = targetContainer.getBoundingClientRect();
        const endX = newZone === 'O'
            ? targetRect.left + targetRect.width * 0.35
            : newZone === 'X'
                ? targetRect.left + targetRect.width * 0.65
                : targetRect.left + targetRect.width / 2;
        const endY = targetRect.top + targetRect.height * 0.3;

        const flying = avatar.cloneNode(true);
        flying.style.position = 'fixed';
        flying.style.left = (startX - startRect.width / 2) + 'px';
        flying.style.top = (startY - startRect.height / 2) + 'px';
        flying.style.margin = '0';
        flying.style.zIndex = 9999;
        flying.style.pointerEvents = 'none';
        flying.style.transition = 'transform 0.7s cubic-bezier(0.68,-0.55,0.27,1.55)';
        flying.classList.add('flying-avatar');
        document.body.appendChild(flying);

        avatar.style.visibility = 'hidden';

        const deltaX = endX - startX;
        const deltaY = endY - startY;

        requestAnimationFrame(() => {
            flying.style.transform = `translate(${deltaX}px, ${deltaY - 20}px) scale(1.1)`;
        });

        flying.addEventListener('transitionend', () => {
            targetContainer.appendChild(avatar);
            avatar.style.visibility = 'visible';
            document.body.removeChild(flying);
        });

        lastZoneMap[student.id] = newZone;
    }

    function moveAvatarWithAnimationSpectator(student, targetContainer, newZone) {
        const avatar = createOrGetAvatarElementSpectator(student);
        const currentParent = avatar.parentElement;

        if (!currentParent || lastZoneMapSpectator[student.id] === undefined || lastZoneMapSpectator[student.id] === newZone) {
            targetContainer.appendChild(avatar);
            lastZoneMapSpectator[student.id] = newZone;
            return;
        }

        const startRect = avatar.getBoundingClientRect();
        const startX = startRect.left + startRect.width / 2;
        const startY = startRect.top + startRect.height / 2;

        const targetRect = targetContainer.getBoundingClientRect();
        const endX = newZone === 'O'
            ? targetRect.left + targetRect.width * 0.35
            : newZone === 'X'
                ? targetRect.left + targetRect.width * 0.65
                : targetRect.left + targetRect.width / 2;
        const endY = targetRect.top + targetRect.height * 0.3;

        const flying = avatar.cloneNode(true);
        flying.style.position = 'fixed';
        flying.style.left = (startX - startRect.width / 2) + 'px';
        flying.style.top = (startY - startRect.height / 2) + 'px';
        flying.style.margin = '0';
        flying.style.zIndex = 9999;
        flying.style.pointerEvents = 'none';
        flying.style.transition = 'transform 0.7s cubic-bezier(0.68,-0.55,0.27,1.55)';
        flying.classList.add('flying-avatar');
        document.body.appendChild(flying);

        avatar.style.visibility = 'hidden';

        const deltaX = endX - startX;
        const deltaY = endY - startY;

        requestAnimationFrame(() => {
            flying.style.transform = `translate(${deltaX}px, ${deltaY - 20}px) scale(1.1)`;
        });

        flying.addEventListener('transitionend', () => {
            targetContainer.appendChild(avatar);
            avatar.style.visibility = 'visible';
            document.body.removeChild(flying);
        });

        lastZoneMapSpectator[student.id] = newZone;
    }

    function updateQuizAreaViews() {
        const unanswered = document.getElementById('unanswered-area');
        const oArea = document.getElementById('o-answers');
        const xArea = document.getElementById('x-answers');

        const unansweredSpec = document.getElementById('unanswered-area-spectator');
        const oSpec = document.getElementById('o-answers-spectator');
        const xSpec = document.getElementById('x-answers-spectator');

        if (!unanswered || !oArea || !xArea || !unansweredSpec || !oSpec || !xSpec) return;

        const aliveIds = new Set(
            studentList.filter(s => s.lives > 0).map(s => s.id)
        );

        Object.keys(lastZoneMap).forEach(id => {
            if (!aliveIds.has(id)) delete lastZoneMap[id];
        });
        Object.keys(lastZoneMapSpectator).forEach(id => {
            if (!aliveIds.has(id)) delete lastZoneMapSpectator[id];
        });

        [unanswered, oArea, xArea, unansweredSpec, oSpec, xSpec].forEach(container => {
            Array.from(container.querySelectorAll('.student-avatar')).forEach(av => {
                const sid = av.dataset.studentId;
                if (sid && !aliveIds.has(sid)) {
                    container.removeChild(av);
                }
            });
        });

        let oCount = 0;
        let xCount = 0;

        studentList.forEach(student => {
            if (student.lives <= 0) return;

            let zone = 'out';
            if (student.answered === 'O') {
                zone = 'O';
                oCount++;
            } else if (student.answered === 'X') {
                zone = 'X';
                xCount++;
            }

            let targetTeacher = unanswered;
            if (zone === 'O') targetTeacher = oArea;
            else if (zone === 'X') targetTeacher = xArea;
            moveAvatarWithAnimation(student, targetTeacher, zone);

            let targetSpec = unansweredSpec;
            if (zone === 'O') targetSpec = oSpec;
            else if (zone === 'X') targetSpec = xSpec;
            moveAvatarWithAnimationSpectator(student, targetSpec, zone);
        });

        const oCountEl = document.getElementById('o-count');
        const xCountEl = document.getElementById('x-count');
        if (oCountEl) oCountEl.innerText = oCount;
        if (xCountEl) xCountEl.innerText = xCount;
        document.querySelectorAll('.o-count-spectator').forEach(el => el.innerText = oCount);
        document.querySelectorAll('.x-count-spectator').forEach(el => el.innerText = xCount);
    }

    // ----------------------------------------------------------------------
    // 11. Timer
    // ----------------------------------------------------------------------
    function startTimer(seconds, role) {
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        let remaining = seconds;

        function updateDisplay() {
            if (role === 'teacher') {
                const tv = document.getElementById('timer-value');
                if (tv) tv.innerText = remaining;
            } else if (role === 'student') {
                const tv = document.getElementById('student-timer-value');
                if (tv) tv.innerText = remaining;
            }
        }

        updateDisplay();

        timerInterval = setInterval(() => {
            remaining--;
            if (remaining < 0) {
                clearInterval(timerInterval);
                timerInterval = null;
                if (role === 'teacher' && currentGameState.isActive) {
                    processResults(false);
                }
                return;
            }
            updateDisplay();
        }, 1000);
    }
</script>

</body>
</html>















